<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; Knowledge Graph Construction – Knowledge Graphs: Foundations, Applications, and Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../contents/construction/kg-algorithms.html" rel="next">
<link href="../../contents/foundation/knowledge-representation.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-4379b0ccadffce622b03caf4c46266b3.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-bdec3157979715d7154bb60f5aa24e58.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-4104e206323135730aa08c3113d84ebc.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../contents/construction/kg-construction.html">Construction and processing</a></li><li class="breadcrumb-item"><a href="../../contents/construction/kg-construction.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Knowledge Graph Construction</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Knowledge Graphs: Foundations, Applications, and Analysis</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/foundation/outline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Outline</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/foundation/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to knowledge graphs and network science</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/foundation/math-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Mathematical fundamentals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/foundation/graph-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Graph Theory Fundamentals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/foundation/knowledge-representation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Knowledge Representation and Ontologies</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Construction and processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/construction/kg-construction.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Knowledge Graph Construction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/construction/kg-algorithms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Graph Algorithms and Traversal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/construction/stat-analysis-of-kg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Statistical Analysis of Knowledge Graphs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contents/construction/ml-on-kg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Machine Learning on Knowledge Graphs</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#knowledge-graph-construction-lifecycle" id="toc-knowledge-graph-construction-lifecycle" class="nav-link active" data-scroll-target="#knowledge-graph-construction-lifecycle"><span class="header-section-number">6.1</span> Knowledge graph construction lifecycle</a>
  <ul class="collapse">
  <li><a href="#overview-of-construction-approaches" id="toc-overview-of-construction-approaches" class="nav-link" data-scroll-target="#overview-of-construction-approaches"><span class="header-section-number">6.1.1</span> Overview of construction approaches</a></li>
  <li><a href="#construction-lifecycle-phases" id="toc-construction-lifecycle-phases" class="nav-link" data-scroll-target="#construction-lifecycle-phases"><span class="header-section-number">6.1.2</span> Construction lifecycle phases</a></li>
  <li><a href="#construction-strategies-and-architectures" id="toc-construction-strategies-and-architectures" class="nav-link" data-scroll-target="#construction-strategies-and-architectures"><span class="header-section-number">6.1.3</span> Construction strategies and architectures</a></li>
  </ul></li>
  <li><a href="#data-sources-for-knowledge-graphs" id="toc-data-sources-for-knowledge-graphs" class="nav-link" data-scroll-target="#data-sources-for-knowledge-graphs"><span class="header-section-number">6.2</span> Data sources for knowledge graphs</a>
  <ul class="collapse">
  <li><a href="#structured-data-sources" id="toc-structured-data-sources" class="nav-link" data-scroll-target="#structured-data-sources"><span class="header-section-number">6.2.1</span> Structured data sources</a></li>
  <li><a href="#semi-structured-data-sources" id="toc-semi-structured-data-sources" class="nav-link" data-scroll-target="#semi-structured-data-sources"><span class="header-section-number">6.2.2</span> Semi-structured data sources</a></li>
  <li><a href="#unstructured-data-sources" id="toc-unstructured-data-sources" class="nav-link" data-scroll-target="#unstructured-data-sources"><span class="header-section-number">6.2.3</span> Unstructured data sources</a></li>
  <li><a href="#combining-multiple-source-types" id="toc-combining-multiple-source-types" class="nav-link" data-scroll-target="#combining-multiple-source-types"><span class="header-section-number">6.2.4</span> Combining multiple source types</a></li>
  </ul></li>
  <li><a href="#information-extraction-techniques" id="toc-information-extraction-techniques" class="nav-link" data-scroll-target="#information-extraction-techniques"><span class="header-section-number">6.3</span> Information extraction techniques</a>
  <ul class="collapse">
  <li><a href="#named-entity-recognition" id="toc-named-entity-recognition" class="nav-link" data-scroll-target="#named-entity-recognition"><span class="header-section-number">6.3.1</span> Named entity recognition</a></li>
  <li><a href="#relationship-extraction" id="toc-relationship-extraction" class="nav-link" data-scroll-target="#relationship-extraction"><span class="header-section-number">6.3.2</span> Relationship extraction</a></li>
  <li><a href="#attribute-extraction" id="toc-attribute-extraction" class="nav-link" data-scroll-target="#attribute-extraction"><span class="header-section-number">6.3.3</span> Attribute extraction</a></li>
  <li><a href="#event-extraction" id="toc-event-extraction" class="nav-link" data-scroll-target="#event-extraction"><span class="header-section-number">6.3.4</span> Event extraction</a></li>
  <li><a href="#domain-specific-extraction-techniques" id="toc-domain-specific-extraction-techniques" class="nav-link" data-scroll-target="#domain-specific-extraction-techniques"><span class="header-section-number">6.3.5</span> Domain-specific extraction techniques</a></li>
  </ul></li>
  <li><a href="#entity-resolution-and-linking" id="toc-entity-resolution-and-linking" class="nav-link" data-scroll-target="#entity-resolution-and-linking"><span class="header-section-number">6.4</span> Entity resolution and linking</a>
  <ul class="collapse">
  <li><a href="#entity-coreference-resolution" id="toc-entity-coreference-resolution" class="nav-link" data-scroll-target="#entity-coreference-resolution"><span class="header-section-number">6.4.1</span> Entity coreference resolution</a></li>
  <li><a href="#entity-linking-to-knowledge-bases" id="toc-entity-linking-to-knowledge-bases" class="nav-link" data-scroll-target="#entity-linking-to-knowledge-bases"><span class="header-section-number">6.4.2</span> Entity linking to knowledge bases</a></li>
  <li><a href="#cross-source-entity-resolution" id="toc-cross-source-entity-resolution" class="nav-link" data-scroll-target="#cross-source-entity-resolution"><span class="header-section-number">6.4.3</span> Cross-source entity resolution</a></li>
  <li><a href="#identity-management-and-entity-reconciliation" id="toc-identity-management-and-entity-reconciliation" class="nav-link" data-scroll-target="#identity-management-and-entity-reconciliation"><span class="header-section-number">6.4.4</span> Identity management and entity reconciliation</a></li>
  </ul></li>
  <li><a href="#knowledge-graph-integration-and-fusion" id="toc-knowledge-graph-integration-and-fusion" class="nav-link" data-scroll-target="#knowledge-graph-integration-and-fusion"><span class="header-section-number">6.5</span> Knowledge graph integration and fusion</a>
  <ul class="collapse">
  <li><a href="#schema-alignment-and-mapping" id="toc-schema-alignment-and-mapping" class="nav-link" data-scroll-target="#schema-alignment-and-mapping"><span class="header-section-number">6.5.1</span> Schema alignment and mapping</a></li>
  <li><a href="#knowledge-fusion-strategies" id="toc-knowledge-fusion-strategies" class="nav-link" data-scroll-target="#knowledge-fusion-strategies"><span class="header-section-number">6.5.2</span> Knowledge fusion strategies</a></li>
  <li><a href="#ontology-based-integration" id="toc-ontology-based-integration" class="nav-link" data-scroll-target="#ontology-based-integration"><span class="header-section-number">6.5.3</span> Ontology-based integration</a></li>
  </ul></li>
  <li><a href="#quality-assessment-and-enrichment" id="toc-quality-assessment-and-enrichment" class="nav-link" data-scroll-target="#quality-assessment-and-enrichment"><span class="header-section-number">6.6</span> Quality assessment and enrichment</a>
  <ul class="collapse">
  <li><a href="#knowledge-graph-quality-dimensions" id="toc-knowledge-graph-quality-dimensions" class="nav-link" data-scroll-target="#knowledge-graph-quality-dimensions"><span class="header-section-number">6.6.1</span> Knowledge graph quality dimensions</a></li>
  <li><a href="#knowledge-graph-completion" id="toc-knowledge-graph-completion" class="nav-link" data-scroll-target="#knowledge-graph-completion"><span class="header-section-number">6.6.2</span> Knowledge graph completion</a></li>
  <li><a href="#context-and-provenance-enrichment" id="toc-context-and-provenance-enrichment" class="nav-link" data-scroll-target="#context-and-provenance-enrichment"><span class="header-section-number">6.6.3</span> Context and provenance enrichment</a></li>
  <li><a href="#semantic-enrichment-and-alignment" id="toc-semantic-enrichment-and-alignment" class="nav-link" data-scroll-target="#semantic-enrichment-and-alignment"><span class="header-section-number">6.6.4</span> Semantic enrichment and alignment</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">6.7</span> Summary</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">6.8</span> Exercises</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">6.9</span> Further reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../contents/construction/kg-construction.html">Construction and processing</a></li><li class="breadcrumb-item"><a href="../../contents/construction/kg-construction.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Knowledge Graph Construction</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Knowledge Graph Construction</span></h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<p>This chapter explores the process of constructing knowledge graphs from various data sources. We’ll examine approaches for extracting entities and relationships, integrating heterogeneous information, and ensuring the quality and coherence of the resulting knowledge graph.</p>
<section id="knowledge-graph-construction-lifecycle" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="knowledge-graph-construction-lifecycle"><span class="header-section-number">6.1</span> Knowledge graph construction lifecycle</h2>
<p>Knowledge graph construction involves a systematic process of extracting, transforming, and integrating knowledge from diverse sources into a coherent graph-structured representation.</p>
<section id="overview-of-construction-approaches" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="overview-of-construction-approaches"><span class="header-section-number">6.1.1</span> Overview of construction approaches</h3>
<div id="def-kg-construction" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.1 (Knowledge graph construction)</strong></span> <strong>Knowledge graph construction</strong> is the process of creating a knowledge graph by:</p>
<ol type="1">
<li>Extracting entities, relationships, and attributes from various data sources</li>
<li>Aligning and integrating the extracted elements into a unified schema</li>
<li>Ensuring consistency, quality, and coherence of the resulting graph</li>
</ol>
<p>Construction approaches can be categorized as:</p>
<ol type="1">
<li><strong>Top-down</strong>: Starting with an ontology/schema and populating it with instances</li>
<li><strong>Bottom-up</strong>: Extracting knowledge first and then organizing it into a schema</li>
<li><strong>Hybrid</strong>: Combining elements of both approaches</li>
</ol>
</div>
<div id="exm-construction-approaches" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.1 (Knowledge graph construction approaches)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Top-down approach</strong>:</p>
<ul>
<li>Create an ontology defining classes (Person, Organization, Location) and relationships (employedBy, locatedIn)</li>
<li>Define mapping rules from source data to ontology concepts</li>
<li>Extract and transform data according to these mappings</li>
<li>Example: Building an enterprise knowledge graph with a predefined schema based on organizational data models</li>
</ul></li>
<li><p><strong>Bottom-up approach</strong>:</p>
<ul>
<li>Extract entities and relationships from text, databases, or other sources</li>
<li>Cluster similar entities and relationships</li>
<li>Induce a schema or ontology from the patterns in the data</li>
<li>Example: Creating an open-domain knowledge graph from web text without a predefined schema</li>
</ul></li>
<li><p><strong>Hybrid approach</strong>:</p>
<ul>
<li>Start with a lightweight core schema defining basic types and relations</li>
<li>Extract entities and relationships, mapping to schema where possible</li>
<li>Extend schema based on discovered patterns</li>
<li>Iteratively refine both schema and instance data</li>
<li>Example: Building a scientific knowledge graph with a core schema of established concepts, but allowing for expansion as new research areas emerge</li>
</ul></li>
</ol>
</div>
<p>The choice of approach depends on factors such as:</p>
<ul>
<li>Availability of existing schemas or ontologies</li>
<li>Nature and structure of source data</li>
<li>Requirements for flexibility versus consistency</li>
<li>Domain expertise and resources available</li>
</ul>
</section>
<section id="construction-lifecycle-phases" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="construction-lifecycle-phases"><span class="header-section-number">6.1.2</span> Construction lifecycle phases</h3>
<p>The knowledge graph construction process typically follows a lifecycle with distinct phases:</p>
<div id="def-kg-lifecycle" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.2 (Knowledge graph construction lifecycle)</strong></span> The <strong>knowledge graph construction lifecycle</strong> typically includes the following phases:</p>
<ol type="1">
<li><strong>Planning and design</strong>: Defining scope, requirements, and conceptual model</li>
<li><strong>Schema development</strong>: Creating or selecting ontologies and schemas</li>
<li><strong>Data acquisition</strong>: Gathering relevant source data</li>
<li><strong>Information extraction</strong>: Identifying entities, relationships, and attributes</li>
<li><strong>Integration and fusion</strong>: Combining and reconciling information from multiple sources</li>
<li><strong>Quality assessment</strong>: Evaluating and improving the knowledge graph</li>
<li><strong>Enrichment</strong>: Adding additional knowledge through inference or external sources</li>
<li><strong>Deployment and maintenance</strong>: Making the knowledge graph available and keeping it updated</li>
</ol>
</div>
<div id="exm-kg-lifecycle" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.2 (Knowledge graph construction lifecycle example)</strong></span> <strong>Project</strong>: Building a biomedical knowledge graph for drug discovery</p>
<ol type="1">
<li><p><strong>Planning and design</strong>:</p>
<ul>
<li>Define scope: Focus on diseases, drugs, targets, and biological pathways</li>
<li>Identify requirements: Support for finding potential drug repurposing opportunities</li>
<li>Create conceptual model: Entity types, relationship types, and their connections</li>
</ul></li>
<li><p><strong>Schema development</strong>:</p>
<ul>
<li>Adopt existing ontologies: Disease Ontology, ChEBI (for chemicals), Gene Ontology</li>
<li>Develop custom extensions for project-specific concepts</li>
<li>Define mappings between different ontologies</li>
</ul></li>
<li><p><strong>Data acquisition</strong>:</p>
<ul>
<li>Identify sources: PubMed (literature), DrugBank (drugs), KEGG (pathways)</li>
<li>Establish access methods: APIs, downloads, web scraping</li>
<li>Set up preprocessing pipelines for each source</li>
</ul></li>
<li><p><strong>Information extraction</strong>:</p>
<ul>
<li>Extract drug-disease relationships from literature using NLP</li>
<li>Parse structured databases to extract drug-target interactions</li>
<li>Identify gene-pathway relationships from pathway databases</li>
</ul></li>
<li><p><strong>Integration and fusion</strong>:</p>
<ul>
<li>Resolve entity references across sources (entity resolution)</li>
<li>Reconcile conflicting information about relationships</li>
<li>Harmonize relationship types from different sources</li>
</ul></li>
<li><p><strong>Quality assessment</strong>:</p>
<ul>
<li>Verify extracted relationships against gold standard datasets</li>
<li>Calculate precision, recall, and coverage metrics</li>
<li>Identify and address systematic errors</li>
</ul></li>
<li><p><strong>Enrichment</strong>:</p>
<ul>
<li>Infer new drug-disease relationships based on shared mechanisms</li>
<li>Add confidence scores to relationships based on evidence strength</li>
<li>Link to external resources for additional context</li>
</ul></li>
<li><p><strong>Deployment and maintenance</strong>:</p>
<ul>
<li>Deploy as a queryable graph database with API access</li>
<li>Establish update schedule for incorporating new publications</li>
<li>Monitor usage patterns to guide further development</li>
</ul></li>
</ol>
</div>
<p>These phases often occur iteratively rather than strictly sequentially, with feedback from later phases informing refinements to earlier phases. For example, quality assessment might reveal the need for additional information extraction techniques, or deployment experiences might suggest schema modifications.</p>
</section>
<section id="construction-strategies-and-architectures" class="level3" data-number="6.1.3">
<h3 data-number="6.1.3" class="anchored" data-anchor-id="construction-strategies-and-architectures"><span class="header-section-number">6.1.3</span> Construction strategies and architectures</h3>
<p>Various architectural approaches can be used to implement knowledge graph construction:</p>
<div id="def-kg-architectures" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.3 (Knowledge graph construction architectures)</strong></span> <strong>Knowledge graph construction architectures</strong> define the systems, components, and data flows for building and maintaining knowledge graphs:</p>
<ol type="1">
<li><strong>Batch processing architecture</strong>: Processing large volumes of source data in scheduled batches</li>
<li><strong>Streaming architecture</strong>: Continuously processing incoming data in near real-time</li>
<li><strong>Hybrid architecture</strong>: Combining batch processing for historical data with streaming for updates</li>
<li><strong>Federated architecture</strong>: Leaving data in source systems and constructing a virtual knowledge graph via query translation</li>
</ol>
</div>
<div id="exm-kg-architectures" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.3 (Knowledge graph construction architectures)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Batch processing architecture</strong>:</p>
<ul>
<li>Components: Data lake storage, extraction workflows, transformation jobs, graph database loader</li>
<li>Process: Weekly full extraction from sources → parallel processing pipelines → quality checks → database update</li>
<li>Tools: Apache Hadoop, Spark, orchestration with Airflow</li>
<li>Example use case: Academic knowledge graph updated quarterly with new publications</li>
</ul></li>
<li><p><strong>Streaming architecture</strong>:</p>
<ul>
<li>Components: Message brokers, stream processors, incremental extractors, graph database with transactional updates</li>
<li>Process: Continuous ingestion of events → real-time entity extraction → immediate graph updates</li>
<li>Tools: Kafka, Flink, streaming NLP services</li>
<li>Example use case: Financial knowledge graph reflecting market changes in near real-time</li>
</ul></li>
<li><p><strong>Hybrid architecture</strong>:</p>
<ul>
<li>Components: Batch pipeline for historical data, streaming pipeline for updates, reconciliation mechanisms</li>
<li>Process: Initial bulk load via batch processes → continuous updates via streaming → periodic reprocessing of historical data</li>
<li>Tools: Combined Spark (batch) and Kafka/Flink (streaming) infrastructure</li>
<li>Example use case: E-commerce knowledge graph with historical catalog data and real-time inventory updates</li>
</ul></li>
<li><p><strong>Federated architecture</strong>:</p>
<ul>
<li>Components: Source connectors, query federation engine, schema mapping layer, caching mechanisms</li>
<li>Process: Query received → decomposed into source-specific queries → results fetched and integrated on-the-fly</li>
<li>Tools: Query federation platforms, API gateways, virtualization middleware</li>
<li>Example use case: Healthcare knowledge graph integrating multiple clinical systems without centralizing sensitive patient data</li>
</ul></li>
</ol>
</div>
<p>The choice of architecture depends on factors such as:</p>
<ul>
<li>Update frequency requirements</li>
<li>Volume and velocity of source data</li>
<li>Latency requirements for access</li>
<li>Integration complexity</li>
<li>Data privacy and governance considerations</li>
</ul>
</section>
</section>
<section id="data-sources-for-knowledge-graphs" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="data-sources-for-knowledge-graphs"><span class="header-section-number">6.2</span> Data sources for knowledge graphs</h2>
<p>Knowledge graphs can be constructed from a wide variety of data sources, each requiring different extraction and integration approaches.</p>
<section id="structured-data-sources" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="structured-data-sources"><span class="header-section-number">6.2.1</span> Structured data sources</h3>
<p>Structured data sources provide information in well-defined formats with explicit schemas:</p>
<div id="def-structured-sources" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.4 (Structured data sources)</strong></span> <strong>Structured data sources</strong> contain information organized according to a predefined data model. Key types include:</p>
<ol type="1">
<li><strong>Relational databases</strong>: Data organized in tables with relationships defined by keys</li>
<li><strong>XML/JSON documents</strong>: Hierarchically structured data with defined schemas</li>
<li><strong>RDF stores</strong>: Graph data already expressed in subject-predicate-object triples</li>
<li><strong>CSV/tabular data</strong>: Data organized in rows and columns with defined semantics</li>
<li><strong>APIs with structured responses</strong>: Web services returning data in structured formats</li>
</ol>
</div>
<div id="exm-structured-sources" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.4 (Structured data integration examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Relational database integration</strong>:</p>
<ul>
<li><p>Example: Converting a customer database to a knowledge graph</p></li>
<li><p>Approach:</p>
<ul>
<li>Tables → entity classes (Customers, Products, Orders)</li>
<li>Rows → entity instances</li>
<li>Foreign keys → relationships</li>
<li>Columns → attributes</li>
</ul></li>
<li><p>Mapping example:</p>
<pre><code>CREATE MAPPING CompanyMap FOR Customer {
  uri: template("company/{id}");
  types: ["ex:Company"];
  properties: [
    property(rdfs:label, name),
    property(ex:foundedIn, founded_year),
    link(ex:hasIndustry, industry_code, "industry/{value}")
  ]
}</code></pre></li>
</ul></li>
<li><p><strong>XML integration</strong>:</p>
<ul>
<li><p>Example: Converting product catalog XML to a knowledge graph</p></li>
<li><p>Approach:</p>
<ul>
<li>XML elements → entities or attributes</li>
<li>Element hierarchies → relationships</li>
<li>XML attributes → entity attributes</li>
</ul></li>
<li><p>XSLT transformation example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">xsl:template</span><span class="ot"> match=</span><span class="st">"product"</span>&gt;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">xsl:variable</span><span class="ot"> name=</span><span class="st">"productURI"</span><span class="ot"> select=</span><span class="st">"concat('product/', @id)"</span>/&gt;</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Create product entity --&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">ex:Product</span><span class="ot"> rdf:about=</span><span class="st">"{$productURI}"</span>&gt;</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">rdfs:label</span>&gt;&lt;<span class="kw">xsl:value-of</span><span class="ot"> select=</span><span class="st">"name"</span>/&gt;&lt;/<span class="kw">rdfs:label</span>&gt;</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ex:price</span>&gt;&lt;<span class="kw">xsl:value-of</span><span class="ot"> select=</span><span class="st">"price"</span>/&gt;&lt;/<span class="kw">ex:price</span>&gt;</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Create relationship to category --&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ex:hasCategory</span><span class="ot"> rdf:resource=</span><span class="st">"{concat('category/', category/@id)}"</span>/&gt;</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">ex:Product</span>&gt;</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">xsl:template</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><strong>API integration</strong>:</p>
<ul>
<li><p>Example: Converting GitHub API responses to a knowledge graph</p></li>
<li><p>Approach:</p>
<ul>
<li>API endpoints → entity types (repositories, users, issues)</li>
<li>JSON objects → entity instances</li>
<li>Object references → relationships</li>
<li>Fields → attributes</li>
</ul></li>
<li><p>GraphQL query example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  repository(owner: <span class="st">"tensorflow"</span>, name: <span class="st">"tensorflow"</span>) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    description</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    stargazerCount</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    pullRequests(first: <span class="dv">10</span>, states: OPEN) {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      nodes {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        title</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        author {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>          login</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Results mapped to knowledge graph entities and relationships</p></li>
</ul></li>
</ol>
</div>
<p>Integration challenges for structured data include:</p>
<ol type="1">
<li><strong>Schema heterogeneity</strong>: Differences in how similar concepts are modeled across sources</li>
<li><strong>Semantic mismatches</strong>: Different interpretations of the same terms</li>
<li><strong>Entity resolution</strong>: Identifying when records from different sources refer to the same entity</li>
<li><strong>Data quality issues</strong>: Inconsistent formats, missing values, or contradictory information</li>
</ol>
</section>
<section id="semi-structured-data-sources" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="semi-structured-data-sources"><span class="header-section-number">6.2.2</span> Semi-structured data sources</h3>
<p>Semi-structured data sources lack rigid schemas but contain implicit structure:</p>
<div id="def-semi-structured" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.5 (Semi-structured data sources)</strong></span> <strong>Semi-structured data sources</strong> contain information with some organizational patterns but without a rigid, predefined schema. Key types include:</p>
<ol type="1">
<li><strong>HTML web pages</strong>: Content organized using HTML tags and DOM structure</li>
<li><strong>Wikis and collaborative platforms</strong>: Content with lightweight markup and templates</li>
<li><strong>JSON/XML without strict schemas</strong>: Data with flexible, nested structure</li>
<li><strong>Email and document repositories</strong>: Content with some structural elements but variable organization</li>
<li><strong>Social media content</strong>: Posts, profiles, and interactions with platform-specific structures</li>
</ol>
</div>
<div id="exm-semi-structured" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.5 (Semi-structured data extraction examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Web page extraction</strong>:</p>
<ul>
<li><p>Example: Extracting product information from e-commerce websites</p></li>
<li><p>Approach:</p>
<ul>
<li>Use HTML structure (lists, tables, divs) to identify entity boundaries</li>
<li>Use CSS selectors or XPath to target specific information</li>
<li>Extract entities and relationships from page content and navigation</li>
</ul></li>
<li><p>Web scraping example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract product details using CSS selectors</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>product <span class="op">=</span> {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'name'</span>: page.select_one(<span class="st">'h1.product-title'</span>).text,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'price'</span>: page.select_one(<span class="st">'span.price'</span>).text,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'manufacturer'</span>: page.select_one(<span class="st">'div.brand a'</span>).text,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">'categories'</span>: [a.text <span class="cf">for</span> a <span class="kw">in</span> page.select(<span class="st">'ul.breadcrumbs a'</span>)],</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">'features'</span>: [li.text <span class="cf">for</span> li <span class="kw">in</span> page.select(<span class="st">'ul.features li'</span>)]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><strong>Wiki extraction</strong>:</p>
<ul>
<li><p>Example: Building a knowledge graph from Wikipedia</p></li>
<li><p>Approach:</p>
<ul>
<li>Extract structured data from infoboxes (templated metadata)</li>
<li>Use section headers to organize information hierarchically</li>
<li>Extract entities and relationships from links and categories</li>
<li>Apply NLP to extract additional relationships from text</li>
</ul></li>
<li><p>Wikipedia extraction example:</p>
<pre><code># From Wikipedia infobox for Berlin
Entity: Berlin
Type: City, Capital
Country: Germany
Population: 3,664,088
Area: 891.7 km²
Mayor: Franziska Giffey</code></pre></li>
</ul></li>
<li><p><strong>Social media extraction</strong>:</p>
<ul>
<li><p>Example: Building a social network knowledge graph from Twitter</p></li>
<li><p>Approach:</p>
<ul>
<li>Extract users as primary entities</li>
<li>Extract relationships from follows, mentions, replies</li>
<li>Extract topics and sentiments from post content</li>
<li>Build temporal patterns from posting timestamps</li>
</ul></li>
<li><p>Twitter extraction example:</p>
<pre><code># From tweet data structure
Entity: User123
Relationship: posted -&gt; Tweet456
Relationship: mentioned -&gt; User789 in Tweet456
Relationship: hashtagged -&gt; #AI in Tweet456
Property: Tweet456.sentiment = positive
Property: Tweet456.timestamp = 2023-05-15T14:30:00Z</code></pre></li>
</ul></li>
</ol>
</div>
<p>Integration challenges for semi-structured data include:</p>
<ol type="1">
<li><strong>Inconsistent formatting</strong>: Variations in how information is presented</li>
<li><strong>Implicit relationships</strong>: Connections that are implied rather than explicitly stated</li>
<li><strong>Noise and irrelevant content</strong>: Filtering out elements that don’t contribute to the knowledge graph</li>
<li><strong>Structure recognition</strong>: Identifying meaningful patterns in variable layouts</li>
</ol>
</section>
<section id="unstructured-data-sources" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="unstructured-data-sources"><span class="header-section-number">6.2.3</span> Unstructured data sources</h3>
<p>Unstructured data sources contain information without explicit organization:</p>
<div id="def-unstructured" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.6 (Unstructured data sources)</strong></span> <strong>Unstructured data sources</strong> contain information with no predefined data model or organized structure. Key types include:</p>
<ol type="1">
<li><strong>Natural language text</strong>: Articles, reports, books, or other written documents</li>
<li><strong>Audio recordings</strong>: Spoken conversations, lectures, or interviews</li>
<li><strong>Images</strong>: Photographs, diagrams, charts, or other visual content</li>
<li><strong>Videos</strong>: Visual and auditory content with temporal dimension</li>
<li><strong>Scientific data</strong>: Experimental results, observations, measurements</li>
</ol>
</div>
<div id="exm-unstructured" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.6 (Unstructured data extraction examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Natural language text extraction</strong>:</p>
<ul>
<li><p>Example: Building a knowledge graph from scientific papers</p></li>
<li><p>Approach:</p>
<ul>
<li>Apply named entity recognition to identify key entities</li>
<li>Use relationship extraction to identify connections between entities</li>
<li>Apply coreference resolution to connect mentions of the same entity</li>
<li>Extract numerical values and measurements as attributes</li>
</ul></li>
<li><p>Text extraction example:</p>
<pre><code>Input text: "BERT was developed by Google and was first published in 2018."

Extracted:
Entity: BERT (type: Model)
Entity: Google (type: Organization)
Relationship: developedBy(BERT, Google)
Attribute: publishedYear(BERT, 2018)</code></pre></li>
</ul></li>
<li><p><strong>Image extraction</strong>:</p>
<ul>
<li><p>Example: Building a knowledge graph from medical images</p></li>
<li><p>Approach:</p>
<ul>
<li>Apply object detection to identify anatomical structures</li>
<li>Use image segmentation to delineate regions of interest</li>
<li>Extract relationships based on spatial arrangement</li>
<li>Classify abnormalities and link to condition entities</li>
</ul></li>
<li><p>Image extraction example:</p>
<pre><code>Input: Chest X-ray image

Extracted:
Entity: LeftLung_PatientX (type: LeftLung)
Entity: RightLung_PatientX (type: RightLung)
Entity: Nodule123 (type: PulmonaryNodule)
Relationship: locatedIn(Nodule123, RightLung_PatientX)
Attribute: diameter(Nodule123, "12mm")</code></pre></li>
</ul></li>
<li><p><strong>Audio extraction</strong>:</p>
<ul>
<li><p>Example: Building a knowledge graph from meeting recordings</p></li>
<li><p>Approach:</p>
<ul>
<li>Apply speech recognition to convert audio to text</li>
<li>Use speaker diarization to identify who said what</li>
<li>Apply NLP to the resulting text to extract entities and relationships</li>
<li>Extract temporal relationships from sequence of topics</li>
</ul></li>
<li><p>Audio extraction example:</p>
<pre><code>Input: Meeting recording

Extracted:
Entity: Meeting_20230520 (type: Meeting)
Entity: ProjectAlpha (type: Project)
Relationship: discussed(Meeting_20230520, ProjectAlpha)
Relationship: participated(JohnDoe, Meeting_20230520)
Relationship: stated(JohnDoe, "We need to increase the budget")</code></pre></li>
</ul></li>
</ol>
</div>
<p>Integration challenges for unstructured data include:</p>
<ol type="1">
<li><strong>Information extraction accuracy</strong>: Errors in identifying entities and relationships</li>
<li><strong>Ambiguity resolution</strong>: Determining the correct interpretation of ambiguous terms</li>
<li><strong>Incompleteness</strong>: Missing context that would be obvious to human readers</li>
<li><strong>Cross-modal integration</strong>: Combining insights from different types of unstructured data</li>
</ol>
</section>
<section id="combining-multiple-source-types" class="level3" data-number="6.2.4">
<h3 data-number="6.2.4" class="anchored" data-anchor-id="combining-multiple-source-types"><span class="header-section-number">6.2.4</span> Combining multiple source types</h3>
<p>Real-world knowledge graphs typically integrate information from multiple source types:</p>
<div id="def-multi-source" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.7 (Multi-source integration)</strong></span> <strong>Multi-source integration</strong> involves combining data from different source types (structured, semi-structured, and unstructured) into a unified knowledge graph. Key aspects include:</p>
<ol type="1">
<li><strong>Source prioritization</strong>: Determining which sources to trust when information conflicts</li>
<li><strong>Information alignment</strong>: Mapping concepts and entities across different source types</li>
<li><strong>Complementary extraction</strong>: Using different sources to fill different aspects of the knowledge graph</li>
<li><strong>Cross-validation</strong>: Verifying information by checking consistency across sources</li>
<li><strong>Confidence scoring</strong>: Assigning reliability metrics based on source characteristics</li>
</ol>
</div>
<div id="exm-multi-source" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.7 (Multi-source integration example)</strong></span> <strong>Project</strong>: Building a product knowledge graph</p>
<p><strong>Sources</strong>:</p>
<ol type="1">
<li><strong>Structured</strong>: Product database (SKUs, specifications, pricing)</li>
<li><strong>Semi-structured</strong>: Product web pages (features, compatibility, images)</li>
<li><strong>Unstructured</strong>: Customer reviews (experiences, issues, comparisons)</li>
</ol>
<p><strong>Integration approach</strong>:</p>
<ol type="1">
<li><p><strong>Core entity creation from structured data</strong>:</p>
<ul>
<li>Create product entities with basic attributes from database</li>
<li>Example: Product123 (category: Laptop, price: $999, weight: 1.2kg)</li>
</ul></li>
<li><p><strong>Enrichment from semi-structured data</strong>:</p>
<ul>
<li>Add detailed features and relationships from product pages</li>
<li>Example: compatibleWith(Product123, Accessory456), hasFeature(Product123, “10-hour battery life”)</li>
</ul></li>
<li><p><strong>Augmentation from unstructured data</strong>:</p>
<ul>
<li>Extract sentiment, common issues, and comparisons from reviews</li>
<li>Example: commonIssue(Product123, “Overheating”), comparedFavorablyTo(Product123, Competitor789)</li>
</ul></li>
<li><p><strong>Conflict resolution</strong>:</p>
<ul>
<li>For basic specifications: trust database over web pages</li>
<li>For user experiences: aggregate from multiple reviews with confidence scoring</li>
<li>For temporal information (e.g., price changes): maintain provenance and timestamps</li>
</ul></li>
<li><p><strong>Result</strong>: A comprehensive knowledge graph with:</p>
<ul>
<li>Technical specifications (from structured data)</li>
<li>Feature details and compatibility (from semi-structured data)</li>
<li>User experiences and comparative positioning (from unstructured data)</li>
<li>Confidence scores and provenance for each piece of information</li>
</ul></li>
</ol>
</div>
<p>Best practices for multi-source integration include:</p>
<ol type="1">
<li><strong>Maintaining provenance</strong>: Tracking which source provided each piece of information</li>
<li><strong>Implementing conflict resolution policies</strong>: Defining rules for handling contradictory information</li>
<li><strong>Developing unified entity representations</strong>: Creating consistent entity references across sources</li>
<li><strong>Employing incremental integration</strong>: Building the graph progressively as new sources are processed</li>
<li><strong>Supporting temporal versioning</strong>: Tracking how information changes over time across sources</li>
</ol>
</section>
</section>
<section id="information-extraction-techniques" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="information-extraction-techniques"><span class="header-section-number">6.3</span> Information extraction techniques</h2>
<p>Information extraction is the process of identifying and extracting structured information from unstructured or semi-structured sources. This section covers key techniques for extracting entities, relationships, and attributes for knowledge graphs.</p>
<section id="named-entity-recognition" class="level3" data-number="6.3.1">
<h3 data-number="6.3.1" class="anchored" data-anchor-id="named-entity-recognition"><span class="header-section-number">6.3.1</span> Named entity recognition</h3>
<p>Named entity recognition (NER) identifies and classifies named entities in text:</p>
<div id="def-ner" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.8 (Named entity recognition)</strong></span> <strong>Named entity recognition (NER)</strong> is the task of identifying mentions of named entities in text and classifying them into predefined categories such as:</p>
<ol type="1">
<li><strong>Persons</strong>: Individual people (e.g., Albert Einstein, Marie Curie)</li>
<li><strong>Organizations</strong>: Companies, institutions, agencies (e.g., Google, WHO, MIT)</li>
<li><strong>Locations</strong>: Physical places (e.g., Paris, Mount Everest, Lake Michigan)</li>
<li><strong>Products</strong>: Commercial products (e.g., iPhone, Toyota Camry)</li>
<li><strong>Dates and times</strong>: Temporal expressions (e.g., May 2023, next Tuesday)</li>
<li><strong>Numeric expressions</strong>: Quantities, percentages, monetary values</li>
</ol>
<p>Domain-specific NER may include additional categories relevant to particular fields (e.g., proteins, diseases, legal citations).</p>
</div>
<div id="exm-ner" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.8 (Named entity recognition examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>General-domain NER</strong>:</p>
<pre><code>Input: "Apple is planning to open a new campus in Austin, Texas by 2025."

Output:
[Apple](Organization) is planning to open a new campus in [Austin, Texas](Location) by [2025](Time).</code></pre></li>
<li><p><strong>Biomedical NER</strong>:</p>
<pre><code>Input: "Patients with diabetes mellitus often develop hypertension and may require treatment with metformin."

Output:
Patients with [diabetes mellitus](Disease) often develop [hypertension](Disease) and may require treatment with [metformin](Drug).</code></pre></li>
<li><p><strong>Financial NER</strong>:</p>
<pre><code>Input: "Tesla reported a quarterly revenue of $24.9 billion, exceeding Wall Street expectations."

Output:
[Tesla](Organization) reported a quarterly revenue of [$24.9 billion](Money), exceeding [Wall Street](Organization) expectations.</code></pre></li>
</ol>
</div>
<p>NER approaches include:</p>
<ol type="1">
<li><p><strong>Rule-based methods</strong>:</p>
<ul>
<li>Using gazetteers (lists of known entities)</li>
<li>Pattern matching with regular expressions</li>
<li>Grammatical rules specific to entity types</li>
<li>Advantages: Interpretable, can work with limited training data</li>
<li>Disadvantages: Limited coverage, labor-intensive to create rules</li>
</ul></li>
<li><p><strong>Machine learning methods</strong>:</p>
<ul>
<li>Traditional: Conditional Random Fields (CRF), Support Vector Machines (SVM)</li>
<li>Deep learning: Bi-directional LSTMs, Transformer-based models (BERT, RoBERTa)</li>
<li>Advantages: Better generalization, can learn from data</li>
<li>Disadvantages: Require substantial training data, may lack interpretability</li>
</ul></li>
<li><p><strong>Hybrid approaches</strong>:</p>
<ul>
<li>Combining rule-based and machine learning methods</li>
<li>Using rules to augment training data</li>
<li>Using machine learning with rule-based features</li>
<li>Advantages: Combines strengths of both approaches</li>
<li>Disadvantages: More complex to implement and maintain</li>
</ul></li>
</ol>
<div id="exm-ner-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.9 (NER implementation approaches)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Rule-based NER implementation</strong>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified rule-based NER example</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Patterns for different entity types</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>patterns <span class="op">=</span> {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: <span class="vs">r'\d{1,2}/\d{1,2}/\d</span><span class="sc">{4}</span><span class="vs">|\d</span><span class="sc">{4}</span><span class="vs">-\d</span><span class="sc">{2}</span><span class="vs">-\d</span><span class="sc">{2}</span><span class="vs">'</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'email'</span>: <span class="vs">r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'url'</span>: <span class="vs">r'https?://[^\s]+'</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply patterns to text</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rule_based_ner(text):</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    entities <span class="op">=</span> []</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_type, pattern <span class="kw">in</span> patterns.items():</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> match <span class="kw">in</span> re.finditer(pattern, text):</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            entities.append({</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">'text'</span>: match.group(),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">'type'</span>: entity_type,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">'start'</span>: match.start(),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">'end'</span>: match.end()</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> entities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Deep learning NER implementation</strong> (using a library):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using spaCy for NER</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load pre-trained model</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_lg"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ml_based_ner(text):</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(text)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    entities <span class="op">=</span> []</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ent <span class="kw">in</span> doc.ents:</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        entities.append({</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'text'</span>: ent.text,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'type'</span>: ent.label_,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'start'</span>: ent.start_char,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'end'</span>: ent.end_char</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> entities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Fine-tuning for domain-specific NER</strong>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example of preparing data for fine-tuning a domain-specific NER model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> [</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Aspirin may interact with warfarin and increase bleeding risk."</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>      {<span class="st">"entities"</span>: [(<span class="dv">0</span>, <span class="dv">7</span>, <span class="st">"DRUG"</span>), (<span class="dv">23</span>, <span class="dv">31</span>, <span class="st">"DRUG"</span>)]}),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Patients with hypertension should monitor blood pressure regularly."</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>      {<span class="st">"entities"</span>: [(<span class="dv">14</span>, <span class="dv">26</span>, <span class="st">"DISEASE"</span>)]})</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The actual fine-tuning code would depend on the specific library/framework</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in NER for knowledge graph construction include:</p>
<ol type="1">
<li><strong>Entity boundary detection</strong>: Determining where entities start and end</li>
<li><strong>Entity type ambiguity</strong>: Resolving cases where an entity could belong to multiple categories</li>
<li><strong>Context dependence</strong>: Interpreting entities based on surrounding context</li>
<li><strong>Domain adaptation</strong>: Adapting general NER systems to specific domains</li>
<li><strong>Nested entities</strong>: Handling entities that contain other entities</li>
</ol>
</section>
<section id="relationship-extraction" class="level3" data-number="6.3.2">
<h3 data-number="6.3.2" class="anchored" data-anchor-id="relationship-extraction"><span class="header-section-number">6.3.2</span> Relationship extraction</h3>
<p>Relationship extraction identifies semantic relationships between entities:</p>
<div id="def-relation-extraction" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.9 (Relationship extraction)</strong></span> <strong>Relationship extraction</strong> is the task of identifying semantic relationships between entities mentioned in text. The process involves:</p>
<ol type="1">
<li>Identifying entity mentions in text (often using NER)</li>
<li>Determining which entity pairs might be related</li>
<li>Classifying the type of relationship between entities</li>
<li>Extracting any additional attributes of the relationship</li>
</ol>
<p>Relationship types can include:</p>
<ul>
<li>Hierarchical (is-a, part-of)</li>
<li>Action-based (created, affects, causes)</li>
<li>Social (knows, works-for, married-to)</li>
<li>Spatial (located-in, near)</li>
<li>Temporal (precedes, during)</li>
<li>Domain-specific (treats, inhibits, regulates)</li>
</ul>
</div>
<div id="exm-relation-extraction" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.10 (Relationship extraction examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>General domain</strong>:</p>
<pre><code>Input: "Tim Cook, who has been the CEO of Apple since 2011, introduced the new iPhone yesterday."

Extracted relationships:
- hasRole(Tim Cook, CEO)
- employedBy(Tim Cook, Apple)
- startDate(Tim Cook employed by Apple, 2011)
- introduced(Tim Cook, iPhone)</code></pre></li>
<li><p><strong>Biomedical domain</strong>:</p>
<pre><code>Input: "Metformin reduces glucose production in the liver and improves insulin sensitivity."

Extracted relationships:
- reduces(Metformin, glucose production)
- locatedIn(glucose production, liver)
- improves(Metformin, insulin sensitivity)</code></pre></li>
<li><p><strong>Financial domain</strong>:</p>
<pre><code>Input: "Amazon acquired Whole Foods for $13.7 billion in 2017."

Extracted relationships:
- acquired(Amazon, Whole Foods)
- hasValue(acquisition, $13.7 billion)
- occurredIn(acquisition, 2017)</code></pre></li>
</ol>
</div>
<p>Relationship extraction approaches include:</p>
<ol type="1">
<li><p><strong>Pattern-based methods</strong>:</p>
<ul>
<li>Leveraging linguistic patterns (e.g., “X is employed by Y”)</li>
<li>Using dependency parsing to capture grammatical relationships</li>
<li>Applying regular expressions or lexico-syntactic patterns</li>
<li>Advantages: Interpretable, precision-oriented</li>
<li>Disadvantages: Limited recall, difficult to cover all variations</li>
</ul></li>
<li><p><strong>Supervised learning methods</strong>:</p>
<ul>
<li>Feature-based: Using linguistic features with traditional ML algorithms</li>
<li>Neural networks: CNN, RNN, or transformer architectures</li>
<li>Distant supervision: Using existing knowledge bases to automatically generate training data</li>
<li>Advantages: Better generalization, higher recall</li>
<li>Disadvantages: Require substantial training data</li>
</ul></li>
<li><p><strong>Open information extraction</strong>:</p>
<ul>
<li>Extracting relational tuples without pre-defined relation types</li>
<li>Identifying subject-predicate-object structures in sentences</li>
<li>Advantages: Domain-independent, no predefined schema</li>
<li>Disadvantages: Noisy, requires post-processing to normalize relations</li>
</ul></li>
</ol>
<div id="exm-relation-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.11 (Relationship extraction implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Pattern-based extraction</strong>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load spaCy model</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_lg"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Example pattern for "works for" relationship</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_employment_relations(text):</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(text)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    relations <span class="op">=</span> []</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple pattern: PERSON works/worked for ORGANIZATION</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity1 <span class="kw">in</span> doc.ents:</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> entity1.label_ <span class="op">==</span> <span class="st">"PERSON"</span>:</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> entity2 <span class="kw">in</span> doc.ents:</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> entity2.label_ <span class="op">==</span> <span class="st">"ORG"</span> <span class="kw">and</span> entity1 <span class="op">!=</span> entity2:</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if there's a work-related verb between them</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> token <span class="kw">in</span> doc:</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> (token.lemma_ <span class="kw">in</span> [<span class="st">"work"</span>, <span class="st">"employ"</span>] <span class="kw">and</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                            token.i <span class="op">&gt;</span> entity1.end <span class="kw">and</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                            token.i <span class="op">&lt;</span> entity2.start):</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>                            relations.append({</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"subject"</span>: entity1.text,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"relation"</span>: <span class="st">"works_for"</span>,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"object"</span>: entity2.text</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>                            })</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> relations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Supervised learning approach</strong>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified example of preparing data for supervised relation extraction</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_relation_features(sentence, e1_start, e1_end, e2_start, e2_end):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Mark entities in sentence</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    marked_text <span class="op">=</span> (sentence[:e1_start] <span class="op">+</span> <span class="st">"[E1]"</span> <span class="op">+</span> sentence[e1_start:e1_end] <span class="op">+</span> <span class="st">"[/E1]"</span> <span class="op">+</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                  sentence[e1_end:e2_start] <span class="op">+</span> <span class="st">"[E2]"</span> <span class="op">+</span> sentence[e2_start:e2_end] <span class="op">+</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"[/E2]"</span> <span class="op">+</span> sentence[e2_end:])</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Get embeddings or other features</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (In practice, you would use more sophisticated feature extraction)</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># In a real implementation, these features would be used to train a classifier</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Using pre-trained language models</strong>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> pipeline</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using a pre-trained relation extraction model</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>relation_classifier <span class="op">=</span> pipeline(<span class="st">"text-classification"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                              model<span class="op">=</span><span class="st">"jean-baptiste/roberta-large-ner-english"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_relations_with_transformer(text, entities):</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    relations <span class="op">=</span> []</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each pair of entities</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, e1 <span class="kw">in</span> <span class="bu">enumerate</span>(entities):</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j, e2 <span class="kw">in</span> <span class="bu">enumerate</span>(entities):</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">!=</span> j:</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Construct input with special markers</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                marked_text <span class="op">=</span> (text[:e1[<span class="st">'start'</span>]] <span class="op">+</span> <span class="st">"&lt;e1&gt;"</span> <span class="op">+</span> text[e1[<span class="st">'start'</span>]:e1[<span class="st">'end'</span>]] <span class="op">+</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"&lt;/e1&gt;"</span> <span class="op">+</span> text[e1[<span class="st">'end'</span>]:e2[<span class="st">'start'</span>]] <span class="op">+</span> <span class="st">"&lt;e2&gt;"</span> <span class="op">+</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>                             text[e2[<span class="st">'start'</span>]:e2[<span class="st">'end'</span>]] <span class="op">+</span> <span class="st">"&lt;/e2&gt;"</span> <span class="op">+</span> text[e2[<span class="st">'end'</span>]:])</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Classify the relationship</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> relation_classifier(marked_text)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add if confidence is high enough</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> result[<span class="dv">0</span>][<span class="st">'score'</span>] <span class="op">&gt;</span> <span class="fl">0.7</span>:</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>                    relations.append({</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"subject"</span>: e1[<span class="st">'text'</span>],</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"relation"</span>: result[<span class="dv">0</span>][<span class="st">'label'</span>],</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"object"</span>: e2[<span class="st">'text'</span>],</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"confidence"</span>: result[<span class="dv">0</span>][<span class="st">'score'</span>]</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> relations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in relationship extraction for knowledge graphs include:</p>
<ol type="1">
<li><strong>Relationship directionality</strong>: Determining which entity is the subject and which is the object</li>
<li><strong>Implicit relationships</strong>: Relationships that are implied but not explicitly stated</li>
<li><strong>Negated relationships</strong>: Distinguishing between affirmed and negated relationships</li>
<li><strong>Relationship modality</strong>: Capturing certainty, possibility, or necessity of relationships</li>
<li><strong>Distant entity pairs</strong>: Extracting relationships between entities mentioned far apart in text</li>
</ol>
</section>
<section id="attribute-extraction" class="level3" data-number="6.3.3">
<h3 data-number="6.3.3" class="anchored" data-anchor-id="attribute-extraction"><span class="header-section-number">6.3.3</span> Attribute extraction</h3>
<p>Attribute extraction identifies properties and characteristics of entities:</p>
<div id="def-attribute-extraction" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.10 (Attribute extraction)</strong></span> <strong>Attribute extraction</strong> is the process of identifying properties or characteristics associated with entities. This involves:</p>
<ol type="1">
<li>Recognizing the entity and its attributes in text</li>
<li>Extracting the attribute values</li>
<li>Normalizing values to appropriate data types</li>
<li>Associating attributes with the correct entities</li>
</ol>
<p>Common attribute types include:</p>
<ul>
<li>Quantitative attributes (age, price, measurements)</li>
<li>Temporal attributes (date of birth, founding date)</li>
<li>Descriptive attributes (color, material, status)</li>
<li>Categorical attributes (nationality, genre, blood type)</li>
</ul>
</div>
<div id="exm-attribute-extraction" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.12 (Attribute extraction examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Product attributes</strong>:</p>
<pre><code>Input: "The iPhone 13 Pro Max features a 6.7-inch display, weighs 240 grams, and comes with up to 1TB of storage."

Extracted attributes:
- Entity: iPhone 13 Pro Max (Type: Product)
- display_size: 6.7 inches (Type: Measurement)
- weight: 240 grams (Type: Measurement)
- max_storage: 1TB (Type: Capacity)</code></pre></li>
<li><p><strong>Person attributes</strong>:</p>
<pre><code>Input: "Marie Curie (born Maria Salomea Skłodowska; 7 November 1867 – 4 July 1934) was a Polish-French physicist and chemist who conducted pioneering research on radioactivity."

Extracted attributes:
- Entity: Marie Curie (Type: Person)
- birth_name: Maria Salomea Skłodowska (Type: Text)
- birth_date: 7 November 1867 (Type: Date)
- death_date: 4 July 1934 (Type: Date)
- nationality: Polish-French (Type: Category)
- profession: physicist, chemist (Type: Category)
- research_field: radioactivity (Type: Category)</code></pre></li>
<li><p><strong>Location attributes</strong>:</p>
<pre><code>Input: "Tokyo, the capital of Japan, has a population of approximately 13.96 million and covers an area of 2,194 square kilometers."

Extracted attributes:
- Entity: Tokyo (Type: Location)
- is_capital_of: Japan (Type: Relation)
- population: 13.96 million (Type: Quantity)
- area: 2,194 square kilometers (Type: Measurement)</code></pre></li>
</ol>
</div>
<p>Attribute extraction approaches include:</p>
<ol type="1">
<li><p><strong>Pattern-based methods</strong>:</p>
<ul>
<li>Regular expressions for structured formats (e.g., dates, measurements)</li>
<li>Lexico-syntactic patterns (e.g., “X is Y years old”)</li>
<li>Template filling based on attribute-value patterns</li>
<li>Advantages: Precision for well-structured attributes</li>
<li>Disadvantages: Limited coverage of expression variations</li>
</ul></li>
<li><p><strong>Classification-based methods</strong>:</p>
<ul>
<li>Treating attribute extraction as sequence labeling</li>
<li>Using BIO (Beginning-Inside-Outside) tagging for attribute spans</li>
<li>Classifying attribute types for extracted values</li>
<li>Advantages: Better handling of context variation</li>
<li>Disadvantages: Requires labeled training data</li>
</ul></li>
<li><p><strong>Information extraction frameworks</strong>:</p>
<ul>
<li>Joint extraction of entities and attributes</li>
<li>Leveraging dependency parsing for attribute-entity associations</li>
<li>Using ontologies to guide attribute extraction</li>
<li>Advantages: Coherent extraction of related information</li>
<li>Disadvantages: Complex implementation, error propagation</li>
</ul></li>
</ol>
<div id="exm-attribute-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.13 (Attribute extraction implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Pattern-based attribute extraction</strong>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Patterns for common attributes</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>attribute_patterns <span class="op">=</span> {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'weight'</span>: <span class="vs">r'weighs (\d+(?:\.\d+)?) (kg|grams|pounds|g)'</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'height'</span>: <span class="vs">r'(stands|is) (\d+(?:\.\d+)?) (meters|m|cm|feet|ft) tall'</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'age'</span>: <span class="vs">r'(\d+)(?:-| )years?(?:-| )old|aged (\d+)'</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'price'</span>: <span class="vs">r'\$([\d,]+(?:\.\d+)?)|costs ([\d,]+(?:\.\d+)?) dollars'</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_attributes(text, entity):</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    attributes <span class="op">=</span> {}</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attr_name, pattern <span class="kw">in</span> attribute_patterns.items():</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        matches <span class="op">=</span> re.finditer(pattern, text)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> match <span class="kw">in</span> matches:</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract the value (handling multiple capture groups)</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> <span class="bu">next</span>(<span class="bu">filter</span>(<span class="va">None</span>, match.groups()))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>            unit <span class="op">=</span> <span class="va">None</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract unit if present in the pattern</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attr_name <span class="kw">in</span> [<span class="st">'weight'</span>, <span class="st">'height'</span>]:</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                unit <span class="op">=</span> match.groups()[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>            attributes[attr_name] <span class="op">=</span> {</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">'value'</span>: value,</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">'unit'</span>: unit,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">'text'</span>: match.group(<span class="dv">0</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> attributes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Sequence labeling for attribute extraction</strong>:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using spaCy for attribute extraction (simplified example)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spacy.tokens <span class="im">import</span> DocBin</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Example of preparing training data for a sequence labeling model</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_attribute_training_data():</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    train_data <span class="op">=</span> []</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example: "The book costs $15.99 and has 320 pages."</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We'll label "costs $15.99" as PRICE and "320 pages" as PAGE_COUNT</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    example1 <span class="op">=</span> (</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"The book costs $15.99 and has 320 pages."</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"entities"</span>: [(<span class="dv">10</span>, <span class="dv">22</span>, <span class="st">"PRICE"</span>), (<span class="dv">32</span>, <span class="dv">41</span>, <span class="st">"PAGE_COUNT"</span>)]}</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    train_data.append(example1)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># More examples would be added here...</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_data</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="co"># In practice, you would use this data to train a custom NER model</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co"># that recognizes attribute spans, then post-process to extract values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Dependency parsing for attribute association</strong>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_lg"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_attributes_with_dependencies(text, entity_span):</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(text)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    entity_tokens <span class="op">=</span> []</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    attributes <span class="op">=</span> {}</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find entity tokens</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token <span class="kw">in</span> doc:</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token.idx <span class="op">&gt;=</span> entity_span[<span class="dv">0</span>] <span class="kw">and</span> token.idx <span class="op">+</span> <span class="bu">len</span>(token.text) <span class="op">&lt;=</span> entity_span[<span class="dv">1</span>]:</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>            entity_tokens.append(token)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> entity_tokens:</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> attributes</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find attribute relationships using dependency parsing</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    entity_head <span class="op">=</span> entity_tokens[<span class="dv">0</span>]</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token <span class="kw">in</span> doc:</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for dependency relationships with entity</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token.head <span class="kw">in</span> entity_tokens <span class="kw">and</span> token.dep_ <span class="kw">in</span> [<span class="st">"nummod"</span>, <span class="st">"amod"</span>]:</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Numerical or adjectival modifier</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>            attr_name <span class="op">=</span> <span class="st">"numeric"</span> <span class="cf">if</span> token.dep_ <span class="op">==</span> <span class="st">"nummod"</span> <span class="cf">else</span> <span class="st">"descriptive"</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>            attributes[attr_name] <span class="op">=</span> token.text</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for attribute phrases (e.g., "weighs 5 kg")</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token.head <span class="kw">in</span> entity_tokens <span class="kw">and</span> token.dep_ <span class="op">==</span> <span class="st">"acl"</span>:</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Adjectival clause</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> child <span class="kw">in</span> token.children:</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> child.dep_ <span class="op">==</span> <span class="st">"dobj"</span> <span class="kw">and</span> child.pos_ <span class="op">==</span> <span class="st">"NUM"</span>:</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>                    attributes[token.lemma_] <span class="op">=</span> child.text</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> attributes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in attribute extraction for knowledge graphs include:</p>
<ol type="1">
<li><strong>Attribute-entity association</strong>: Determining which attributes belong to which entities</li>
<li><strong>Value normalization</strong>: Converting textual descriptions to standardized values and units</li>
<li><strong>Implicit attributes</strong>: Inferring attributes that are assumed but not explicitly stated</li>
<li><strong>Attribute ambiguity</strong>: Resolving cases where attributes could be interpreted in multiple ways</li>
<li><strong>Temporal aspects</strong>: Capturing how attributes change over time</li>
</ol>
</section>
<section id="event-extraction" class="level3" data-number="6.3.4">
<h3 data-number="6.3.4" class="anchored" data-anchor-id="event-extraction"><span class="header-section-number">6.3.4</span> Event extraction</h3>
<p>Event extraction identifies and structures information about events and their participants:</p>
<div id="def-event-extraction" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.11 (Event extraction)</strong></span> <strong>Event extraction</strong> identifies events mentioned in text and extracts structured representations including:</p>
<ol type="1">
<li><strong>Event type</strong>: The category or class of the event (e.g., acquisition, earthquake, election)</li>
<li><strong>Event trigger</strong>: The word or phrase that indicates the event’s occurrence</li>
<li><strong>Event arguments</strong>: Entities playing specific roles in the event</li>
<li><strong>Temporal information</strong>: When the event occurred</li>
<li><strong>Spatial information</strong>: Where the event took place</li>
<li><strong>Additional attributes</strong>: Other relevant details about the event</li>
</ol>
<p>Events in knowledge graphs are typically represented as entities themselves, with relationships to participants and attributes.</p>
</div>
<div id="exm-event-extraction" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.14 (Event extraction examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Business event</strong>:</p>
<pre><code>Input: "Google acquired YouTube for $1.65 billion in October 2006."

Extracted event:
- Event_ID: Acquisition_123
- Type: Acquisition
- Trigger: "acquired"
- Arguments:
  - Acquirer: Google
  - Acquired: YouTube
  - Amount: $1.65 billion
- Time: October 2006</code></pre></li>
<li><p><strong>Political event</strong>:</p>
<pre><code>Input: "Joe Biden was inaugurated as the 46th President of the United States on January 20, 2021, in Washington, D.C."

Extracted event:
- Event_ID: Inauguration_456
- Type: Inauguration
- Trigger: "inaugurated"
- Arguments:
  - Person: Joe Biden
  - Role: President
  - Organization: United States
- Time: January 20, 2021
- Location: Washington, D.C.</code></pre></li>
<li><p><strong>Scientific event</strong>:</p>
<pre><code>Input: "Researchers at Oxford University successfully tested a malaria vaccine with 77% efficacy in a phase 2b trial last year."

Extracted event:
- Event_ID: ClinicalTrial_789
- Type: ClinicalTrial
- Trigger: "tested"
- Arguments:
  - Agent: Researchers
  - Affiliation: Oxford University
  - Subject: malaria vaccine
- Attributes:
  - Efficacy: 77%
  - Phase: 2b
- Time: last year</code></pre></li>
</ol>
</div>
<p>Event extraction approaches include:</p>
<ol type="1">
<li><p><strong>Pipeline approaches</strong>:</p>
<ul>
<li>Sequential extraction of triggers, arguments, and attributes</li>
<li>Using classifiers for event type identification</li>
<li>Role labeling for argument identification</li>
<li>Advantages: Modular, easier to implement and debug</li>
<li>Disadvantages: Error propagation between stages</li>
</ul></li>
<li><p><strong>Joint modeling approaches</strong>:</p>
<ul>
<li>Extracting triggers and arguments simultaneously</li>
<li>Using structured prediction models</li>
<li>Leveraging shared representations for related tasks</li>
<li>Advantages: Better handling of interdependencies</li>
<li>Disadvantages: More complex models, requires more training data</li>
</ul></li>
<li><p><strong>Document-level approaches</strong>:</p>
<ul>
<li>Capturing events that span multiple sentences</li>
<li>Modeling event coreference and temporal ordering</li>
<li>Constructing narrative chains and scripts</li>
<li>Advantages: More comprehensive event representation</li>
<li>Disadvantages: Increased complexity, challenging evaluation</li>
</ul></li>
</ol>
<div id="exm-event-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.15 (Event extraction implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Pipeline approach implementation</strong>:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_lg"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_events(text):</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(text)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> []</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Identify potential event triggers (primarily verbs)</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    triggers <span class="op">=</span> [token <span class="cf">for</span> token <span class="kw">in</span> doc <span class="cf">if</span> token.pos_ <span class="op">==</span> <span class="st">"VERB"</span>]</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trigger <span class="kw">in</span> triggers:</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 2: Classify event type (simplified)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        event_type <span class="op">=</span> classify_event_type(trigger.lemma_)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> event_type:</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 3: Extract arguments</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        arguments <span class="op">=</span> {}</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Look for subject (typically agent)</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> trigger.children:</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> child.dep_ <span class="op">==</span> <span class="st">"nsubj"</span>:</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>                arguments[<span class="st">"agent"</span>] <span class="op">=</span> extract_entity_span(child)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Look for object (typically patient/theme)</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> child.dep_ <span class="kw">in</span> [<span class="st">"dobj"</span>, <span class="st">"attr"</span>]:</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>                arguments[<span class="st">"theme"</span>] <span class="op">=</span> extract_entity_span(child)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Look for prepositional attachments</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> child.dep_ <span class="op">==</span> <span class="st">"prep"</span>:</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>                prep_type <span class="op">=</span> child.text</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> prep_child <span class="kw">in</span> child.children:</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> prep_child.dep_ <span class="op">==</span> <span class="st">"pobj"</span>:</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>                        arg_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>prep_type<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>prep_child<span class="sc">.</span>ent_type_<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> prep_child.ent_type_ <span class="cf">else</span> prep_type</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>                        arguments[arg_name] <span class="op">=</span> extract_entity_span(prep_child)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 4: Extract temporal information</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        time_exprs <span class="op">=</span> [ent <span class="cf">for</span> ent <span class="kw">in</span> doc.ents <span class="cf">if</span> ent.label_ <span class="op">==</span> <span class="st">"DATE"</span> <span class="kw">or</span> ent.label_ <span class="op">==</span> <span class="st">"TIME"</span>]</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> time_exprs:</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>            arguments[<span class="st">"time"</span>] <span class="op">=</span> time_exprs[<span class="dv">0</span>].text</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the event</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        event <span class="op">=</span> {</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span>: event_type,</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"trigger"</span>: trigger.text,</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">"trigger_pos"</span>: (trigger.idx, trigger.idx <span class="op">+</span> <span class="bu">len</span>(trigger.text)),</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"arguments"</span>: arguments</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>        events.append(event)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> events</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_entity_span(token):</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract the full noun phrase for an entity"""</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> token.ent_type_:</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If it's a named entity, use the entity span</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ent <span class="kw">in</span> token.doc.ents:</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> token.i <span class="op">&gt;=</span> ent.start <span class="kw">and</span> token.i <span class="op">&lt;</span> ent.end:</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {<span class="st">"text"</span>: ent.text, <span class="st">"type"</span>: ent.label_}</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Otherwise, try to get the full noun phrase</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> token.pos_ <span class="kw">in</span> [<span class="st">"NOUN"</span>, <span class="st">"PROPN"</span>]:</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the subtree span</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>        subtree <span class="op">=</span> <span class="bu">list</span>(token.subtree)</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> <span class="bu">min</span>(subtree, key<span class="op">=</span><span class="kw">lambda</span> x: x.i)</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> <span class="bu">max</span>(subtree, key<span class="op">=</span><span class="kw">lambda</span> x: x.i)</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"text"</span>: doc[start.i:end.i<span class="op">+</span><span class="dv">1</span>].text, <span class="st">"type"</span>: <span class="st">"NP"</span>}</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"text"</span>: token.text, <span class="st">"type"</span>: token.pos_}</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_event_type(verb_lemma):</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simplified event type classification based on verb lemma"""</span></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>    event_types <span class="op">=</span> {</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"acquire"</span>: <span class="st">"Acquisition"</span>,</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"buy"</span>: <span class="st">"Acquisition"</span>,</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"merge"</span>: <span class="st">"Merger"</span>,</span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"announce"</span>: <span class="st">"Announcement"</span>,</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"launch"</span>: <span class="st">"ProductLaunch"</span>,</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"appoint"</span>: <span class="st">"Appointment"</span>,</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"resign"</span>: <span class="st">"Resignation"</span>,</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"elect"</span>: <span class="st">"Election"</span>,</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"inaugurate"</span>: <span class="st">"Inauguration"</span>,</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"discover"</span>: <span class="st">"Discovery"</span>,</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test"</span>: <span class="st">"Test"</span>,</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">"publish"</span>: <span class="st">"Publication"</span></span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> event_types.get(verb_lemma, <span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Using a pre-trained event extraction model</strong>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using Hugging Face transformers for event extraction (conceptual example)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> pipeline</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This is conceptual - you would need to find or fine-tune an appropriate model</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>event_extractor <span class="op">=</span> pipeline(<span class="st">"text-classification"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                          model<span class="op">=</span><span class="st">"path/to/event/extraction/model"</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_events_with_transformer(text):</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split text into appropriate chunks</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (in practice, you would handle document chunking more carefully)</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> [text[i:i<span class="op">+</span><span class="dv">512</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(text), <span class="dv">256</span>)]</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    all_events <span class="op">=</span> []</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify event types and triggers</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        events <span class="op">=</span> event_extractor(chunk)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> event <span class="kw">in</span> events:</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Further processing to extract arguments</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This would typically involve additional model calls or processing</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>            all_events.append({</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: event[<span class="st">"label"</span>],</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"confidence"</span>: event[<span class="st">"score"</span>],</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"text"</span>: chunk[event[<span class="st">"span"</span>][<span class="dv">0</span>]:event[<span class="st">"span"</span>][<span class="dv">1</span>]],</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Arguments would be extracted here</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_events</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Knowledge-driven event extraction</strong>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Incorporating domain knowledge for event extraction</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample event schema defining expected arguments for event types</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>event_schemas <span class="op">=</span> {</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Acquisition"</span>: {</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"required_args"</span>: [<span class="st">"acquirer"</span>, <span class="st">"acquired"</span>],</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"optional_args"</span>: [<span class="st">"amount"</span>, <span class="st">"time"</span>],</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trigger_verbs"</span>: [<span class="st">"acquire"</span>, <span class="st">"buy"</span>, <span class="st">"purchase"</span>, <span class="st">"take over"</span>]</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Merger"</span>: {</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"required_args"</span>: [<span class="st">"org1"</span>, <span class="st">"org2"</span>],</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"optional_args"</span>: [<span class="st">"time"</span>, <span class="st">"value"</span>],</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trigger_verbs"</span>: [<span class="st">"merge"</span>, <span class="st">"combine"</span>, <span class="st">"unite"</span>, <span class="st">"join"</span>]</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># More event types would be defined here</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> knowledge_driven_event_extraction(doc, event_schemas):</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using the schemas to guide extraction</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This would be combined with NLP techniques like those above</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The schema helps ensure all required arguments are sought</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and validates that extracted events are well-formed</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in event extraction for knowledge graphs include:</p>
<ol type="1">
<li><strong>Event complexity</strong>: Events with multiple participants and nested structure</li>
<li><strong>Cross-sentence events</strong>: Events described across multiple sentences</li>
<li><strong>Event coreference</strong>: Identifying when different mentions refer to the same event</li>
<li><strong>Implicit events</strong>: Events that are implied but not explicitly described</li>
<li><strong>Hypothetical or negated events</strong>: Distinguishing between actual, potential, and non-events</li>
</ol>
</section>
<section id="domain-specific-extraction-techniques" class="level3" data-number="6.3.5">
<h3 data-number="6.3.5" class="anchored" data-anchor-id="domain-specific-extraction-techniques"><span class="header-section-number">6.3.5</span> Domain-specific extraction techniques</h3>
<p>Different domains require specialized extraction techniques to capture domain-specific entities and relationships:</p>
<div id="def-domain-extraction" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.12 (Domain-specific extraction)</strong></span> <strong>Domain-specific extraction</strong> involves tailored approaches for identifying entities, relationships, and attributes in specialized fields such as:</p>
<ol type="1">
<li><strong>Biomedical</strong>: Genes, proteins, diseases, drugs, and their interactions</li>
<li><strong>Financial</strong>: Companies, markets, financial instruments, transactions</li>
<li><strong>Legal</strong>: Laws, cases, rulings, legal entities, obligations</li>
<li><strong>Scientific</strong>: Experiments, measurements, theories, citations</li>
<li><strong>Technical</strong>: Products, specifications, components, compatibilities</li>
</ol>
<p>These approaches typically combine domain knowledge with specialized information extraction techniques.</p>
</div>
<div id="exm-domain-extraction" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.16 (Domain-specific extraction examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Biomedical extraction</strong>:</p>
<pre><code>Input: "PTEN mutations are associated with increased AKT phosphorylation, which contributes to tumorigenesis in prostate cancer."

Extracted:
- Entity: PTEN (Type: Gene)
- Entity: AKT (Type: Protein)
- Entity: prostate cancer (Type: Disease)
- Relationship: associated_with(PTEN mutations, increased AKT phosphorylation)
- Relationship: contributes_to(increased AKT phosphorylation, tumorigenesis)
- Relationship: occurs_in(tumorigenesis, prostate cancer)</code></pre></li>
<li><p><strong>Financial extraction</strong>:</p>
<pre><code>Input: "Goldman Sachs downgraded Tesla stock from 'buy' to 'neutral' with a price target of $248, citing concerns about valuation."

Extracted:
- Entity: Goldman Sachs (Type: FinancialInstitution)
- Entity: Tesla (Type: Company)
- Entity: Tesla stock (Type: FinancialInstrument)
- Event: StockDowngrade
  - Agent: Goldman Sachs
  - Target: Tesla stock
  - FromRating: buy
  - ToRating: neutral
  - PriceTarget: $248
  - Reason: "concerns about valuation"</code></pre></li>
<li><p><strong>Legal extraction</strong>:</p>
<pre><code>Input: "According to Section 230 of the Communications Decency Act, internet platforms are not liable for content posted by users."

Extracted:
- Entity: Section 230 (Type: LegalProvision)
- Entity: Communications Decency Act (Type: Legislation)
- Entity: internet platforms (Type: LegalEntity)
- Relationship: part_of(Section 230, Communications Decency Act)
- Rule: not_liable_for(internet platforms, content posted by users)
- Authority: Section 230</code></pre></li>
</ol>
</div>
<p>Domain-specific extraction approaches include:</p>
<ol type="1">
<li><p><strong>Specialized NER and relation extraction</strong>:</p>
<ul>
<li>Domain-specific entity types (e.g., genes, legal citations)</li>
<li>Custom relationship taxonomies</li>
<li>Tailored extraction patterns for domain conventions</li>
<li>Advantages: Precision for domain-specific concepts</li>
<li>Disadvantages: Development cost, limited transferability</li>
</ul></li>
<li><p><strong>Dictionary and ontology-based methods</strong>:</p>
<ul>
<li>Using comprehensive terminological resources</li>
<li>Mapping to standardized identifiers</li>
<li>Leveraging domain ontologies for concept recognition</li>
<li>Advantages: Coverage of domain vocabulary, alignment with standards</li>
<li>Disadvantages: Maintenance of resources, novel term handling</li>
</ul></li>
<li><p><strong>Transfer learning and domain adaptation</strong>:</p>
<ul>
<li>Fine-tuning general models on domain-specific data</li>
<li>Domain-adaptive pre-training on specialized corpora</li>
<li>Few-shot learning for rare entity types</li>
<li>Advantages: Leveraging general language understanding</li>
<li>Disadvantages: Requires domain-specific training data</li>
</ul></li>
</ol>
<div id="exm-domain-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.17 (Domain-specific extraction implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Biomedical extraction using dictionaries and patterns</strong>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scispacy.linking <span class="im">import</span> EntityLinker</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load specialized biomedical model</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_sci_lg"</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add biomedical entity linker</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>linker <span class="op">=</span> EntityLinker(resolve_abbreviations<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                      linker_name<span class="op">=</span><span class="st">"umls"</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>nlp.add_pipe(linker)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional patterns for relationships</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>bio_relation_patterns <span class="op">=</span> [</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"INHIBITS"</span>,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pattern"</span>: [</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"LOWER"</span>: {<span class="st">"IN"</span>: [<span class="st">"inhibits"</span>, <span class="st">"suppresses"</span>, <span class="st">"blocks"</span>, <span class="st">"reduces"</span>]}},</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"OP"</span>: <span class="st">"*"</span>, <span class="st">"POS"</span>: {<span class="st">"NOT_IN"</span>: [<span class="st">"VERB"</span>]}},</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"ENT_TYPE"</span>: <span class="st">"CHEMICAL"</span>}</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># More patterns would be defined here</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_biomedical_entities(text):</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(text)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    entities <span class="op">=</span> []</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ent <span class="kw">in</span> doc.ents:</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get linked concepts from UMLS</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>        linked_entities <span class="op">=</span> [</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">"id"</span>: <span class="ss">f"UMLS:</span><span class="sc">{</span>e[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">"name"</span>: nlp.vocab.strings[e[<span class="dv">0</span>]],</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">"score"</span>: e[<span class="dv">1</span>]</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> e <span class="kw">in</span> ent._.kb_ents</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>        entities.append({</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"text"</span>: ent.text,</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span>: ent.label_,</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"pos"</span>: (ent.start_char, ent.end_char),</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"linked_entities"</span>: linked_entities[:<span class="dv">3</span>]  <span class="co"># Top 3 matches</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> entities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Financial extraction with domain-specific NER</strong>:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using a fine-tuned financial NER model</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer, AutoModelForTokenClassification</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load pre-trained financial NER model</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(<span class="st">"financial-bert-ner"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForTokenClassification.from_pretrained(<span class="st">"financial-bert-ner"</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_financial_entities(text):</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tokenize input</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> tokenizer(text, return_tensors<span class="op">=</span><span class="st">"pt"</span>, truncation<span class="op">=</span><span class="va">True</span>, padding<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get predictions</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(<span class="op">**</span>inputs)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> torch.argmax(outputs.logits, dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert token predictions to entities</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    tokens <span class="op">=</span> tokenizer.convert_ids_to_tokens(inputs[<span class="st">"input_ids"</span>][<span class="dv">0</span>])</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    token_pred_labels <span class="op">=</span> [model.config.id2label[t.item()] <span class="cf">for</span> t <span class="kw">in</span> predictions[<span class="dv">0</span>]]</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group tokens into entities (BIO format processing)</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    entities <span class="op">=</span> []</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    current_entity <span class="op">=</span> <span class="va">None</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token, label <span class="kw">in</span> <span class="bu">zip</span>(tokens, token_pred_labels):</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label.startswith(<span class="st">"B-"</span>):</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> current_entity:</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>                entities.append(current_entity)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>            entity_type <span class="op">=</span> label[<span class="dv">2</span>:]  <span class="co"># Remove "B-" prefix</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>            current_entity <span class="op">=</span> {<span class="st">"text"</span>: token, <span class="st">"type"</span>: entity_type}</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> label.startswith(<span class="st">"I-"</span>) <span class="kw">and</span> current_entity:</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Continue current entity</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>            current_entity[<span class="st">"text"</span>] <span class="op">+=</span> <span class="st">" "</span> <span class="op">+</span> token</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> label <span class="op">==</span> <span class="st">"O"</span>:</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> current_entity:</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>                entities.append(current_entity)</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>                current_entity <span class="op">=</span> <span class="va">None</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add last entity if there is one</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_entity:</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        entities.append(current_entity)</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> entities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Legal extraction with specialized patterns</strong>:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example of legal citation extraction using regex patterns</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Patterns for different types of legal citations</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>citation_patterns <span class="op">=</span> {</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"us_code"</span>: <span class="vs">r"\d+\s+U\.?S\.?C\.?\s+§*\s*\d+"</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cfr"</span>: <span class="vs">r"\d+\s+C\.?F\.?R\.?\s+§*\s*\d+\.\d+"</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scotus"</span>: <span class="vs">r"(\d+)\s+U\.S\.\s+(\d+)\s+\((\d</span><span class="sc">{4}</span><span class="vs">)\)"</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"public_law"</span>: <span class="vs">r"Pub\.\s*L\.\s*No\.\s*\d+-\d+"</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_legal_citations(text):</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    citations <span class="op">=</span> []</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> citation_type, pattern <span class="kw">in</span> citation_patterns.items():</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> match <span class="kw">in</span> re.finditer(pattern, text):</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>            citations.append({</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">"text"</span>: match.group(<span class="dv">0</span>),</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: citation_type,</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">"pos"</span>: (match.start(), match.end())</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional processing to normalize and categorize citations</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># would be added here</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> citations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in domain-specific extraction include:</p>
<ol type="1">
<li><strong>Domain terminology complexity</strong>: Highly specialized and technical vocabulary</li>
<li><strong>Disambiguation in context</strong>: Terms with different meanings across domains</li>
<li><strong>Evolving terminology</strong>: New terms and concepts emerging in rapidly developing fields</li>
<li><strong>Inter-domain connections</strong>: Relationships spanning multiple specialized domains</li>
<li><strong>Domain resources</strong>: Availability and quality of domain-specific knowledge resources</li>
</ol>
</section>
</section>
<section id="entity-resolution-and-linking" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="entity-resolution-and-linking"><span class="header-section-number">6.4</span> Entity resolution and linking</h2>
<p>Entity resolution and linking are crucial for creating coherent knowledge graphs by identifying when different mentions refer to the same real-world entity and connecting extracted entities to existing knowledge sources.</p>
<section id="entity-coreference-resolution" class="level3" data-number="6.4.1">
<h3 data-number="6.4.1" class="anchored" data-anchor-id="entity-coreference-resolution"><span class="header-section-number">6.4.1</span> Entity coreference resolution</h3>
<p>Entity coreference resolution identifies when different mentions in text refer to the same entity:</p>
<div id="def-coreference" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.13 (Entity coreference resolution)</strong></span> <strong>Entity coreference resolution</strong> is the process of determining when multiple mentions in text refer to the same real-world entity. This involves:</p>
<ol type="1">
<li>Identifying all entity mentions in the text</li>
<li>Grouping mentions that refer to the same entity into coreference chains</li>
<li>Resolving pronouns and other referring expressions to their antecedents</li>
</ol>
<p>Coreference resolution is essential for aggregating information about entities that may be mentioned multiple times throughout a document.</p>
</div>
<div id="exm-coreference" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.18 (Coreference resolution examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Person coreference</strong>:</p>
<pre><code>Text: "Tim Cook is the CEO of Apple. He joined the company in 1998 and became CEO after Steve Jobs."

Coreference chains:
- [Tim Cook, He] → Entity: Tim Cook
- [Apple, the company] → Entity: Apple
- [Steve Jobs] → Entity: Steve Jobs</code></pre></li>
<li><p><strong>Organization coreference</strong>:</p>
<pre><code>Text: "Microsoft announced new AI features. The tech giant has been investing heavily in artificial intelligence, and this move strengthens its position in the market."

Coreference chains:
- [Microsoft, The tech giant, its] → Entity: Microsoft
- [new AI features, this move] → Entity: AI feature announcement</code></pre></li>
<li><p><strong>Mixed entity types</strong>:</p>
<pre><code>Text: "The researchers tested the new drug on cancer cells. They found that it reduced tumor growth by 60% in their experiments."

Coreference chains:
- [The researchers, They, their] → Entity: Researchers
- [the new drug, it] → Entity: Drug
- [cancer cells, tumor] → Entity: Cancer cells</code></pre></li>
</ol>
</div>
<p>Coreference resolution approaches include:</p>
<ol type="1">
<li><p><strong>Rule-based approaches</strong>:</p>
<ul>
<li>Syntactic rules based on grammar</li>
<li>Semantic constraints based on entity types</li>
<li>Discourse-based heuristics</li>
<li>Advantages: Precision for common patterns</li>
<li>Disadvantages: Limited coverage, complex rule maintenance</li>
</ul></li>
<li><p><strong>Machine learning approaches</strong>:</p>
<ul>
<li>Feature-based models using linguistic features</li>
<li>Neural network models with contextual representations</li>
<li>End-to-end models jointly identifying and resolving mentions</li>
<li>Advantages: Better handling of complex cases</li>
<li>Disadvantages: Require substantial training data</li>
</ul></li>
<li><p><strong>Hybrid approaches</strong>:</p>
<ul>
<li>Combining rules and machine learning</li>
<li>Using rules for high-precision cases and ML for others</li>
<li>Advantages: Balance of precision and recall</li>
<li>Disadvantages: Increased system complexity</li>
</ul></li>
</ol>
<div id="exm-coreference-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.19 (Coreference resolution implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Using spaCy for coreference resolution</strong>:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using neuralcoref extension for spaCy</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> neuralcoref</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load model and add neural coreference resolution</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_lg"</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>neuralcoref.add_to_pipe(nlp)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> resolve_coreferences(text):</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(text)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract coreference clusters</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    clusters <span class="op">=</span> []</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster <span class="kw">in</span> doc._.coref_clusters:</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        cluster_info <span class="op">=</span> {</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"main"</span>: cluster.main.text,</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mentions"</span>: [m.text <span class="cf">for</span> m <span class="kw">in</span> cluster.mentions],</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"positions"</span>: [(m.start_char, m.end_char) <span class="cf">for</span> m <span class="kw">in</span> cluster.mentions]</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        clusters.append(cluster_info)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create resolved text</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    resolved_text <span class="op">=</span> doc._.coref_resolved</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"clusters"</span>: clusters,</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"resolved_text"</span>: resolved_text</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Using Hugging Face transformers for coreference</strong>:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> pipeline</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load coreference resolution pipeline</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>coref <span class="op">=</span> pipeline(<span class="st">"coreference-resolution"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> resolve_coreferences_with_transformers(text):</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process text through coreference pipeline</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> coref(text)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract clusters from result</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    clusters <span class="op">=</span> []</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster_id, mentions <span class="kw">in</span> result[<span class="st">'clusters'</span>].items():</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        clusters.append({</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"id"</span>: cluster_id,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mentions"</span>: mentions</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"clusters"</span>: clusters,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"resolved_text"</span>: result[<span class="st">'resolved_text'</span>]</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Custom post-processing for knowledge graph integration</strong>:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> integrate_coreferences_into_kg(extracted_entities, coreference_clusters):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group entities by coreference cluster</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    entity_clusters <span class="op">=</span> {}</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> extracted_entities:</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find if this entity belongs to any coreference cluster</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cluster <span class="kw">in</span> coreference_clusters:</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>            entity_span <span class="op">=</span> (entity[<span class="st">"start"</span>], entity[<span class="st">"end"</span>])</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> entity_span <span class="kw">in</span> cluster[<span class="st">"positions"</span>]:</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                cluster_id <span class="op">=</span> cluster[<span class="st">"main"</span>]</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> cluster_id <span class="kw">not</span> <span class="kw">in</span> entity_clusters:</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                    entity_clusters[cluster_id] <span class="op">=</span> []</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>                entity_clusters[cluster_id].append(entity)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge entity information within each cluster</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    merged_entities <span class="op">=</span> []</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster_id, entities <span class="kw">in</span> entity_clusters.items():</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> entities:</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the most informative mention as base</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>        base_entity <span class="op">=</span> <span class="bu">max</span>(entities, key<span class="op">=</span><span class="kw">lambda</span> e: <span class="bu">len</span>(e.get(<span class="st">"attributes"</span>, {})))</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge attributes from all mentions</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        merged_attributes <span class="op">=</span> {}</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity <span class="kw">in</span> entities:</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>            merged_attributes.update(entity.get(<span class="st">"attributes"</span>, {}))</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create merged entity</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>        merged_entity <span class="op">=</span> {</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"id"</span>: base_entity[<span class="st">"id"</span>],</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"text"</span>: cluster_id,  <span class="co"># Use the main reference as the canonical text</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span>: base_entity[<span class="st">"type"</span>],</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"attributes"</span>: merged_attributes,</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mentions"</span>: [e[<span class="st">"text"</span>] <span class="cf">for</span> e <span class="kw">in</span> entities]</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>        merged_entities.append(merged_entity)</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add entities that weren't part of any cluster</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>    singleton_entities <span class="op">=</span> [</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>        e <span class="cf">for</span> e <span class="kw">in</span> extracted_entities</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(e <span class="kw">in</span> cluster <span class="cf">for</span> cluster <span class="kw">in</span> entity_clusters.values())</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged_entities <span class="op">+</span> singleton_entities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in coreference resolution for knowledge graphs include:</p>
<ol type="1">
<li><strong>Cross-document coreference</strong>: Identifying references to the same entity across multiple documents</li>
<li><strong>Multiple entity types</strong>: Handling different types of entities with appropriate resolution strategies</li>
<li><strong>Ambiguous references</strong>: Resolving expressions that could refer to multiple potential antecedents</li>
<li><strong>Zero anaphora</strong>: Handling cases where the referring expression is implicit or omitted</li>
<li><strong>Knowledge integration</strong>: Combining linguistic coreference with knowledge-based entity resolution</li>
</ol>
</section>
<section id="entity-linking-to-knowledge-bases" class="level3" data-number="6.4.2">
<h3 data-number="6.4.2" class="anchored" data-anchor-id="entity-linking-to-knowledge-bases"><span class="header-section-number">6.4.2</span> Entity linking to knowledge bases</h3>
<p>Entity linking connects mentions in text to entities in existing knowledge bases:</p>
<div id="def-entity-linking" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.14 (Entity linking)</strong></span> <strong>Entity linking</strong> (also called named entity disambiguation) is the process of connecting entity mentions in text to their corresponding entries in a knowledge base or ontology. This involves:</p>
<ol type="1">
<li>Identifying entity mentions in text</li>
<li>Generating candidate entities from the knowledge base</li>
<li>Disambiguating between candidates based on context</li>
<li>Ranking candidates and selecting the most appropriate match</li>
</ol>
<p>Entity linking provides standardized, unambiguous identifiers for entities, enabling integration with existing knowledge and cross-document entity resolution.</p>
</div>
<div id="exm-entity-linking" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.20 (Entity linking examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Person linking</strong>:</p>
<pre><code>Text mention: "Einstein developed the theory of relativity."

Linked entity:
- Knowledge base: DBpedia
- Entity ID: http://dbpedia.org/resource/Albert_Einstein
- Entity type: Scientist
- Confidence: 0.98</code></pre></li>
<li><p><strong>Location linking with ambiguity</strong>:</p>
<pre><code>Text mention: "Paris is known for its fashion industry."

Candidate entities:
- http://dbpedia.org/resource/Paris (city in France) - Selected (0.95 confidence)
- http://dbpedia.org/resource/Paris,_Texas (city in USA) - (0.03 confidence)
- http://dbpedia.org/resource/Paris_Hilton (person) - (0.01 confidence)</code></pre></li>
<li><p><strong>Organization linking with context</strong>:</p>
<pre><code>Text mention: "Apple reported record profits this quarter."

Context-based linking:
- With financial context: http://dbpedia.org/resource/Apple_Inc. (0.97 confidence)
- With agricultural context: http://dbpedia.org/resource/Apple (fruit) (0.92 confidence)</code></pre></li>
</ol>
</div>
<p>Entity linking approaches include:</p>
<ol type="1">
<li><p><strong>Knowledge-based approaches</strong>:</p>
<ul>
<li>Using entity descriptions, types, and relationships</li>
<li>Computing semantic similarity between mention context and entity descriptions</li>
<li>Leveraging knowledge graph structure for disambiguation</li>
<li>Advantages: Interpretable, works with limited training data</li>
<li>Disadvantages: Depends on knowledge base coverage and quality</li>
</ul></li>
<li><p><strong>Supervised learning approaches</strong>:</p>
<ul>
<li>Feature-based models using textual and knowledge-based features</li>
<li>Neural models using distributed representations</li>
<li>End-to-end models jointly performing NER and linking</li>
<li>Advantages: Better disambiguation performance</li>
<li>Disadvantages: Require substantial training data</li>
</ul></li>
<li><p><strong>Collective approaches</strong>:</p>
<ul>
<li>Joint disambiguation of multiple entities in a document</li>
<li>Leveraging entity relationships for coherent linking</li>
<li>Global optimization across mentions</li>
<li>Advantages: More coherent entity linking across a document</li>
<li>Disadvantages: Computationally more intensive</li>
</ul></li>
</ol>
<div id="exm-entity-linking-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.21 (Entity linking implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Simple entity linking with Wikipedia/DBpedia</strong>:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> wikipedia</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nltk.tokenize <span class="im">import</span> word_tokenize</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nltk.corpus <span class="im">import</span> stopwords</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>stop_words <span class="op">=</span> <span class="bu">set</span>(stopwords.words(<span class="st">'english'</span>))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> link_entity_to_wikipedia(entity_text, context_text):</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Generate candidate entities</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        search_results <span class="op">=</span> wikipedia.search(entity_text, results<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> search_results:</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    candidates <span class="op">=</span> []</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Get information about each candidate</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> title <span class="kw">in</span> search_results:</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get summary</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>            summary <span class="op">=</span> wikipedia.summary(title, sentences<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate context similarity</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># (simple bag-of-words approach)</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>            context_tokens <span class="op">=</span> [w.lower() <span class="cf">for</span> w <span class="kw">in</span> word_tokenize(context_text)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> w.lower() <span class="kw">not</span> <span class="kw">in</span> stop_words]</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>            summary_tokens <span class="op">=</span> [w.lower() <span class="cf">for</span> w <span class="kw">in</span> word_tokenize(summary)</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> w.lower() <span class="kw">not</span> <span class="kw">in</span> stop_words]</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>            context_counter <span class="op">=</span> Counter(context_tokens)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>            summary_counter <span class="op">=</span> Counter(summary_tokens)</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count overlapping terms</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>            overlap <span class="op">=</span> <span class="bu">sum</span>((context_counter <span class="op">&amp;</span> summary_counter).values())</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate similarity score</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>            similarity <span class="op">=</span> overlap <span class="op">/</span> (<span class="bu">len</span>(summary_tokens) <span class="op">+</span> <span class="fl">0.001</span>)</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get DBpedia URI</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>            dbpedia_uri <span class="op">=</span> <span class="ss">f"http://dbpedia.org/resource/</span><span class="sc">{</span>title<span class="sc">.</span>replace(<span class="st">' '</span>, <span class="st">'_'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>            candidates.append({</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">"title"</span>: title,</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">"uri"</span>: dbpedia_uri,</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>                <span class="st">"summary"</span>: summary,</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">"similarity"</span>: similarity</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Rank candidates and select the best match</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> candidates:</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>        best_candidate <span class="op">=</span> <span class="bu">max</span>(candidates, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"similarity"</span>])</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> best_candidate</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Using a pre-trained entity linking model</strong>:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> pipeline</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load entity linking pipeline</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>entity_linker <span class="op">=</span> pipeline(<span class="st">"entity_linking"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> link_entities_with_transformers(text):</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process text through entity linking pipeline</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    linked_entities <span class="op">=</span> entity_linker(text)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format results</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> linked_entities:</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"text"</span>: entity[<span class="st">"word"</span>],</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"start"</span>: entity[<span class="st">"start"</span>],</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"end"</span>: entity[<span class="st">"end"</span>],</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"uri"</span>: entity[<span class="st">"uri"</span>],</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"confidence"</span>: entity[<span class="st">"score"</span>]</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Collective entity linking</strong>:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> collective_entity_linking(entities, context_text, knowledge_graph):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Generate candidate entities for each mention</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    candidates_per_entity <span class="op">=</span> {}</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> entities:</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        candidates <span class="op">=</span> generate_candidates(entity[<span class="st">"text"</span>], knowledge_graph)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        candidates_per_entity[entity[<span class="st">"id"</span>]] <span class="op">=</span> candidates</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Calculate local context similarity for each candidate</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_id, candidates <span class="kw">in</span> candidates_per_entity.items():</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> candidate <span class="kw">in</span> candidates:</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>            candidate[<span class="st">"local_score"</span>] <span class="op">=</span> calculate_context_similarity(</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>                candidate[<span class="st">"description"</span>],</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>                get_local_context(context_text, entities, entity_id)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Calculate coherence among candidate combinations</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (simplified - real implementation would be more efficient)</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    best_configuration <span class="op">=</span> <span class="va">None</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>    best_score <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For small entity sets, brute force can work</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For larger sets, optimization algorithms would be needed</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> configuration <span class="kw">in</span> generate_configurations(candidates_per_entity):</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>        coherence_score <span class="op">=</span> calculate_coherence(configuration, knowledge_graph)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>        local_score <span class="op">=</span> <span class="bu">sum</span>(c[<span class="st">"local_score"</span>] <span class="cf">for</span> c <span class="kw">in</span> configuration.values())</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>        total_score <span class="op">=</span> local_score <span class="op">+</span> (coherence_score <span class="op">*</span> coherence_weight)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_score <span class="op">&gt;</span> best_score:</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>            best_score <span class="op">=</span> total_score</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>            best_configuration <span class="op">=</span> configuration</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Link each entity to its selected candidate</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_id, candidate <span class="kw">in</span> best_configuration.items():</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>        entity <span class="op">=</span> <span class="bu">next</span>(e <span class="cf">for</span> e <span class="kw">in</span> entities <span class="cf">if</span> e[<span class="st">"id"</span>] <span class="op">==</span> entity_id)</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"entity"</span>: entity,</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"linked_entity"</span>: candidate</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in entity linking for knowledge graphs include:</p>
<ol type="1">
<li><strong>Entity ambiguity</strong>: Resolving mentions that could refer to multiple entities</li>
<li><strong>Knowledge base coverage</strong>: Handling entities not present in the target knowledge base</li>
<li><strong>Limited context</strong>: Disambiguation with minimal surrounding context</li>
<li><strong>Domain-specific entities</strong>: Linking specialized entities in technical domains</li>
<li><strong>Emerging entities</strong>: Handling new entities not yet in knowledge bases</li>
</ol>
</section>
<section id="cross-source-entity-resolution" class="level3" data-number="6.4.3">
<h3 data-number="6.4.3" class="anchored" data-anchor-id="cross-source-entity-resolution"><span class="header-section-number">6.4.3</span> Cross-source entity resolution</h3>
<p>Cross-source entity resolution identifies the same entities across different data sources:</p>
<div id="def-entity-resolution" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.15 (Cross-source entity resolution)</strong></span> <strong>Cross-source entity resolution</strong> (also called record linkage or entity matching) identifies when records from different data sources refer to the same real-world entity. This process involves:</p>
<ol type="1">
<li>Identifying potential matches using blocking or filtering techniques</li>
<li>Comparing entity attributes using similarity functions</li>
<li>Making match/non-match decisions based on similarity scores</li>
<li>Merging information from matched entities</li>
</ol>
<p>Entity resolution is crucial when integrating data from multiple sources into a unified knowledge graph.</p>
</div>
<div id="exm-entity-resolution" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.22 (Entity resolution examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Person resolution across databases</strong>:</p>
<pre><code>Source 1: {id: "DB1_1234", name: "John Smith", email: "j.smith@example.com", title: "Senior Developer"}
Source 2: {id: "DB2_5678", name: "J. Smith", email: "j.smith@example.com", role: "Lead Programmer"}

Resolution: These records refer to the same person (match confidence: 0.95)
Merged entity: {
  id: "KG_P9876",
  source_ids: ["DB1_1234", "DB2_5678"],
  name: "John Smith",
  email: "j.smith@example.com",
  title: "Senior Developer",
  role: "Lead Programmer"
}</code></pre></li>
<li><p><strong>Organization resolution with conflicts</strong>:</p>
<pre><code>Source 1: {id: "SEC_123", name: "International Business Machines", ticker: "IBM", employees: 345000}
Source 2: {id: "WIKI_456", name: "IBM Corporation", founded: 1911, employees: 350000}

Resolution: These records refer to the same company (match confidence: 0.98)
Merged entity with conflict resolution: {
  id: "KG_O5432",
  source_ids: ["SEC_123", "WIKI_456"],
  name: "International Business Machines",
  aliases: ["IBM Corporation"],
  ticker: "IBM",
  founded: 1911,
  employees: 350000,  // Taking the more recent or higher value
  employee_sources: {
    "SEC_123": 345000,
    "WIKI_456": 350000
  }
}</code></pre></li>
<li><p><strong>Product resolution with missing information</strong>:</p>
<pre><code>Source 1: {id: "STORE_789", name: "iPhone 13", brand: "Apple", price: 799}
Source 2: {id: "REVIEW_321", name: "Apple iPhone 13 (2021)", color: "Blue", storage: "128GB"}

Resolution: These records refer to the same product (match confidence: 0.92)
Merged entity: {
  id: "KG_I7890",
  source_ids: ["STORE_789", "REVIEW_321"],
  name: "iPhone 13",
  full_name: "Apple iPhone 13 (2021)",
  brand: "Apple",
  price: 799,
  color: "Blue",
  storage: "128GB",
  year: 2021
}</code></pre></li>
</ol>
</div>
<p>Entity resolution approaches include:</p>
<ol type="1">
<li><p><strong>Rule-based approaches</strong>:</p>
<ul>
<li>Deterministic matching based on exact field matches</li>
<li>Business rules for determining match/non-match</li>
<li>Manual resolution of borderline cases</li>
<li>Advantages: Transparent, high precision</li>
<li>Disadvantages: Labor-intensive, limited recall</li>
</ul></li>
<li><p><strong>Similarity-based approaches</strong>:</p>
<ul>
<li>String similarity metrics (e.g., edit distance, Jaccard)</li>
<li>Phonetic similarity (e.g., Soundex, Metaphone)</li>
<li>Semantic similarity for textual fields</li>
<li>Advantages: Better handling of variations and errors</li>
<li>Disadvantages: Tuning similarity thresholds</li>
</ul></li>
<li><p><strong>Machine learning approaches</strong>:</p>
<ul>
<li>Supervised classification of match/non-match</li>
<li>Active learning with human feedback</li>
<li>Representation learning for entity embeddings</li>
<li>Advantages: Can learn complex matching patterns</li>
<li>Disadvantages: Requires training data</li>
</ul></li>
<li><p><strong>Graph-based approaches</strong>:</p>
<ul>
<li>Using relationship patterns for resolution</li>
<li>Propagating identity information through connections</li>
<li>Collective entity resolution across multiple entities</li>
<li>Advantages: Leverages structural information</li>
<li>Disadvantages: More complex, requires relationship data</li>
</ul></li>
</ol>
<div id="exm-resolution-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.23 (Entity resolution implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Similarity-based entity resolution</strong>:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> recordlinkage.preprocessing <span class="im">import</span> clean</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> recordlinkage.index <span class="im">import</span> Block</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> recordlinkage.compare <span class="im">import</span> Exact, String, Numeric</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> recordlinkage</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> resolve_entities(source1_df, source2_df):</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    source1_df[<span class="st">'name_clean'</span>] <span class="op">=</span> clean(source1_df[<span class="st">'name'</span>])</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    source2_df[<span class="st">'name_clean'</span>] <span class="op">=</span> clean(source2_df[<span class="st">'name'</span>])</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indexing/blocking - find potential matches</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    indexer <span class="op">=</span> Block(<span class="st">'name_clean'</span>, block_on<span class="op">=</span><span class="st">'first_char'</span>)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    pairs <span class="op">=</span> indexer.index(source1_df, source2_df)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Comparison - compute similarity features</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    compare <span class="op">=</span> recordlinkage.Compare()</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exact match on email</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    compare.add(Exact(<span class="st">'email'</span>, <span class="st">'email'</span>, label<span class="op">=</span><span class="st">'email'</span>))</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># String similarity on name</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    compare.add(String(<span class="st">'name'</span>, <span class="st">'name'</span>, label<span class="op">=</span><span class="st">'name'</span>, method<span class="op">=</span><span class="st">'jarowinkler'</span>))</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If other fields are present</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'phone'</span> <span class="kw">in</span> source1_df.columns <span class="kw">and</span> <span class="st">'phone'</span> <span class="kw">in</span> source2_df.columns:</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        compare.add(String(<span class="st">'phone'</span>, <span class="st">'phone'</span>, label<span class="op">=</span><span class="st">'phone'</span>, method<span class="op">=</span><span class="st">'levenshtein'</span>))</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'address'</span> <span class="kw">in</span> source1_df.columns <span class="kw">and</span> <span class="st">'address'</span> <span class="kw">in</span> source2_df.columns:</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>        compare.add(String(<span class="st">'address'</span>, <span class="st">'address'</span>, label<span class="op">=</span><span class="st">'address'</span>, method<span class="op">=</span><span class="st">'cosine'</span>))</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute similarity features</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> compare.compute(pairs, source1_df, source2_df)</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Classification - determine matches</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple threshold-based classification</span></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> features[features.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">&gt;</span> <span class="fl">1.5</span>]</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create merged entities</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    merged_entities <span class="op">=</span> []</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> matches.iterrows():</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>        source1_id, source2_id <span class="op">=</span> index</span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>        entity1 <span class="op">=</span> source1_df.loc[source1_id].to_dict()</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a>        entity2 <span class="op">=</span> source2_df.loc[source2_id].to_dict()</span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge the entities</span></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merge_entities(entity1, entity2)</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>        merged_entities.append(merged)</span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged_entities</span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_entities(entity1, entity2):</span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Merge two entities, handling conflicts and combining information"""</span></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> {}</span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate a new ID</span></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'id'</span>] <span class="op">=</span> <span class="ss">f"KG_</span><span class="sc">{</span><span class="bu">len</span>(merged)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'source_ids'</span>] <span class="op">=</span> [entity1.get(<span class="st">'id'</span>), entity2.get(<span class="st">'id'</span>)]</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge attributes with conflict resolution</span></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>    all_keys <span class="op">=</span> <span class="bu">set</span>(entity1.keys()).union(<span class="bu">set</span>(entity2.keys()))</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> all_keys:</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip metadata fields</span></span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> [<span class="st">'id'</span>, <span class="st">'source_ids'</span>, <span class="st">'name_clean'</span>]:</span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>        value1 <span class="op">=</span> entity1.get(key)</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a>        value2 <span class="op">=</span> entity2.get(key)</span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value1 <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> value2 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a>            merged[key] <span class="op">=</span> value2</span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> value1 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> value2 <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a>            merged[key] <span class="op">=</span> value1</span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> value1 <span class="op">==</span> value2:</span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a>            merged[key] <span class="op">=</span> value1</span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle conflicts</span></span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="op">==</span> <span class="st">'name'</span>:</span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Keep the longer name as primary, shorter as alias</span></span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(<span class="bu">str</span>(value1)) <span class="op">&gt;=</span> <span class="bu">len</span>(<span class="bu">str</span>(value2)):</span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a>                    merged[key] <span class="op">=</span> value1</span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a>                    merged.setdefault(<span class="st">'aliases'</span>, []).append(value2)</span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>                    merged[key] <span class="op">=</span> value2</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a>                    merged.setdefault(<span class="st">'aliases'</span>, []).append(value1)</span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> key <span class="kw">in</span> [<span class="st">'phone'</span>, <span class="st">'email'</span>]:</span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For contact info, keep a list of all values</span></span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a>                merged[key] <span class="op">=</span> [value <span class="cf">for</span> value <span class="kw">in</span> [value1, value2] <span class="cf">if</span> value]</span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">isinstance</span>(value1, (<span class="bu">int</span>, <span class="bu">float</span>)) <span class="kw">and</span> <span class="bu">isinstance</span>(value2, (<span class="bu">int</span>, <span class="bu">float</span>)):</span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For numeric values, take the maximum (or could average)</span></span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a>                merged[key] <span class="op">=</span> <span class="bu">max</span>(value1, value2)</span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Store original values for provenance</span></span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a>                merged[<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">_sources"</span>] <span class="op">=</span> {</span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a>                    entity1.get(<span class="st">'id'</span>, <span class="st">'source1'</span>): value1,</span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a>                    entity2.get(<span class="st">'id'</span>, <span class="st">'source2'</span>): value2</span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Default conflict resolution - keep both with source info</span></span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a>                merged[<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">_source1"</span>] <span class="op">=</span> value1</span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a>                merged[<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">_source2"</span>] <span class="op">=</span> value2</span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Machine learning-based entity resolution</strong>:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> recordlinkage.preprocessing <span class="im">import</span> clean</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> recordlinkage.index <span class="im">import</span> Block</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> recordlinkage.compare <span class="im">import</span> Exact, String, Numeric</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> recordlinkage</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ml_entity_resolution(source1_df, source2_df, training_matches):</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    source1_df[<span class="st">'name_clean'</span>] <span class="op">=</span> clean(source1_df[<span class="st">'name'</span>])</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    source2_df[<span class="st">'name_clean'</span>] <span class="op">=</span> clean(source2_df[<span class="st">'name'</span>])</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indexing/blocking - find potential matches</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    indexer <span class="op">=</span> Block(<span class="st">'name_clean'</span>, block_on<span class="op">=</span><span class="st">'first_char'</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    pairs <span class="op">=</span> indexer.index(source1_df, source2_df)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Comparison - compute similarity features</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    compare <span class="op">=</span> recordlinkage.Compare()</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add comparison methods for each field</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    compare.add(String(<span class="st">'name'</span>, <span class="st">'name'</span>, method<span class="op">=</span><span class="st">'jarowinkler'</span>))</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    compare.add(String(<span class="st">'name'</span>, <span class="st">'name'</span>, method<span class="op">=</span><span class="st">'levenshtein'</span>))</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    compare.add(Exact(<span class="st">'email'</span>, <span class="st">'email'</span>))</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add more comparisons for other fields</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'phone'</span> <span class="kw">in</span> source1_df.columns <span class="kw">and</span> <span class="st">'phone'</span> <span class="kw">in</span> source2_df.columns:</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>        compare.add(String(<span class="st">'phone'</span>, <span class="st">'phone'</span>, method<span class="op">=</span><span class="st">'levenshtein'</span>))</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute similarity features</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> compare.compute(pairs, source1_df, source2_df)</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a training dataset from known matches</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>    train_indices <span class="op">=</span> []</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> source1_id, source2_id <span class="kw">in</span> training_matches:</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (source1_id, source2_id) <span class="kw">in</span> features.index:</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>            train_indices.append((source1_id, source2_id))</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create training data</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    train_features <span class="op">=</span> features.loc[train_indices]</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    train_labels <span class="op">=</span> [<span class="dv">1</span>] <span class="op">*</span> <span class="bu">len</span>(train_indices)  <span class="co"># 1 for match</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add negative examples (non-matches)</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>    non_matches <span class="op">=</span> [(idx1, idx2) <span class="cf">for</span> idx1, idx2 <span class="kw">in</span> features.index</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">if</span> (idx1, idx2) <span class="kw">not</span> <span class="kw">in</span> train_indices]</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample a subset of non-matches (to balance dataset)</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> random</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>    sampled_non_matches <span class="op">=</span> random.sample(non_matches, <span class="bu">min</span>(<span class="bu">len</span>(train_indices), <span class="bu">len</span>(non_matches)))</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>    train_features <span class="op">=</span> pd.concat([train_features, features.loc[sampled_non_matches]])</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>    train_labels.extend([<span class="dv">0</span>] <span class="op">*</span> <span class="bu">len</span>(sampled_non_matches))</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train a classifier</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>    clf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>    clf.fit(train_features.values, train_labels)</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict matches</span></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>    match_probabilities <span class="op">=</span> clf.predict_proba(features.values)[:,<span class="dv">1</span>]</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>    matches_index <span class="op">=</span> features.index[match_probabilities <span class="op">&gt;=</span> <span class="fl">0.7</span>]  <span class="co"># Threshold</span></span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create merged entities</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>    merged_entities <span class="op">=</span> []</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> source1_id, source2_id <span class="kw">in</span> matches_index:</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>        entity1 <span class="op">=</span> source1_df.loc[source1_id].to_dict()</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>        entity2 <span class="op">=</span> source2_df.loc[source2_id].to_dict()</span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>        confidence <span class="op">=</span> match_probabilities[features.index.get_loc((source1_id, source2_id))]</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge the entities</span></span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merge_entities(entity1, entity2)</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'match_confidence'</span>] <span class="op">=</span> confidence</span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>        merged_entities.append(merged)</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged_entities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Graph-based collective entity resolution</strong>:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> collective_entity_resolution(entities_df, relationships_df):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Entity resolution that leverages relationship information</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">    entities_df: DataFrame with entity attributes</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">    relationships_df: DataFrame with relationships between entities</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Initial similarity-based matching</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (using techniques from previous examples)</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    initial_matches <span class="op">=</span> initial_similarity_matching(entities_df)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Build entity-relationship graph</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> build_relationship_graph(entities_df, relationships_df)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Iterative collective resolution</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    all_matches <span class="op">=</span> <span class="bu">set</span>(initial_matches)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    previous_size <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">len</span>(all_matches) <span class="op">&gt;</span> previous_size:</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>        previous_size <span class="op">=</span> <span class="bu">len</span>(all_matches)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each potential match pair not yet decided</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity1_id, entity2_id <span class="kw">in</span> get_candidate_pairs(entities_df):</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (entity1_id, entity2_id) <span class="kw">in</span> all_matches:</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get relationship neighborhood for both entities</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>            neighbors1 <span class="op">=</span> get_neighborhood(G, entity1_id)</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>            neighbors2 <span class="op">=</span> get_neighborhood(G, entity2_id)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count how many neighbors are matched to each other</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>            matched_neighbors <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> n1 <span class="kw">in</span> neighbors1:</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> n2 <span class="kw">in</span> neighbors2:</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> (n1, n2) <span class="kw">in</span> all_matches <span class="kw">or</span> (n2, n1) <span class="kw">in</span> all_matches:</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>                        matched_neighbors <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate attribute similarity</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>            attr_sim <span class="op">=</span> calculate_similarity(</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>                entities_df.loc[entity1_id],</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>                entities_df.loc[entity2_id]</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Combined similarity score</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>            rel_factor <span class="op">=</span> matched_neighbors <span class="op">/</span> (<span class="bu">len</span>(neighbors1) <span class="op">+</span> <span class="bu">len</span>(neighbors2) <span class="op">+</span> <span class="fl">0.1</span>)</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>            combined_score <span class="op">=</span> (attr_sim <span class="op">+</span> rel_factor) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If score is high enough, consider it a match</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> combined_score <span class="op">&gt;=</span> <span class="fl">0.8</span>:</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>                all_matches.add((entity1_id, entity2_id))</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Create merged entities</span></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>    merged_entities <span class="op">=</span> []</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity1_id, entity2_id <span class="kw">in</span> all_matches:</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>        entity1 <span class="op">=</span> entities_df.loc[entity1_id].to_dict()</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>        entity2 <span class="op">=</span> entities_df.loc[entity2_id].to_dict()</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> merge_entities(entity1, entity2)</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>        merged_entities.append(merged)</span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged_entities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in cross-source entity resolution include:</p>
<ol type="1">
<li><strong>Scalability</strong>: Efficiently comparing large numbers of entities</li>
<li><strong>Missing data</strong>: Resolving entities with incomplete information</li>
<li><strong>Conflicting information</strong>: Handling inconsistencies across sources</li>
<li><strong>Evolving entities</strong>: Entities that change over time across sources</li>
<li><strong>Privacy concerns</strong>: Resolving entities while respecting privacy regulations</li>
</ol>
</section>
<section id="identity-management-and-entity-reconciliation" class="level3" data-number="6.4.4">
<h3 data-number="6.4.4" class="anchored" data-anchor-id="identity-management-and-entity-reconciliation"><span class="header-section-number">6.4.4</span> Identity management and entity reconciliation</h3>
<p>Identity management and entity reconciliation establish and maintain consistent entity identities across the knowledge graph:</p>
<div id="def-identity-management" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.16 (Identity management and reconciliation)</strong></span> <strong>Identity management</strong> in knowledge graphs involves creating and maintaining a consistent system for:</p>
<ol type="1">
<li>Assigning unique identifiers to entities</li>
<li>Managing entity lifecycles as information evolves</li>
<li>Tracking identity mappings across sources</li>
<li>Resolving conflicts in entity information</li>
</ol>
<p><strong>Entity reconciliation</strong> is the ongoing process of:</p>
<ol type="1">
<li>Merging information from different sources into coherent entity profiles</li>
<li>Maintaining provenance for entity attributes</li>
<li>Versioning entity information over time</li>
<li>Establishing confidence levels for entity information</li>
</ol>
</div>
<div id="exm-identity-management" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.24 (Identity management examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Entity identifier system</strong>:</p>
<pre><code>Local ID:
- Source 1: source1:person:12345 (internal database ID)
- Source 2: source2:employee:E7890 (HR system ID)
- Source 3: source3:author:smith_j (publication system ID)

Global ID:
- Knowledge Graph ID: kg:person:P58742
- External IDs: orcid:0000-0002-1825-0097, wikidata:Q12345

ID mappings:
{
  "kg:person:P58742": {
    "local_ids": [
      "source1:person:12345",
      "source2:employee:E7890",
      "source3:author:smith_j"
    ],
    "external_ids": [
      "orcid:0000-0002-1825-0097",
      "wikidata:Q12345"
    ]
  }
}</code></pre></li>
<li><p><strong>Entity versioning and temporal tracking</strong>:</p>
<pre><code>Entity: kg:company:C24680

Version history:
{
  "2022-01-15": {
    "name": "TechCorp Inc.",
    "headquarters": "Seattle, WA",
    "employees": 1250,
    "ceo": "kg:person:P12345"
  },
  "2022-06-30": {
    "name": "TechCorp Inc.",
    "headquarters": "Austin, TX",  // Changed headquarters
    "employees": 1350,
    "ceo": "kg:person:P12345"
  },
  "2023-02-10": {
    "name": "TechCorp Inc.",
    "headquarters": "Austin, TX",
    "employees": 1520,
    "ceo": "kg:person:P67890"  // New CEO
  }
}</code></pre></li>
<li><p><strong>Attribute-level provenance and confidence</strong>:</p>
<pre><code>Entity: kg:medication:M36912

Attributes with provenance:
{
  "name": {
    "value": "Acetylsalicylic Acid",
    "sources": [
      {"id": "source1:drug:D123", "confidence": 1.0},
      {"id": "source2:med:M456", "confidence": 1.0}
    ]
  },
  "common_name": {
    "value": "Aspirin",
    "sources": [
      {"id": "source1:drug:D123", "confidence": 1.0},
      {"id": "source3:wiki:aspirin", "confidence": 1.0}
    ]
  },
  "side_effects": {
    "value": ["Stomach irritation", "Nausea", "Ringing in ears"],
    "sources": [
      {"id": "source1:drug:D123", "confidence": 0.9},
      {"id": "source4:clinical:C789", "confidence": 0.95}
    ]
  },
  "recommended_dosage": {
    "value": "75-325 mg daily",
    "sources": [
      {"id": "source1:drug:D123", "confidence": 0.85},
      {"id": "source4:clinical:C789", "confidence": 0.9}
    ],
    "conflicts": [
      {"source": "source5:alternative:A101", "value": "50-100 mg daily"}
    ]
  }
}</code></pre></li>
</ol>
</div>
<p>Key aspects of implementing identity management include:</p>
<ol type="1">
<li><p><strong>Global identifier system</strong>:</p>
<ul>
<li>Persistent, unique IDs independent of source systems</li>
<li>URI-based identifiers for web compatibility</li>
<li>Namespacing to organize entity types</li>
<li>Mappings to external identifier systems</li>
</ul></li>
<li><p><strong>Provenance tracking</strong>:</p>
<ul>
<li>Source attribution for all information</li>
<li>Confidence scoring for attributes</li>
<li>Timestamping for temporal tracking</li>
<li>Conflict documentation for disagreements</li>
</ul></li>
<li><p><strong>Entity merging policies</strong>:</p>
<ul>
<li>Rules for combining information from different sources</li>
<li>Strategies for handling conflicting information</li>
<li>Thresholds for establishing entity identity</li>
<li>Versioning policies for temporal changes</li>
</ul></li>
<li><p><strong>Governance processes</strong>:</p>
<ul>
<li>Workflows for manual resolution of ambiguous cases</li>
<li>Quality control procedures for entity information</li>
<li>Access control for identity management functions</li>
<li>Audit trails for identity decisions</li>
</ul></li>
</ol>
<div id="exm-identity-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.25 (Identity management implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Global identifier service</strong>:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EntityIdentityService:</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, db_connection):</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db <span class="op">=</span> db_connection</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.namespace_prefix <span class="op">=</span> <span class="st">"kg:"</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_entity_id(<span class="va">self</span>, entity_type):</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate a new global entity ID"""</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a type-specific prefix</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        type_prefix <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>namespace_prefix<span class="sc">}{</span>entity_type<span class="sc">}</span><span class="ss">:"</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate a unique identifier</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        unique_part <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4()).replace(<span class="st">'-'</span>, <span class="st">''</span>)[:<span class="dv">8</span>].upper()</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine to create the full ID</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>        entity_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>type_prefix<span class="sc">}{</span>unique_part<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> entity_id</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> register_entity(<span class="va">self</span>, entity_type, source_id, attributes):</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Register a new entity or update an existing one"""</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if this source_id is already mapped to a global ID</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>        existing_mapping <span class="op">=</span> <span class="va">self</span>.lookup_by_source_id(source_id)</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> existing_mapping:</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Entity already exists, update attributes</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>            global_id <span class="op">=</span> existing_mapping[<span class="st">"global_id"</span>]</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.update_entity_attributes(global_id, source_id, attributes)</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> global_id</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create new entity</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>            global_id <span class="op">=</span> <span class="va">self</span>.generate_entity_id(entity_type)</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create initial mapping</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>            mapping <span class="op">=</span> {</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"global_id"</span>: global_id,</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">"entity_type"</span>: entity_type,</span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">"local_ids"</span>: [source_id],</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">"external_ids"</span>: [],</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">"created_at"</span>: datetime.datetime.utcnow().isoformat(),</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">"last_updated"</span>: datetime.datetime.utcnow().isoformat()</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store the mapping</span></span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.db.store_identity_mapping(global_id, mapping)</span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store initial attributes</span></span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.update_entity_attributes(global_id, source_id, attributes)</span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> global_id</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> merge_entities(<span class="va">self</span>, global_id1, global_id2):</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Merge two entities that are determined to be the same"""</span></span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the current mappings</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>        mapping1 <span class="op">=</span> <span class="va">self</span>.lookup_by_global_id(global_id1)</span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>        mapping2 <span class="op">=</span> <span class="va">self</span>.lookup_by_global_id(global_id2)</span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> mapping1 <span class="kw">or</span> <span class="kw">not</span> mapping2:</span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"One or both entities not found"</span>)</span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create merged mapping</span></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>        merged_mapping <span class="op">=</span> {</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">"global_id"</span>: global_id1,  <span class="co"># Keep the first ID as the canonical ID</span></span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">"entity_type"</span>: mapping1[<span class="st">"entity_type"</span>],</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"local_ids"</span>: <span class="bu">list</span>(<span class="bu">set</span>(mapping1[<span class="st">"local_ids"</span>] <span class="op">+</span> mapping2[<span class="st">"local_ids"</span>])),</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"external_ids"</span>: <span class="bu">list</span>(<span class="bu">set</span>(mapping1[<span class="st">"external_ids"</span>] <span class="op">+</span> mapping2[<span class="st">"external_ids"</span>])),</span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">"created_at"</span>: <span class="bu">min</span>(mapping1[<span class="st">"created_at"</span>], mapping2[<span class="st">"created_at"</span>]),</span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"last_updated"</span>: datetime.datetime.utcnow().isoformat(),</span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"merged_from"</span>: [global_id1, global_id2]</span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store the merged mapping</span></span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db.store_identity_mapping(global_id1, merged_mapping)</span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create redirect for the second ID</span></span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>        redirect_mapping <span class="op">=</span> {</span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">"global_id"</span>: global_id2,</span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"redirect_to"</span>: global_id1,</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"last_updated"</span>: datetime.datetime.utcnow().isoformat()</span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db.store_identity_mapping(global_id2, redirect_mapping)</span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge attributes</span></span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.merge_entity_attributes(global_id1, global_id2)</span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> global_id1</span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> lookup_by_source_id(<span class="va">self</span>, source_id):</span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Find global ID by source ID"""</span></span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.db.find_mapping_by_source_id(source_id)</span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> lookup_by_global_id(<span class="va">self</span>, global_id):</span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get mapping by global ID"""</span></span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a>        mapping <span class="op">=</span> <span class="va">self</span>.db.get_identity_mapping(global_id)</span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Follow redirects if present</span></span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mapping <span class="kw">and</span> <span class="st">"redirect_to"</span> <span class="kw">in</span> mapping:</span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.lookup_by_global_id(mapping[<span class="st">"redirect_to"</span>])</span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mapping</span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_entity_attributes(<span class="va">self</span>, global_id, source_id, attributes):</span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Update entity attributes with provenance"""</span></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current attributes</span></span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a>        current_attributes <span class="op">=</span> <span class="va">self</span>.db.get_entity_attributes(global_id) <span class="kw">or</span> {}</span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update each attribute with provenance</span></span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a>        timestamp <span class="op">=</span> datetime.datetime.utcnow().isoformat()</span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> attributes.items():</span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> current_attributes:</span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a>                <span class="co"># New attribute</span></span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a>                current_attributes[key] <span class="op">=</span> {</span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"value"</span>: value,</span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"sources"</span>: [</span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">"id"</span>: source_id, <span class="st">"timestamp"</span>: timestamp, <span class="st">"confidence"</span>: <span class="fl">1.0</span>}</span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update existing attribute</span></span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a>                current_value <span class="op">=</span> current_attributes[key][<span class="st">"value"</span>]</span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a>                current_sources <span class="op">=</span> current_attributes[key][<span class="st">"sources"</span>]</span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check if this source already provided this attribute</span></span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a>                source_exists <span class="op">=</span> <span class="va">False</span></span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> source <span class="kw">in</span> current_sources:</span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> source[<span class="st">"id"</span>] <span class="op">==</span> source_id:</span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a>                        source[<span class="st">"timestamp"</span>] <span class="op">=</span> timestamp</span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a>                        source_exists <span class="op">=</span> <span class="va">True</span></span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> source_exists:</span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a>                    current_sources.append({</span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"id"</span>: source_id,</span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"timestamp"</span>: timestamp,</span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"confidence"</span>: <span class="fl">1.0</span></span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle conflicts</span></span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> value <span class="op">!=</span> current_value:</span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Different value - use conflict resolution policy</span></span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a>                    resolved_value, conflicts <span class="op">=</span> <span class="va">self</span>.resolve_attribute_conflict(</span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a>                        key, current_value, value, current_sources</span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a>                    current_attributes[key][<span class="st">"value"</span>] <span class="op">=</span> resolved_value</span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> conflicts:</span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a>                        current_attributes[key][<span class="st">"conflicts"</span>] <span class="op">=</span> conflicts</span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store updated attributes</span></span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db.store_entity_attributes(global_id, current_attributes)</span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> resolve_attribute_conflict(<span class="va">self</span>, attribute_key, current_value, new_value, sources):</span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Implement conflict resolution policies"""</span></span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Different policies depending on attribute type</span></span>
<span id="cb61-159"><a href="#cb61-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> attribute_key <span class="kw">in</span> [<span class="st">"name"</span>, <span class="st">"title"</span>, <span class="st">"id"</span>]:</span>
<span id="cb61-160"><a href="#cb61-160" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For identifiers, prefer the value with most sources</span></span>
<span id="cb61-161"><a href="#cb61-161" aria-hidden="true" tabindex="-1"></a>            current_sources <span class="op">=</span> [s <span class="cf">for</span> s <span class="kw">in</span> sources <span class="cf">if</span> s.get(<span class="st">"value"</span>, current_value) <span class="op">==</span> current_value]</span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a>            new_sources <span class="op">=</span> [s <span class="cf">for</span> s <span class="kw">in</span> sources <span class="cf">if</span> s.get(<span class="st">"value"</span>, <span class="va">None</span>) <span class="op">==</span> new_value]</span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(current_sources) <span class="op">&gt;=</span> <span class="bu">len</span>(new_sources):</span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> current_value, [{<span class="st">"value"</span>: new_value, <span class="st">"sources"</span>: new_sources}]</span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> new_value, [{<span class="st">"value"</span>: current_value, <span class="st">"sources"</span>: current_sources}]</span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> attribute_key <span class="kw">in</span> [<span class="st">"population"</span>, <span class="st">"revenue"</span>, <span class="st">"count"</span>]:</span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For numeric values, prefer the most recent</span></span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a>            most_recent_source <span class="op">=</span> <span class="bu">max</span>(sources, key<span class="op">=</span><span class="kw">lambda</span> s: s[<span class="st">"timestamp"</span>])</span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a>            most_recent_value <span class="op">=</span> most_recent_source.get(<span class="st">"value"</span>, current_value)</span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> most_recent_value <span class="op">==</span> current_value:</span>
<span id="cb61-175"><a href="#cb61-175" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> current_value, [{<span class="st">"value"</span>: new_value, <span class="st">"reason"</span>: <span class="st">"older"</span>}]</span>
<span id="cb61-176"><a href="#cb61-176" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> new_value, [{<span class="st">"value"</span>: current_value, <span class="st">"reason"</span>: <span class="st">"older"</span>}]</span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Default policy: keep lists of values</span></span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(current_value, <span class="bu">list</span>):</span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(new_value, <span class="bu">list</span>):</span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a>                    combined <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(current_value <span class="op">+</span> new_value))</span>
<span id="cb61-184"><a href="#cb61-184" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> combined, []</span>
<span id="cb61-185"><a href="#cb61-185" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> new_value <span class="kw">not</span> <span class="kw">in</span> current_value:</span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a>                        current_value.append(new_value)</span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> current_value, []</span>
<span id="cb61-189"><a href="#cb61-189" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb61-190"><a href="#cb61-190" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Convert to list if values differ</span></span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> current_value <span class="op">!=</span> new_value:</span>
<span id="cb61-192"><a href="#cb61-192" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> [current_value, new_value], []</span>
<span id="cb61-193"><a href="#cb61-193" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> current_value, []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Entity versioning and temporal tracking</strong>:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EntityVersionService:</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, db_connection):</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db <span class="op">=</span> db_connection</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_version(<span class="va">self</span>, entity_id, attributes, timestamp<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create a new version of an entity"""</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use current time if no timestamp provided</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> timestamp <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>            timestamp <span class="op">=</span> datetime.datetime.utcnow().isoformat()</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get existing versions</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>        versions <span class="op">=</span> <span class="va">self</span>.get_all_versions(entity_id)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create new version</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        new_version <span class="op">=</span> {</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"timestamp"</span>: timestamp,</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"attributes"</span>: attributes,</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"created_at"</span>: datetime.datetime.utcnow().isoformat()</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store the new version</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db.store_entity_version(entity_id, timestamp, new_version)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> new_version</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_all_versions(<span class="va">self</span>, entity_id):</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get all versions of an entity, ordered by timestamp"""</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        versions <span class="op">=</span> <span class="va">self</span>.db.get_entity_versions(entity_id)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sorted</span>(versions, key<span class="op">=</span><span class="kw">lambda</span> v: v[<span class="st">"timestamp"</span>])</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_version_at(<span class="va">self</span>, entity_id, timestamp):</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get entity state at specific timestamp"""</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>        versions <span class="op">=</span> <span class="va">self</span>.get_all_versions(entity_id)</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the version active at the given timestamp</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>        active_version <span class="op">=</span> <span class="va">None</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> version <span class="kw">in</span> versions:</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> version[<span class="st">"timestamp"</span>] <span class="op">&lt;=</span> timestamp:</span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>                active_version <span class="op">=</span> version</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> active_version</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> diff_versions(<span class="va">self</span>, entity_id, timestamp1, timestamp2):</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Compare entity state between two timestamps"""</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>        v1 <span class="op">=</span> <span class="va">self</span>.get_version_at(entity_id, timestamp1)</span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>        v2 <span class="op">=</span> <span class="va">self</span>.get_version_at(entity_id, timestamp2)</span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> v1 <span class="kw">or</span> <span class="kw">not</span> v2:</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compare attributes</span></span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>        changes <span class="op">=</span> {}</span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find modified attributes</span></span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>        all_keys <span class="op">=</span> <span class="bu">set</span>(v1[<span class="st">"attributes"</span>].keys()).union(<span class="bu">set</span>(v2[<span class="st">"attributes"</span>].keys()))</span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> all_keys:</span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a>            v1_value <span class="op">=</span> v1[<span class="st">"attributes"</span>].get(key)</span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a>            v2_value <span class="op">=</span> v2[<span class="st">"attributes"</span>].get(key)</span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> v1_value <span class="op">!=</span> v2_value:</span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a>                changes[key] <span class="op">=</span> {</span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"from"</span>: v1_value,</span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"to"</span>: v2_value</span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-70"><a href="#cb62-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> changes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Entity reconciliation service</strong>:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EntityReconciliationService:</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, identity_service, db_connection):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.identity_service <span class="op">=</span> identity_service</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db <span class="op">=</span> db_connection</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reconcile_entity(<span class="va">self</span>, entity_data, source_id, confidence_threshold<span class="op">=</span><span class="fl">0.8</span>):</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Reconcile an entity from a source against the knowledge graph</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 1: Extract key attributes for matching</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        match_attributes <span class="op">=</span> <span class="va">self</span>.extract_match_attributes(entity_data)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 2: Search for potential matches</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>        candidate_matches <span class="op">=</span> <span class="va">self</span>.find_candidate_matches(match_attributes)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 3: Calculate similarity scores</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>        scored_matches <span class="op">=</span> []</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> candidate <span class="kw">in</span> candidate_matches:</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>            similarity <span class="op">=</span> <span class="va">self</span>.calculate_similarity(match_attributes, candidate[<span class="st">"attributes"</span>])</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>            scored_matches.append({</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">"global_id"</span>: candidate[<span class="st">"global_id"</span>],</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"similarity"</span>: similarity,</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"attributes"</span>: candidate[<span class="st">"attributes"</span>]</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 4: Select best match or create new entity</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>        scored_matches.sort(key<span class="op">=</span><span class="kw">lambda</span> m: m[<span class="st">"similarity"</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scored_matches <span class="kw">and</span> scored_matches[<span class="dv">0</span>][<span class="st">"similarity"</span>] <span class="op">&gt;=</span> confidence_threshold:</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Match found - update existing entity</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>            best_match <span class="op">=</span> scored_matches[<span class="dv">0</span>]</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>            global_id <span class="op">=</span> best_match[<span class="st">"global_id"</span>]</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update the entity with new data</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.identity_service.update_entity_attributes(</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>                global_id, source_id, entity_data</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">"global_id"</span>: global_id,</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">"action"</span>: <span class="st">"updated"</span>,</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">"similarity"</span>: best_match[<span class="st">"similarity"</span>]</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># No good match - create new entity</span></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>            entity_type <span class="op">=</span> <span class="va">self</span>.determine_entity_type(entity_data)</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>            global_id <span class="op">=</span> <span class="va">self</span>.identity_service.register_entity(</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>                entity_type, source_id, entity_data</span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">"global_id"</span>: global_id,</span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">"action"</span>: <span class="st">"created"</span>,</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">"similarity"</span>: <span class="fl">0.0</span></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_match_attributes(<span class="va">self</span>, entity_data):</span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Extract key attributes used for matching"""</span></span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>        match_attributes <span class="op">=</span> {}</span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prioritize identifying attributes</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"id"</span> <span class="kw">in</span> entity_data:</span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>            match_attributes[<span class="st">"id"</span>] <span class="op">=</span> entity_data[<span class="st">"id"</span>]</span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"name"</span> <span class="kw">in</span> entity_data:</span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>            match_attributes[<span class="st">"name"</span>] <span class="op">=</span> entity_data[<span class="st">"name"</span>]</span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Include other potential matching attributes</span></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> [<span class="st">"email"</span>, <span class="st">"date_of_birth"</span>, <span class="st">"phone"</span>, <span class="st">"address"</span>]:</span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">in</span> entity_data:</span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>                match_attributes[key] <span class="op">=</span> entity_data[key]</span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> match_attributes</span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find_candidate_matches(<span class="va">self</span>, match_attributes):</span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Find potential matching entities based on key attributes"""</span></span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>        candidates <span class="op">=</span> []</span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try exact matches on strong identifiers</span></span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> [<span class="st">"id"</span>, <span class="st">"email"</span>]:</span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">in</span> match_attributes:</span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>                exact_matches <span class="op">=</span> <span class="va">self</span>.db.find_entities_by_attribute(</span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a>                    key, match_attributes[key]</span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a>                candidates.extend(exact_matches)</span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try fuzzy matches on names</span></span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"name"</span> <span class="kw">in</span> match_attributes <span class="kw">and</span> <span class="bu">len</span>(candidates) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a>            name_matches <span class="op">=</span> <span class="va">self</span>.db.find_entities_by_name_similarity(</span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a>                match_attributes[<span class="st">"name"</span>]</span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add only new candidates</span></span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a>            existing_ids <span class="op">=</span> {c[<span class="st">"global_id"</span>] <span class="cf">for</span> c <span class="kw">in</span> candidates}</span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a>            candidates.extend([</span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a>                c <span class="cf">for</span> c <span class="kw">in</span> name_matches <span class="cf">if</span> c[<span class="st">"global_id"</span>] <span class="kw">not</span> <span class="kw">in</span> existing_ids</span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> candidates</span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_similarity(<span class="va">self</span>, attributes1, attributes2):</span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate similarity between two sets of entity attributes"""</span></span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implement similarity calculation logic</span></span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This could use string similarity for names, exact matching for emails,</span></span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># specialized comparisons for addresses, etc.</span></span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample implementation (simplified)</span></span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a>        total_weight <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a>        weighted_sum <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define weights for different attributes</span></span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> {</span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">"id"</span>: <span class="fl">1.0</span>,</span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">"email"</span>: <span class="fl">0.9</span>,</span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a>            <span class="st">"name"</span>: <span class="fl">0.8</span>,</span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a>            <span class="st">"date_of_birth"</span>: <span class="fl">0.7</span>,</span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a>            <span class="st">"phone"</span>: <span class="fl">0.6</span>,</span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a>            <span class="st">"address"</span>: <span class="fl">0.5</span></span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, weight <span class="kw">in</span> weights.items():</span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">in</span> attributes1 <span class="kw">and</span> key <span class="kw">in</span> attributes2:</span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a>                value1 <span class="op">=</span> attributes1[key]</span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a>                value2 <span class="op">=</span> attributes2[key]</span>
<span id="cb63-125"><a href="#cb63-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-126"><a href="#cb63-126" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key <span class="kw">in</span> [<span class="st">"id"</span>, <span class="st">"email"</span>]:</span>
<span id="cb63-127"><a href="#cb63-127" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Exact match for identifiers</span></span>
<span id="cb63-128"><a href="#cb63-128" aria-hidden="true" tabindex="-1"></a>                    sim <span class="op">=</span> <span class="fl">1.0</span> <span class="cf">if</span> value1 <span class="op">==</span> value2 <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb63-129"><a href="#cb63-129" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"name"</span>:</span>
<span id="cb63-130"><a href="#cb63-130" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># String similarity for names</span></span>
<span id="cb63-131"><a href="#cb63-131" aria-hidden="true" tabindex="-1"></a>                    sim <span class="op">=</span> <span class="va">self</span>.string_similarity(value1, value2)</span>
<span id="cb63-132"><a href="#cb63-132" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> key <span class="op">==</span> <span class="st">"date_of_birth"</span>:</span>
<span id="cb63-133"><a href="#cb63-133" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Exact match for dates</span></span>
<span id="cb63-134"><a href="#cb63-134" aria-hidden="true" tabindex="-1"></a>                    sim <span class="op">=</span> <span class="fl">1.0</span> <span class="cf">if</span> value1 <span class="op">==</span> value2 <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb63-135"><a href="#cb63-135" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb63-136"><a href="#cb63-136" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Default string similarity</span></span>
<span id="cb63-137"><a href="#cb63-137" aria-hidden="true" tabindex="-1"></a>                    sim <span class="op">=</span> <span class="va">self</span>.string_similarity(<span class="bu">str</span>(value1), <span class="bu">str</span>(value2))</span>
<span id="cb63-138"><a href="#cb63-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-139"><a href="#cb63-139" aria-hidden="true" tabindex="-1"></a>                weighted_sum <span class="op">+=</span> sim <span class="op">*</span> weight</span>
<span id="cb63-140"><a href="#cb63-140" aria-hidden="true" tabindex="-1"></a>                total_weight <span class="op">+=</span> weight</span>
<span id="cb63-141"><a href="#cb63-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-142"><a href="#cb63-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_weight <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb63-143"><a href="#cb63-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb63-144"><a href="#cb63-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-145"><a href="#cb63-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weighted_sum <span class="op">/</span> total_weight</span>
<span id="cb63-146"><a href="#cb63-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-147"><a href="#cb63-147" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> string_similarity(<span class="va">self</span>, s1, s2):</span>
<span id="cb63-148"><a href="#cb63-148" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate string similarity (e.g., Jaro-Winkler)"""</span></span>
<span id="cb63-149"><a href="#cb63-149" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implement string similarity algorithm</span></span>
<span id="cb63-150"><a href="#cb63-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This is a placeholder - would use an actual implementation</span></span>
<span id="cb63-151"><a href="#cb63-151" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> textdistance <span class="im">import</span> jaro_winkler</span>
<span id="cb63-152"><a href="#cb63-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> jaro_winkler.normalized_similarity(s1, s2)</span>
<span id="cb63-153"><a href="#cb63-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-154"><a href="#cb63-154" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> determine_entity_type(<span class="va">self</span>, entity_data):</span>
<span id="cb63-155"><a href="#cb63-155" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Determine the entity type based on available attributes"""</span></span>
<span id="cb63-156"><a href="#cb63-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Implement logic to infer entity type</span></span>
<span id="cb63-157"><a href="#cb63-157" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This could be based on the presence of certain attributes,</span></span>
<span id="cb63-158"><a href="#cb63-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># or an explicit type field in the data</span></span>
<span id="cb63-159"><a href="#cb63-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-160"><a href="#cb63-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"company_name"</span> <span class="kw">in</span> entity_data <span class="kw">or</span> <span class="st">"industry"</span> <span class="kw">in</span> entity_data:</span>
<span id="cb63-161"><a href="#cb63-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"organization"</span></span>
<span id="cb63-162"><a href="#cb63-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"first_name"</span> <span class="kw">in</span> entity_data <span class="kw">or</span> <span class="st">"date_of_birth"</span> <span class="kw">in</span> entity_data:</span>
<span id="cb63-163"><a href="#cb63-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"person"</span></span>
<span id="cb63-164"><a href="#cb63-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"isbn"</span> <span class="kw">in</span> entity_data <span class="kw">or</span> <span class="st">"author"</span> <span class="kw">in</span> entity_data:</span>
<span id="cb63-165"><a href="#cb63-165" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"book"</span></span>
<span id="cb63-166"><a href="#cb63-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb63-167"><a href="#cb63-167" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"generic"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Effective identity management in knowledge graphs provides several benefits:</p>
<ol type="1">
<li><strong>Consistency</strong>: Unified view of entities across the knowledge graph</li>
<li><strong>Traceability</strong>: Ability to track the origin of all entity information</li>
<li><strong>Flexibility</strong>: Support for evolving entity information over time</li>
<li><strong>Confidence</strong>: Clear indication of certainty in entity attributes</li>
<li><strong>Integration</strong>: Ability to connect with external identifier systems</li>
</ol>
</section>
</section>
<section id="knowledge-graph-integration-and-fusion" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="knowledge-graph-integration-and-fusion"><span class="header-section-number">6.5</span> Knowledge graph integration and fusion</h2>
<p>Once entities and relationships have been extracted from various sources, they must be integrated into a coherent knowledge graph. This section covers techniques for combining and reconciling information from multiple sources.</p>
<section id="schema-alignment-and-mapping" class="level3" data-number="6.5.1">
<h3 data-number="6.5.1" class="anchored" data-anchor-id="schema-alignment-and-mapping"><span class="header-section-number">6.5.1</span> Schema alignment and mapping</h3>
<p>Schema alignment creates correspondences between different data models:</p>
<div id="def-schema-alignment" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.17 (Schema alignment and mapping)</strong></span> <strong>Schema alignment</strong> (or schema matching) identifies correspondences between elements in different schemas or ontologies. This includes:</p>
<ol type="1">
<li><strong>Class alignment</strong>: Mapping between entity types (e.g., Person ↔︎ Individual)</li>
<li><strong>Property alignment</strong>: Mapping between relationships and attributes (e.g., authorOf ↔︎ wrote)</li>
<li><strong>Value mapping</strong>: Transformations between different value representations (e.g., date formats)</li>
</ol>
<p><strong>Schema mapping</strong> uses these alignments to transform data from one schema to another, enabling integration of diverse data sources into a unified knowledge graph.</p>
</div>
<div id="exm-schema-alignment" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.26 (Schema alignment examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Class mapping</strong>:</p>
<pre><code>Source schema 1:
- Class: Customer
  Properties: id, name, address, phone, email

Source schema 2:
- Class: Client
  Properties: client_id, full_name, contact_address, telephone, email_address

Alignment:
Customer ↔ Client
id ↔ client_id
name ↔ full_name
address ↔ contact_address
phone ↔ telephone
email ↔ email_address</code></pre></li>
<li><p><strong>Property mapping with transformations</strong>:</p>
<pre><code>Source schema 1:
- Property: birth_date (format: MM/DD/YYYY)

Source schema 2:
- Property: dateOfBirth (format: YYYY-MM-DD)

Target schema:
- Property: birthDate (format: YYYY-MM-DD)

Mapping:
birth_date → birthDate (with format transformation MM/DD/YYYY → YYYY-MM-DD)
dateOfBirth → birthDate (direct mapping, formats already match)</code></pre></li>
<li><p><strong>Complex mapping with composition</strong>:</p>
<pre><code>Source schema:
- Class: Address
  Properties: street, city, state, zip

Target schema:
- Class: Location
  Properties: full_address, coordinates

Mapping:
Address → Location
concat(street, ", ", city, ", ", state, " ", zip) → full_address
geocode(full_address) → coordinates</code></pre></li>
</ol>
</div>
<p>Schema alignment approaches include:</p>
<ol type="1">
<li><p><strong>Manual mapping</strong>:</p>
<ul>
<li>Expert-created correspondences between schemas</li>
<li>Custom transformation rules for complex mappings</li>
<li>Advantages: Precision, domain knowledge incorporation</li>
<li>Disadvantages: Labor-intensive, difficult to scale</li>
</ul></li>
<li><p><strong>Schema matching algorithms</strong>:</p>
<ul>
<li>Lexical matching based on element names and descriptions</li>
<li>Structural matching based on schema hierarchies and relationships</li>
<li>Instance-based matching using sample data values</li>
<li>Advantages: Automated, can handle large schemas</li>
<li>Disadvantages: Lower precision, may miss complex correspondences</li>
</ul></li>
<li><p><strong>Mapping languages and tools</strong>:</p>
<ul>
<li>Languages like R2RML for mapping relational data to RDF</li>
<li>SPARQL-based mapping approaches</li>
<li>ETL tools with semantic mapping capabilities</li>
<li>Advantages: Standardized, reusable mappings</li>
<li>Disadvantages: Learning curve, implementation complexity</li>
</ul></li>
</ol>
<div id="exm-schema-mapping-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.27 (Schema mapping implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>R2RML mapping for relational to RDF transformation</strong>:</p>
<pre class="turtle"><code>@prefix rr: &lt;http://www.w3.org/ns/r2rml#&gt; .
@prefix ex: &lt;http://example.org/&gt; .
@prefix xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt; .

# Define a mapping for the Customers table
&lt;#CustomerMapping&gt;
  rr:logicalTable [ rr:tableName "Customers" ];

  # Define how to create URIs for each customer
  rr:subjectMap [
    rr:template "http://example.org/customer/{id}";
    rr:class ex:Customer;
  ];

  # Map simple properties
  rr:predicateObjectMap [
    rr:predicate ex:name;
    rr:objectMap [ rr:column "name" ];
  ];

  rr:predicateObjectMap [
    rr:predicate ex:email;
    rr:objectMap [ rr:column "email" ];
  ];

  # Map with datatype transformation
  rr:predicateObjectMap [
    rr:predicate ex:registrationDate;
    rr:objectMap [
      rr:column "reg_date";
      rr:datatype xsd:date;
    ];
  ];

  # Map with a reference to another entity
  rr:predicateObjectMap [
    rr:predicate ex:livesIn;
    rr:objectMap [
      rr:parentTriplesMap &lt;#CityMapping&gt;;
      rr:joinCondition [
        rr:child "city_id";
        rr:parent "id";
      ];
    ];
  ];
.

# Define a mapping for the Cities table
&lt;#CityMapping&gt;
  rr:logicalTable [ rr:tableName "Cities" ];

  rr:subjectMap [
    rr:template "http://example.org/city/{id}";
    rr:class ex:City;
  ];

  rr:predicateObjectMap [
    rr:predicate ex:name;
    rr:objectMap [ rr:column "name" ];
  ];

  rr:predicateObjectMap [
    rr:predicate ex:country;
    rr:objectMap [ rr:column "country" ];
  ];
.</code></pre></li>
<li><p><strong>JSON schema to RDF mapping implementation</strong>:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rdflib</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdflib <span class="im">import</span> Graph, Literal, URIRef, Namespace</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdflib.namespace <span class="im">import</span> RDF, RDFS, XSD</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> json_to_rdf(json_data, mapping_config, base_uri):</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Transform JSON data to RDF based on a mapping configuration</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">    json_data: JSON data to transform</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co">    mapping_config: Configuration defining how to map JSON to RDF</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co">    base_uri: Base URI for creating entity identifiers</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create RDF graph</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> Graph()</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define namespaces</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    EX <span class="op">=</span> Namespace(base_uri)</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    g.bind(<span class="st">"ex"</span>, EX)</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process all records in the JSON data</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(json_data, <span class="bu">list</span>):</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Array of objects</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> json_data:</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>            process_json_object(g, item, mapping_config, EX)</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Single object</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>        process_json_object(g, json_data, mapping_config, EX)</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> g</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_json_object(graph, obj, mapping, ns):</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Process a single JSON object according to the mapping"""</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the entity type</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>    entity_type <span class="op">=</span> mapping.get(<span class="st">"type"</span>, <span class="st">"Entity"</span>)</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate entity URI</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>    id_field <span class="op">=</span> mapping.get(<span class="st">"id_field"</span>, <span class="st">"id"</span>)</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>    entity_id <span class="op">=</span> obj.get(id_field, <span class="bu">str</span>(<span class="bu">hash</span>(json.dumps(obj, sort_keys<span class="op">=</span><span class="va">True</span>))))</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>    entity_uri <span class="op">=</span> ns[<span class="ss">f"</span><span class="sc">{</span>entity_type<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>entity_id<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add entity type</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>    graph.add((entity_uri, RDF.<span class="bu">type</span>, ns[entity_type]))</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process properties</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>    properties <span class="op">=</span> mapping.get(<span class="st">"properties"</span>, {})</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> prop_name, prop_config <span class="kw">in</span> properties.items():</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prop_name <span class="kw">in</span> obj:</span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the value from the JSON object</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> obj[prop_name]</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get property URI and datatype</span></span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>            prop_uri <span class="op">=</span> ns[prop_config.get(<span class="st">"uri"</span>, prop_name)]</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a>            datatype <span class="op">=</span> prop_config.get(<span class="st">"datatype"</span>, <span class="va">None</span>)</span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop_config.get(<span class="st">"type"</span>) <span class="op">==</span> <span class="st">"object"</span>:</span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle nested object</span></span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> value:</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>                    nested_mapping <span class="op">=</span> prop_config.get(<span class="st">"mapping"</span>, {<span class="st">"type"</span>: prop_name})</span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a>                    process_json_object(graph, value, nested_mapping, ns)</span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Create relationship to nested entity</span></span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a>                    nested_id_field <span class="op">=</span> nested_mapping.get(<span class="st">"id_field"</span>, <span class="st">"id"</span>)</span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>                    nested_type <span class="op">=</span> nested_mapping.get(<span class="st">"type"</span>, prop_name)</span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>                    nested_id <span class="op">=</span> value.get(nested_id_field, <span class="bu">str</span>(<span class="bu">hash</span>(json.dumps(value, sort_keys<span class="op">=</span><span class="va">True</span>))))</span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>                    nested_uri <span class="op">=</span> ns[<span class="ss">f"</span><span class="sc">{</span>nested_type<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>nested_id<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a>                    graph.add((entity_uri, prop_uri, nested_uri))</span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> prop_config.get(<span class="st">"type"</span>) <span class="op">==</span> <span class="st">"array"</span>:</span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle array values</span></span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a>                item_mapping <span class="op">=</span> prop_config.get(<span class="st">"items"</span>, {})</span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">list</span>):</span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> item <span class="kw">in</span> value:</span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> item_mapping.get(<span class="st">"type"</span>) <span class="op">==</span> <span class="st">"object"</span>:</span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Array of objects - create linked entities</span></span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a>                            process_json_object(graph, item, item_mapping, ns)</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Create relationship to each item</span></span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a>                            item_type <span class="op">=</span> item_mapping.get(<span class="st">"type"</span>, <span class="st">"Item"</span>)</span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a>                            item_id_field <span class="op">=</span> item_mapping.get(<span class="st">"id_field"</span>, <span class="st">"id"</span>)</span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>                            item_id <span class="op">=</span> item.get(item_id_field, <span class="bu">str</span>(<span class="bu">hash</span>(json.dumps(item, sort_keys<span class="op">=</span><span class="va">True</span>))))</span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>                            item_uri <span class="op">=</span> ns[<span class="ss">f"</span><span class="sc">{</span>item_type<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>item_id<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a>                            graph.add((entity_uri, prop_uri, item_uri))</span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Array of literals - add each value</span></span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a>                            literal <span class="op">=</span> create_literal(item, item_mapping.get(<span class="st">"datatype"</span>))</span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a>                            graph.add((entity_uri, prop_uri, literal))</span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle simple literal properties</span></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a>                literal <span class="op">=</span> create_literal(value, datatype)</span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a>                graph.add((entity_uri, prop_uri, literal))</span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> entity_uri</span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_literal(value, datatype):</span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create an RDF literal with appropriate datatype"""</span></span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> datatype <span class="op">==</span> <span class="st">"xsd:string"</span> <span class="kw">or</span> datatype <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Literal(value, datatype<span class="op">=</span>XSD.string)</span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> datatype <span class="op">==</span> <span class="st">"xsd:integer"</span>:</span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Literal(<span class="bu">int</span>(value), datatype<span class="op">=</span>XSD.integer)</span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> datatype <span class="op">==</span> <span class="st">"xsd:float"</span>:</span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Literal(<span class="bu">float</span>(value), datatype<span class="op">=</span>XSD.<span class="bu">float</span>)</span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> datatype <span class="op">==</span> <span class="st">"xsd:boolean"</span>:</span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Literal(<span class="bu">bool</span>(value), datatype<span class="op">=</span>XSD.boolean)</span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> datatype <span class="op">==</span> <span class="st">"xsd:date"</span>:</span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Literal(value, datatype<span class="op">=</span>XSD.date)</span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> datatype <span class="op">==</span> <span class="st">"xsd:dateTime"</span>:</span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Literal(value, datatype<span class="op">=</span>XSD.dateTime)</span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Literal(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>SPARQL-based mapping</strong>:</p>
<pre class="sparql"><code># SPARQL CONSTRUCT query to transform data from one schema to another
PREFIX src: &lt;http://source-schema.org/&gt;
PREFIX tgt: &lt;http://target-schema.org/&gt;
PREFIX xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt;

CONSTRUCT {
  # Create entities in target schema
  ?personURI a tgt:Person ;
       tgt:fullName ?name ;
       tgt:emailAddress ?email ;
       tgt:birthDate ?formattedDate ;
       tgt:livesAt ?addressURI .

  ?addressURI a tgt:Location ;
       tgt:streetAddress ?street ;
       tgt:locality ?city ;
       tgt:region ?state ;
       tgt:postalCode ?zip ;
       tgt:country "USA" .
}
WHERE {
  # Source data pattern
  ?sourceURI a src:Customer ;
       src:givenName ?firstName ;
       src:familyName ?lastName ;
       src:email ?email ;
       src:dateOfBirth ?dob .

  OPTIONAL {
    ?sourceURI src:hasAddress ?srcAddr .
    ?srcAddr src:street ?street ;
            src:city ?city ;
            src:state ?state ;
            src:zipCode ?zip .
  }

  # Transformations
  BIND(CONCAT(?firstName, " ", ?lastName) AS ?name)
  BIND(URI(CONCAT("http://target-schema.org/person/", ENCODE_FOR_URI(?name))) AS ?personURI)
  BIND(URI(CONCAT("http://target-schema.org/location/", MD5(CONCAT(?street, ?city, ?state, ?zip)))) AS ?addressURI)

  # Format date from MM/DD/YYYY to YYYY-MM-DD
  BIND(IF(CONTAINS(?dob, "/"),
          CONCAT(SUBSTR(?dob, 7, 4), "-", SUBSTR(?dob, 0, 2), "-", SUBSTR(?dob, 4, 2)),
          ?dob) AS ?formattedDate)
}</code></pre></li>
</ol>
</div>
<p>Challenges in schema alignment and mapping include:</p>
<ol type="1">
<li><strong>Semantic heterogeneity</strong>: Different conceptual models of the same domain</li>
<li><strong>Structural differences</strong>: Variations in how concepts are organized</li>
<li><strong>Complex transformations</strong>: Need for custom logic to handle certain mappings</li>
<li><strong>Maintenance</strong>: Keeping mappings up to date as schemas evolve</li>
<li><strong>Scalability</strong>: Managing alignments across many sources and large schemas</li>
</ol>
</section>
<section id="knowledge-fusion-strategies" class="level3" data-number="6.5.2">
<h3 data-number="6.5.2" class="anchored" data-anchor-id="knowledge-fusion-strategies"><span class="header-section-number">6.5.2</span> Knowledge fusion strategies</h3>
<p>Knowledge fusion combines information from multiple sources while resolving conflicts and ensuring coherence:</p>
<div id="def-knowledge-fusion" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.18 (Knowledge fusion)</strong></span> <strong>Knowledge fusion</strong> is the process of combining information from multiple sources into a unified, coherent knowledge representation. Key aspects include:</p>
<ol type="1">
<li><strong>Information aggregation</strong>: Collecting and combining complementary information</li>
<li><strong>Conflict resolution</strong>: Reconciling contradictory information</li>
<li><strong>Source reliability assessment</strong>: Weighting information based on source credibility</li>
<li><strong>Temporal resolution</strong>: Handling information from different time periods</li>
<li><strong>Uncertainty representation</strong>: Capturing confidence in fused knowledge</li>
</ol>
</div>
<div id="exm-knowledge-fusion" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.28 (Knowledge fusion examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Complementary information fusion</strong>:</p>
<pre><code>Source 1: {id: "person/123", name: "John Smith", birthDate: "1980-05-15"}
Source 2: {id: "person/456", name: "John Smith", profession: "Software Engineer"}
Source 3: {id: "person/789", name: "J. Smith", email: "john.smith@example.com"}

After entity resolution and fusion:
{
  id: "kg:person:P12345",
  name: "John Smith",
  birthDate: "1980-05-15",
  profession: "Software Engineer",
  email: "john.smith@example.com",
  source_ids: ["person/123", "person/456", "person/789"],
  sources: ["database1", "database2", "web"]
}</code></pre></li>
<li><p><strong>Conflict resolution</strong>:</p>
<pre><code>Source 1: {name: "Albert Einstein", birthDate: "1879-03-14", deathDate: "1955-04-18"}
Source 2: {name: "Albert Einstein", birthDate: "1879-03-14", deathDate: "1955-04-17"}

Resolution options:

a) Majority voting (if more sources):
{
  name: "Albert Einstein",
  birthDate: "1879-03-14",
  deathDate: "1955-04-18",  // Selected based on majority
  deathDate_sources: {
    "source1": "1955-04-18",
    "source2": "1955-04-17"
  }
}

b) Source reliability weighting:
{
  name: "Albert Einstein",
  birthDate: "1879-03-14",
  deathDate: "1955-04-18",  // Selected based on source reliability
  deathDate_sources: {
    "source1": {"value": "1955-04-18", "reliability": 0.9},
    "source2": {"value": "1955-04-17", "reliability": 0.7}
  }
}</code></pre></li>
<li><p><strong>Temporal versioning</strong>:</p>
<pre><code>Source 1 (2020): {company: "TechCorp", headquarters: "New York", employees: 1200}
Source 2 (2022): {company: "TechCorp", headquarters: "Austin", employees: 1500}

Temporal fusion:
{
  id: "kg:company:C5678",
  name: "TechCorp",
  headquarters: [
    {value: "New York", from: "2000", to: "2021"},
    {value: "Austin", from: "2021", until: null}
  ],
  employees: [
    {value: 1200, timestamp: "2020"},
    {value: 1500, timestamp: "2022"}
  ]
}</code></pre></li>
</ol>
</div>
<p>Knowledge fusion approaches include:</p>
<ol type="1">
<li><p><strong>Rule-based fusion</strong>:</p>
<ul>
<li>Explicit rules for combining information</li>
<li>Source prioritization hierarchies</li>
<li>Domain-specific conflict resolution</li>
<li>Advantages: Interpretable, incorporates domain knowledge</li>
<li>Disadvantages: Manual rule creation, maintenance challenges</li>
</ul></li>
<li><p><strong>Statistical fusion</strong>:</p>
<ul>
<li>Voting-based methods</li>
<li>Probabilistic models</li>
<li>Truth discovery algorithms</li>
<li>Advantages: Can handle large-scale fusion, quantify certainty</li>
<li>Disadvantages: May oversimplify complex conflicts</li>
</ul></li>
<li><p><strong>Learning-based fusion</strong>:</p>
<ul>
<li>Supervised learning for resolving conflicts</li>
<li>Embeddings for semantic similarity</li>
<li>Reinforcement learning for fusion policies</li>
<li>Advantages: Adaptivity, can learn from examples</li>
<li>Disadvantages: Requires training data, less transparent</li>
</ul></li>
</ol>
<div id="exm-fusion-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.29 (Knowledge fusion implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Rule-based fusion implementation</strong>:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rule_based_fusion(entity_references, attribute_prioritization<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fuse entity information using rule-based approach</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co">    entity_references: List of dictionaries containing entity data from different sources</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="co">    attribute_prioritization: Optional dictionary specifying source priorities per attribute</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> entity_references:</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start with an empty fused entity</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    fused_entity <span class="op">=</span> {</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sources"</span>: [],</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"source_details"</span>: {}</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Track all attributes encountered</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    all_attributes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> entity_references:</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        all_attributes.update(entity.keys())</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove metadata fields</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> meta_field <span class="kw">in</span> [<span class="st">"source"</span>, <span class="st">"source_id"</span>, <span class="st">"confidence"</span>]:</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> meta_field <span class="kw">in</span> all_attributes:</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>            all_attributes.remove(meta_field)</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each attribute</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attribute <span class="kw">in</span> all_attributes:</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collect all values for this attribute from different sources</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>        attribute_values <span class="op">=</span> []</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity <span class="kw">in</span> entity_references:</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attribute <span class="kw">in</span> entity:</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>                source <span class="op">=</span> entity.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>                source_id <span class="op">=</span> entity.get(<span class="st">"source_id"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>                confidence <span class="op">=</span> entity.get(<span class="st">"confidence"</span>, <span class="fl">1.0</span>)</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>                attribute_values.append({</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"value"</span>: entity[attribute],</span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"source"</span>: source,</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"source_id"</span>: source_id,</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"confidence"</span>: confidence</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip if no values found</span></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> attribute_values:</span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply fusion rules</span></span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>        fused_value <span class="op">=</span> <span class="va">None</span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>        value_sources <span class="op">=</span> []</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if we have prioritization rules for this attribute</span></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> attribute_prioritization <span class="kw">and</span> attribute <span class="kw">in</span> attribute_prioritization:</span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Sort by priority</span></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>            priorities <span class="op">=</span> attribute_prioritization[attribute]</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>            attribute_values.sort(</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a>                key<span class="op">=</span><span class="kw">lambda</span> x: priorities.index(x[<span class="st">"source"</span>])</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> x[<span class="st">"source"</span>] <span class="kw">in</span> priorities <span class="cf">else</span> <span class="bu">len</span>(priorities)</span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Take the highest priority value</span></span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>            fused_value <span class="op">=</span> attribute_values[<span class="dv">0</span>][<span class="st">"value"</span>]</span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>            value_sources <span class="op">=</span> [attribute_values[<span class="dv">0</span>]]</span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply attribute-specific rules</span></span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> attribute <span class="kw">in</span> [<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"identifier"</span>]:</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For identifying attributes, use the most common value</span></span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a>            value_counts <span class="op">=</span> {}</span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> item <span class="kw">in</span> attribute_values:</span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> <span class="bu">str</span>(item[<span class="st">"value"</span>])</span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> value <span class="kw">not</span> <span class="kw">in</span> value_counts:</span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a>                    value_counts[value] <span class="op">=</span> []</span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a>                value_counts[value].append(item)</span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find the most common value</span></span>
<span id="cb73-76"><a href="#cb73-76" aria-hidden="true" tabindex="-1"></a>            most_common <span class="op">=</span> <span class="bu">max</span>(value_counts.items(), key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">len</span>(x[<span class="dv">1</span>]))</span>
<span id="cb73-77"><a href="#cb73-77" aria-hidden="true" tabindex="-1"></a>            fused_value <span class="op">=</span> most_common[<span class="dv">0</span>]</span>
<span id="cb73-78"><a href="#cb73-78" aria-hidden="true" tabindex="-1"></a>            value_sources <span class="op">=</span> most_common[<span class="dv">1</span>]</span>
<span id="cb73-79"><a href="#cb73-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-80"><a href="#cb73-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> attribute <span class="kw">in</span> [<span class="st">"birthDate"</span>, <span class="st">"startDate"</span>, <span class="st">"creationDate"</span>]:</span>
<span id="cb73-81"><a href="#cb73-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For date attributes, select the most precise date format</span></span>
<span id="cb73-82"><a href="#cb73-82" aria-hidden="true" tabindex="-1"></a>            <span class="co"># or the most commonly occurring value</span></span>
<span id="cb73-83"><a href="#cb73-83" aria-hidden="true" tabindex="-1"></a>            date_values <span class="op">=</span> {}</span>
<span id="cb73-84"><a href="#cb73-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> item <span class="kw">in</span> attribute_values:</span>
<span id="cb73-85"><a href="#cb73-85" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> <span class="bu">str</span>(item[<span class="st">"value"</span>])</span>
<span id="cb73-86"><a href="#cb73-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> value <span class="kw">not</span> <span class="kw">in</span> date_values:</span>
<span id="cb73-87"><a href="#cb73-87" aria-hidden="true" tabindex="-1"></a>                    date_values[value] <span class="op">=</span> []</span>
<span id="cb73-88"><a href="#cb73-88" aria-hidden="true" tabindex="-1"></a>                date_values[value].append(item)</span>
<span id="cb73-89"><a href="#cb73-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-90"><a href="#cb73-90" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find the most common value</span></span>
<span id="cb73-91"><a href="#cb73-91" aria-hidden="true" tabindex="-1"></a>            most_common <span class="op">=</span> <span class="bu">max</span>(date_values.items(), key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">len</span>(x[<span class="dv">1</span>]))</span>
<span id="cb73-92"><a href="#cb73-92" aria-hidden="true" tabindex="-1"></a>            fused_value <span class="op">=</span> most_common[<span class="dv">0</span>]</span>
<span id="cb73-93"><a href="#cb73-93" aria-hidden="true" tabindex="-1"></a>            value_sources <span class="op">=</span> most_common[<span class="dv">1</span>]</span>
<span id="cb73-94"><a href="#cb73-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-95"><a href="#cb73-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(attribute_values[<span class="dv">0</span>][<span class="st">"value"</span>], (<span class="bu">int</span>, <span class="bu">float</span>)):</span>
<span id="cb73-96"><a href="#cb73-96" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For numeric attributes, use statistical measures</span></span>
<span id="cb73-97"><a href="#cb73-97" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Options: mean, median, max (most recent), etc.</span></span>
<span id="cb73-98"><a href="#cb73-98" aria-hidden="true" tabindex="-1"></a>            values <span class="op">=</span> [item[<span class="st">"value"</span>] <span class="cf">for</span> item <span class="kw">in</span> attribute_values]</span>
<span id="cb73-99"><a href="#cb73-99" aria-hidden="true" tabindex="-1"></a>            confidences <span class="op">=</span> [item[<span class="st">"confidence"</span>] <span class="cf">for</span> item <span class="kw">in</span> attribute_values]</span>
<span id="cb73-100"><a href="#cb73-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-101"><a href="#cb73-101" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Weighted average based on confidence</span></span>
<span id="cb73-102"><a href="#cb73-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">sum</span>(confidences) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb73-103"><a href="#cb73-103" aria-hidden="true" tabindex="-1"></a>                fused_value <span class="op">=</span> <span class="bu">sum</span>(v <span class="op">*</span> c <span class="cf">for</span> v, c <span class="kw">in</span> <span class="bu">zip</span>(values, confidences)) <span class="op">/</span> <span class="bu">sum</span>(confidences)</span>
<span id="cb73-104"><a href="#cb73-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb73-105"><a href="#cb73-105" aria-hidden="true" tabindex="-1"></a>                fused_value <span class="op">=</span> <span class="bu">sum</span>(values) <span class="op">/</span> <span class="bu">len</span>(values)</span>
<span id="cb73-106"><a href="#cb73-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-107"><a href="#cb73-107" aria-hidden="true" tabindex="-1"></a>            value_sources <span class="op">=</span> attribute_values</span>
<span id="cb73-108"><a href="#cb73-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-109"><a href="#cb73-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(attribute_values[<span class="dv">0</span>][<span class="st">"value"</span>], <span class="bu">list</span>):</span>
<span id="cb73-110"><a href="#cb73-110" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For list attributes, combine unique values</span></span>
<span id="cb73-111"><a href="#cb73-111" aria-hidden="true" tabindex="-1"></a>            combined_list <span class="op">=</span> []</span>
<span id="cb73-112"><a href="#cb73-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> item <span class="kw">in</span> attribute_values:</span>
<span id="cb73-113"><a href="#cb73-113" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(item[<span class="st">"value"</span>], <span class="bu">list</span>):</span>
<span id="cb73-114"><a href="#cb73-114" aria-hidden="true" tabindex="-1"></a>                    combined_list.extend(item[<span class="st">"value"</span>])</span>
<span id="cb73-115"><a href="#cb73-115" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb73-116"><a href="#cb73-116" aria-hidden="true" tabindex="-1"></a>                    combined_list.append(item[<span class="st">"value"</span>])</span>
<span id="cb73-117"><a href="#cb73-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-118"><a href="#cb73-118" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remove duplicates while preserving order</span></span>
<span id="cb73-119"><a href="#cb73-119" aria-hidden="true" tabindex="-1"></a>            seen <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb73-120"><a href="#cb73-120" aria-hidden="true" tabindex="-1"></a>            fused_value <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> combined_list <span class="cf">if</span> <span class="kw">not</span> (x <span class="kw">in</span> seen <span class="kw">or</span> seen.add(x))]</span>
<span id="cb73-121"><a href="#cb73-121" aria-hidden="true" tabindex="-1"></a>            value_sources <span class="op">=</span> attribute_values</span>
<span id="cb73-122"><a href="#cb73-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-123"><a href="#cb73-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb73-124"><a href="#cb73-124" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Default: use the value with highest confidence</span></span>
<span id="cb73-125"><a href="#cb73-125" aria-hidden="true" tabindex="-1"></a>            attribute_values.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"confidence"</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-126"><a href="#cb73-126" aria-hidden="true" tabindex="-1"></a>            fused_value <span class="op">=</span> attribute_values[<span class="dv">0</span>][<span class="st">"value"</span>]</span>
<span id="cb73-127"><a href="#cb73-127" aria-hidden="true" tabindex="-1"></a>            value_sources <span class="op">=</span> [attribute_values[<span class="dv">0</span>]]</span>
<span id="cb73-128"><a href="#cb73-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-129"><a href="#cb73-129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the fused value to the result</span></span>
<span id="cb73-130"><a href="#cb73-130" aria-hidden="true" tabindex="-1"></a>        fused_entity[attribute] <span class="op">=</span> fused_value</span>
<span id="cb73-131"><a href="#cb73-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-132"><a href="#cb73-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Track source details</span></span>
<span id="cb73-133"><a href="#cb73-133" aria-hidden="true" tabindex="-1"></a>        fused_entity[<span class="st">"source_details"</span>][attribute] <span class="op">=</span> value_sources</span>
<span id="cb73-134"><a href="#cb73-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-135"><a href="#cb73-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add source to overall sources list</span></span>
<span id="cb73-136"><a href="#cb73-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> source <span class="kw">in</span> value_sources:</span>
<span id="cb73-137"><a href="#cb73-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> source[<span class="st">"source"</span>] <span class="kw">not</span> <span class="kw">in</span> fused_entity[<span class="st">"sources"</span>]:</span>
<span id="cb73-138"><a href="#cb73-138" aria-hidden="true" tabindex="-1"></a>                fused_entity[<span class="st">"sources"</span>].append(source[<span class="st">"source"</span>])</span>
<span id="cb73-139"><a href="#cb73-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-140"><a href="#cb73-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fused_entity</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Statistical fusion with truth discovery</strong>:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> truth_discovery_fusion(entity_references, max_iterations<span class="op">=</span><span class="dv">20</span>, convergence_threshold<span class="op">=</span><span class="fl">0.001</span>):</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fuse entity information using truth discovery algorithm</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co">    entity_references: List of dictionaries containing entity data from different sources</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="co">    max_iterations: Maximum number of iterations for convergence</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co">    convergence_threshold: Threshold for stopping iterations</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> entity_references:</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract all sources and attributes</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    sources <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    attributes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> entity_references:</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>        sources.add(entity.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>))</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> entity.keys():</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"source"</span>, <span class="st">"source_id"</span>, <span class="st">"confidence"</span>]:</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>                attributes.add(key)</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize source weights (reliability)</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    source_weights <span class="op">=</span> {source: <span class="fl">1.0</span> <span class="cf">for</span> source <span class="kw">in</span> sources}</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize true values with a simple vote</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>    true_values <span class="op">=</span> {}</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attribute <span class="kw">in</span> attributes:</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>        value_counts <span class="op">=</span> {}</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity <span class="kw">in</span> entity_references:</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attribute <span class="kw">in</span> entity:</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> <span class="bu">str</span>(entity[attribute])</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>                value_counts[value] <span class="op">=</span> value_counts.get(value, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value_counts:</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>            most_common <span class="op">=</span> <span class="bu">max</span>(value_counts.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>            true_values[attribute] <span class="op">=</span> most_common[<span class="dv">0</span>]</span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterative algorithm</span></span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iteration <span class="kw">in</span> <span class="bu">range</span>(max_iterations):</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store old weights for convergence check</span></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>        old_weights <span class="op">=</span> source_weights.copy()</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 1: Compute source weights based on agreement with current true values</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>        source_error_sum <span class="op">=</span> {source: <span class="fl">0.0</span> <span class="cf">for</span> source <span class="kw">in</span> sources}</span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>        source_provided_count <span class="op">=</span> {source: <span class="dv">0</span> <span class="cf">for</span> source <span class="kw">in</span> sources}</span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity <span class="kw">in</span> entity_references:</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>            source <span class="op">=</span> entity.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> attribute <span class="kw">in</span> attributes:</span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> attribute <span class="kw">in</span> entity <span class="kw">and</span> attribute <span class="kw">in</span> true_values:</span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Compute error (0 if agrees with true value, 1 otherwise)</span></span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>                    error <span class="op">=</span> <span class="fl">0.0</span> <span class="cf">if</span> <span class="bu">str</span>(entity[attribute]) <span class="op">==</span> true_values[attribute] <span class="cf">else</span> <span class="fl">1.0</span></span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>                    source_error_sum[source] <span class="op">+=</span> error</span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>                    source_provided_count[source] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update source weights</span></span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> source <span class="kw">in</span> sources:</span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> source_provided_count[source] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a>                avg_error <span class="op">=</span> source_error_sum[source] <span class="op">/</span> source_provided_count[source]</span>
<span id="cb74-60"><a href="#cb74-60" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Weight is inversely proportional to error</span></span>
<span id="cb74-61"><a href="#cb74-61" aria-hidden="true" tabindex="-1"></a>                source_weights[source] <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> (avg_error <span class="op">+</span> <span class="fl">0.00001</span>)  <span class="co"># Avoid division by zero</span></span>
<span id="cb74-62"><a href="#cb74-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-63"><a href="#cb74-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize weights</span></span>
<span id="cb74-64"><a href="#cb74-64" aria-hidden="true" tabindex="-1"></a>        weight_sum <span class="op">=</span> <span class="bu">sum</span>(source_weights.values())</span>
<span id="cb74-65"><a href="#cb74-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weight_sum <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb74-66"><a href="#cb74-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> source <span class="kw">in</span> sources:</span>
<span id="cb74-67"><a href="#cb74-67" aria-hidden="true" tabindex="-1"></a>                source_weights[source] <span class="op">/=</span> weight_sum</span>
<span id="cb74-68"><a href="#cb74-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-69"><a href="#cb74-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 2: Update true values based on weighted voting</span></span>
<span id="cb74-70"><a href="#cb74-70" aria-hidden="true" tabindex="-1"></a>        new_true_values <span class="op">=</span> {}</span>
<span id="cb74-71"><a href="#cb74-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attribute <span class="kw">in</span> attributes:</span>
<span id="cb74-72"><a href="#cb74-72" aria-hidden="true" tabindex="-1"></a>            weighted_votes <span class="op">=</span> {}</span>
<span id="cb74-73"><a href="#cb74-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> entity <span class="kw">in</span> entity_references:</span>
<span id="cb74-74"><a href="#cb74-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> attribute <span class="kw">in</span> entity:</span>
<span id="cb74-75"><a href="#cb74-75" aria-hidden="true" tabindex="-1"></a>                    source <span class="op">=</span> entity.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb74-76"><a href="#cb74-76" aria-hidden="true" tabindex="-1"></a>                    value <span class="op">=</span> <span class="bu">str</span>(entity[attribute])</span>
<span id="cb74-77"><a href="#cb74-77" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> value <span class="kw">not</span> <span class="kw">in</span> weighted_votes:</span>
<span id="cb74-78"><a href="#cb74-78" aria-hidden="true" tabindex="-1"></a>                        weighted_votes[value] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb74-79"><a href="#cb74-79" aria-hidden="true" tabindex="-1"></a>                    weighted_votes[value] <span class="op">+=</span> source_weights[source]</span>
<span id="cb74-80"><a href="#cb74-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-81"><a href="#cb74-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> weighted_votes:</span>
<span id="cb74-82"><a href="#cb74-82" aria-hidden="true" tabindex="-1"></a>                best_value <span class="op">=</span> <span class="bu">max</span>(weighted_votes.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span>
<span id="cb74-83"><a href="#cb74-83" aria-hidden="true" tabindex="-1"></a>                new_true_values[attribute] <span class="op">=</span> best_value[<span class="dv">0</span>]</span>
<span id="cb74-84"><a href="#cb74-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-85"><a href="#cb74-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update true values</span></span>
<span id="cb74-86"><a href="#cb74-86" aria-hidden="true" tabindex="-1"></a>        true_values <span class="op">=</span> new_true_values</span>
<span id="cb74-87"><a href="#cb74-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-88"><a href="#cb74-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for convergence</span></span>
<span id="cb74-89"><a href="#cb74-89" aria-hidden="true" tabindex="-1"></a>        weight_diff <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">abs</span>(source_weights[s] <span class="op">-</span> old_weights[s]) <span class="cf">for</span> s <span class="kw">in</span> sources)</span>
<span id="cb74-90"><a href="#cb74-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weight_diff <span class="op">&lt;</span> convergence_threshold:</span>
<span id="cb74-91"><a href="#cb74-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb74-92"><a href="#cb74-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-93"><a href="#cb74-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct fused entity</span></span>
<span id="cb74-94"><a href="#cb74-94" aria-hidden="true" tabindex="-1"></a>    fused_entity <span class="op">=</span> true_values.copy()</span>
<span id="cb74-95"><a href="#cb74-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-96"><a href="#cb74-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add source information</span></span>
<span id="cb74-97"><a href="#cb74-97" aria-hidden="true" tabindex="-1"></a>    fused_entity[<span class="st">"sources"</span>] <span class="op">=</span> <span class="bu">list</span>(sources)</span>
<span id="cb74-98"><a href="#cb74-98" aria-hidden="true" tabindex="-1"></a>    fused_entity[<span class="st">"source_weights"</span>] <span class="op">=</span> source_weights</span>
<span id="cb74-99"><a href="#cb74-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-100"><a href="#cb74-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add detailed provenance</span></span>
<span id="cb74-101"><a href="#cb74-101" aria-hidden="true" tabindex="-1"></a>    source_details <span class="op">=</span> {}</span>
<span id="cb74-102"><a href="#cb74-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attribute <span class="kw">in</span> attributes:</span>
<span id="cb74-103"><a href="#cb74-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> attribute <span class="kw">in</span> true_values:</span>
<span id="cb74-104"><a href="#cb74-104" aria-hidden="true" tabindex="-1"></a>            attribute_sources <span class="op">=</span> []</span>
<span id="cb74-105"><a href="#cb74-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> entity <span class="kw">in</span> entity_references:</span>
<span id="cb74-106"><a href="#cb74-106" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> attribute <span class="kw">in</span> entity <span class="kw">and</span> <span class="bu">str</span>(entity[attribute]) <span class="op">==</span> true_values[attribute]:</span>
<span id="cb74-107"><a href="#cb74-107" aria-hidden="true" tabindex="-1"></a>                    source <span class="op">=</span> entity.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb74-108"><a href="#cb74-108" aria-hidden="true" tabindex="-1"></a>                    source_id <span class="op">=</span> entity.get(<span class="st">"source_id"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb74-109"><a href="#cb74-109" aria-hidden="true" tabindex="-1"></a>                    attribute_sources.append({</span>
<span id="cb74-110"><a href="#cb74-110" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"source"</span>: source,</span>
<span id="cb74-111"><a href="#cb74-111" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"source_id"</span>: source_id,</span>
<span id="cb74-112"><a href="#cb74-112" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"weight"</span>: source_weights[source]</span>
<span id="cb74-113"><a href="#cb74-113" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb74-114"><a href="#cb74-114" aria-hidden="true" tabindex="-1"></a>            source_details[attribute] <span class="op">=</span> attribute_sources</span>
<span id="cb74-115"><a href="#cb74-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-116"><a href="#cb74-116" aria-hidden="true" tabindex="-1"></a>    fused_entity[<span class="st">"source_details"</span>] <span class="op">=</span> source_details</span>
<span id="cb74-117"><a href="#cb74-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-118"><a href="#cb74-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fused_entity</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Temporal conflict resolution</strong>:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> temporal_fusion(entity_references):</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fuse entity information with temporal awareness</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co">    entity_references: List of dictionaries containing entity data from different sources,</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co">                      each with a timestamp</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> entity_references:</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort entity references by timestamp</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    sorted_refs <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        entity_references,</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>        key<span class="op">=</span><span class="kw">lambda</span> x: x.get(<span class="st">"timestamp"</span>, <span class="st">"0000-00-00"</span>)</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract all attributes (excluding metadata)</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    attributes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> sorted_refs:</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> entity.keys():</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"source"</span>, <span class="st">"source_id"</span>, <span class="st">"confidence"</span>, <span class="st">"timestamp"</span>]:</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>                attributes.add(key)</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Track the evolution of attribute values over time</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    attribute_history <span class="op">=</span> {}</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attribute <span class="kw">in</span> attributes:</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        attribute_history[attribute] <span class="op">=</span> []</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Current state of the entity</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>    current_state <span class="op">=</span> {}</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process entity references in chronological order</span></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> sorted_refs:</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>        timestamp <span class="op">=</span> entity.get(<span class="st">"timestamp"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>        source <span class="op">=</span> entity.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attribute <span class="kw">in</span> attributes:</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attribute <span class="kw">in</span> entity:</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>                current_value <span class="op">=</span> current_state.get(attribute)</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>                new_value <span class="op">=</span> entity[attribute]</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check if value has changed</span></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> current_value <span class="op">!=</span> new_value:</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># If there's an existing value, close its time period</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> attribute <span class="kw">in</span> current_state:</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>                        attribute_history[attribute][<span class="op">-</span><span class="dv">1</span>][<span class="st">"to"</span>] <span class="op">=</span> timestamp</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Add new value</span></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>                    attribute_history[attribute].append({</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"value"</span>: new_value,</span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"from"</span>: timestamp,</span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"to"</span>: <span class="va">None</span>,  <span class="co"># Still current</span></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"source"</span>: source</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Update current state</span></span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>                    current_state[attribute] <span class="op">=</span> new_value</span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct fused entity with temporal information</span></span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>    fused_entity <span class="op">=</span> {</span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"current"</span>: current_state,</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"history"</span>: attribute_history,</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sources"</span>: <span class="bu">list</span>(<span class="bu">set</span>(e.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>) <span class="cf">for</span> e <span class="kw">in</span> sorted_refs))</span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fused_entity</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in knowledge fusion include:</p>
<ol type="1">
<li><strong>Conflicting information</strong>: Determining truth when sources disagree</li>
<li><strong>Missing temporal context</strong>: Resolving conflicts without clear timestamps</li>
<li><strong>Source reliability assessment</strong>: Objectively evaluating source credibility</li>
<li><strong>Interdependent attributes</strong>: Handling cases where attributes should be jointly fused</li>
<li><strong>Schema heterogeneity</strong>: Fusing information across different conceptual models</li>
</ol>
</section>
<section id="ontology-based-integration" class="level3" data-number="6.5.3">
<h3 data-number="6.5.3" class="anchored" data-anchor-id="ontology-based-integration"><span class="header-section-number">6.5.3</span> Ontology-based integration</h3>
<p>Ontology-based integration uses formal ontologies to guide and structure the integration process:</p>
<div id="def-ontology-integration" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.19 (Ontology-based integration)</strong></span> <strong>Ontology-based integration</strong> uses ontologies to guide the process of combining information from multiple sources. Key aspects include:</p>
<ol type="1">
<li><strong>Semantic anchoring</strong>: Using ontologies as a reference model for integration</li>
<li><strong>Inference-based integration</strong>: Leveraging logical inference to derive implicit connections</li>
<li><strong>Constraint validation</strong>: Ensuring integrated data satisfies ontological constraints</li>
<li><strong>Cross-ontology mapping</strong>: Connecting concepts across different domain ontologies</li>
<li><strong>Upper ontology alignment</strong>: Using top-level ontologies for consistent integration</li>
</ol>
</div>
<div id="exm-ontology-integration" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.30 (Ontology-based integration examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Integration through shared ontology</strong>:</p>
<pre><code>Source 1 schema:
- Class: Person (properties: name, birthDate, gender)
- Class: Publication (properties: title, year, authors)

Source 2 schema:
- Class: Author (properties: fullName, dob, gender)
- Class: Paper (properties: paperTitle, publicationYear, writtenBy)

Shared ontology:
- Class: foaf:Person (properties: foaf:name, bio:birth, foaf:gender)
- Class: bibo:Document (properties: dcterms:title, dcterms:date, dcterms:creator)

Integration:
- Person maps to foaf:Person
  - name → foaf:name
  - birthDate → bio:birth
  - gender → foaf:gender

- Author maps to foaf:Person
  - fullName → foaf:name
  - dob → bio:birth
  - gender → foaf:gender

- Publication maps to bibo:Document
  - title → dcterms:title
  - year → dcterms:date
  - authors → dcterms:creator

- Paper maps to bibo:Document
  - paperTitle → dcterms:title
  - publicationYear → dcterms:date
  - writtenBy → dcterms:creator</code></pre></li>
<li><p><strong>Integration with ontological constraints</strong>:</p>
<pre><code>Ontology constraints:
- Class: MedicalDoctor (subClassOf: HealthcareProfessional)
  - Constraint: must have at least one medicalSpecialty
  - Constraint: must have a medicalLicense

Source 1 data:
{
  "id": "doc123",
  "type": "Physician",
  "name": "Dr. Smith",
  "specialty": "Cardiology",
  "license": "MD12345"
}

Source 2 data:
{
  "id": "physician456",
  "type": "Doctor",
  "name": "Jane Smith, MD",
  "practices": ["Heart Surgery", "Vascular Medicine"]
}

Integrated result with constraint validation:
{
  "id": "kg:MedicalDoctor:MD789",
  "type": "MedicalDoctor",
  "name": "Dr. Jane Smith",
  "medicalSpecialty": ["Cardiology", "Heart Surgery", "Vascular Medicine"],
  "medicalLicense": "MD12345",
  "validation": {
    "compliant": true,
    "missing": [],
    "violations": []
  }
}</code></pre></li>
<li><p><strong>Integration with inference</strong>:</p>
<pre><code>Ontology axioms:
- Cardiologist SubClassOf: MedicalSpecialist
- Cardiology SubClassOf: MedicalSpecialty
- hasSpecialty Domain: MedicalPractitioner Range: MedicalSpecialty
- practices SubPropertyOf: hasSpecialty
- Cardiologist EquivalentTo: MedicalPractitioner and (hasSpecialty some Cardiology)

Source data:
{
  "id": "doc789",
  "type": "Physician",
  "name": "Dr. Johnson",
  "practices": "Cardiology"
}

Integrated result with inference:
{
  "id": "kg:MedicalPractitioner:MP101",
  "type": ["MedicalPractitioner", "Cardiologist"],  // Inferred type
  "name": "Dr. Johnson",
  "hasSpecialty": "Cardiology",  // Original: practices
  "inferred": true
}</code></pre></li>
</ol>
</div>
<p>Ontology-based integration approaches include:</p>
<ol type="1">
<li><p><strong>Global-as-view (GAV)</strong>:</p>
<ul>
<li>Defining the global schema (ontology) as a view over source schemas</li>
<li>Generating integrated data by evaluating views over source data</li>
<li>Advantages: Straightforward query processing, conceptual clarity</li>
<li>Disadvantages: Sensitive to changes in sources, complex for many sources</li>
</ul></li>
<li><p><strong>Local-as-view (LAV)</strong>:</p>
<ul>
<li>Defining source schemas as views over a global ontology</li>
<li>Rewriting queries against the global schema into source-specific queries</li>
<li>Advantages: More resilient to source changes, easier to add new sources</li>
<li>Disadvantages: More complex query processing, challenging view definitions</li>
</ul></li>
<li><p><strong>Hybrid approaches</strong>:</p>
<ul>
<li>Global-local-as-view (GLAV) combining aspects of both</li>
<li>Peer-to-peer semantic mapping networks</li>
<li>Advantages: Flexibility, scalability for complex integration scenarios</li>
<li>Disadvantages: Increased complexity, harder to guarantee global consistency</li>
</ul></li>
</ol>
<div id="exm-ontology-integration-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.31 (Ontology-based integration implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Integration using OWL reasoning</strong>:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> owlready2 <span class="im">import</span> <span class="op">*</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rdflib</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ontology_based_integration(source_data_list, mapping_list, ontology_file):</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Integrate multiple data sources using ontology-based approach</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="co">    source_data_list: List of data from different sources</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="co">    mapping_list: List of mappings from source schemas to ontology</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ontology_file: Path to the shared ontology file (OWL)</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the ontology</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    onto <span class="op">=</span> get_ontology(ontology_file).load()</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a world for reasoning</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    world <span class="op">=</span> onto.world</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each source data using its mapping</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> source_data, mapping <span class="kw">in</span> <span class="bu">zip</span>(source_data_list, mapping_list):</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>        integrate_source(source_data, mapping, onto, world)</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run the reasoner to apply inference</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> onto:</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>        sync_reasoner_pellet(world, infer_property_values<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract integrated data</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>    integrated_data <span class="op">=</span> extract_integrated_data(onto)</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> integrated_data</span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> integrate_source(source_data, mapping, onto, world):</span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Integrate a single source into the ontology"""</span></span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each entity in the source data</span></span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> source_data:</span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map source entity type to ontology class</span></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"type"</span> <span class="kw">in</span> entity <span class="kw">and</span> entity[<span class="st">"type"</span>] <span class="kw">in</span> mapping[<span class="st">"class_mappings"</span>]:</span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>            ontology_class_name <span class="op">=</span> mapping[<span class="st">"class_mappings"</span>][entity[<span class="st">"type"</span>]]</span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>            ontology_class <span class="op">=</span> <span class="bu">getattr</span>(onto, ontology_class_name)</span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create instance with a unique ID</span></span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"id"</span> <span class="kw">in</span> entity:</span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a>                instance_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ontology_class_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>entity[<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a>                instance_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ontology_class_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span><span class="bu">len</span>(<span class="bu">list</span>(ontology_class.instances()))<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a>            instance <span class="op">=</span> ontology_class(instance_id)</span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Map and set properties</span></span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> prop_name, prop_value <span class="kw">in</span> entity.items():</span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prop_name <span class="kw">in</span> mapping[<span class="st">"property_mappings"</span>]:</span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a>                    onto_prop_name <span class="op">=</span> mapping[<span class="st">"property_mappings"</span>][prop_name]</span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true" tabindex="-1"></a>                    onto_prop <span class="op">=</span> <span class="bu">getattr</span>(onto, onto_prop_name)</span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Handle different property types</span></span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> onto_prop.<span class="bu">range</span> <span class="kw">in</span> [<span class="bu">str</span>, <span class="bu">int</span>, <span class="bu">float</span>, <span class="bu">bool</span>]:</span>
<span id="cb79-56"><a href="#cb79-56" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Data property</span></span>
<span id="cb79-57"><a href="#cb79-57" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">setattr</span>(instance, onto_prop_name, prop_value)</span>
<span id="cb79-58"><a href="#cb79-58" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb79-59"><a href="#cb79-59" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Object property - handle reference</span></span>
<span id="cb79-60"><a href="#cb79-60" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># This assumes the referenced entity already exists or will be created</span></span>
<span id="cb79-61"><a href="#cb79-61" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># In practice, this would need more sophisticated reference resolution</span></span>
<span id="cb79-62"><a href="#cb79-62" aria-hidden="true" tabindex="-1"></a>                        referenced_instance <span class="op">=</span> find_or_create_reference(</span>
<span id="cb79-63"><a href="#cb79-63" aria-hidden="true" tabindex="-1"></a>                            prop_value, onto, mapping</span>
<span id="cb79-64"><a href="#cb79-64" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb79-65"><a href="#cb79-65" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> referenced_instance:</span>
<span id="cb79-66"><a href="#cb79-66" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">setattr</span>(instance, onto_prop_name, referenced_instance)</span>
<span id="cb79-67"><a href="#cb79-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-68"><a href="#cb79-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_or_create_reference(ref_value, onto, mapping):</span>
<span id="cb79-69"><a href="#cb79-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Find or create a referenced entity"""</span></span>
<span id="cb79-70"><a href="#cb79-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is a simplified implementation</span></span>
<span id="cb79-71"><a href="#cb79-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Real systems would need more sophisticated entity resolution</span></span>
<span id="cb79-72"><a href="#cb79-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-73"><a href="#cb79-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the reference is a string identifier</span></span>
<span id="cb79-74"><a href="#cb79-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(ref_value, <span class="bu">str</span>):</span>
<span id="cb79-75"><a href="#cb79-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to find existing instance with this ID</span></span>
<span id="cb79-76"><a href="#cb79-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cls <span class="kw">in</span> onto.classes():</span>
<span id="cb79-77"><a href="#cb79-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> instance <span class="kw">in</span> cls.instances():</span>
<span id="cb79-78"><a href="#cb79-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instance.name <span class="op">==</span> ref_value:</span>
<span id="cb79-79"><a href="#cb79-79" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> instance</span>
<span id="cb79-80"><a href="#cb79-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-81"><a href="#cb79-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Not found - could create a stub instance</span></span>
<span id="cb79-82"><a href="#cb79-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb79-83"><a href="#cb79-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-84"><a href="#cb79-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the reference is a dictionary (nested entity)</span></span>
<span id="cb79-85"><a href="#cb79-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(ref_value, <span class="bu">dict</span>):</span>
<span id="cb79-86"><a href="#cb79-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"type"</span> <span class="kw">in</span> ref_value <span class="kw">and</span> ref_value[<span class="st">"type"</span>] <span class="kw">in</span> mapping[<span class="st">"class_mappings"</span>]:</span>
<span id="cb79-87"><a href="#cb79-87" aria-hidden="true" tabindex="-1"></a>            ontology_class_name <span class="op">=</span> mapping[<span class="st">"class_mappings"</span>][ref_value[<span class="st">"type"</span>]]</span>
<span id="cb79-88"><a href="#cb79-88" aria-hidden="true" tabindex="-1"></a>            ontology_class <span class="op">=</span> <span class="bu">getattr</span>(onto, ontology_class_name)</span>
<span id="cb79-89"><a href="#cb79-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-90"><a href="#cb79-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"id"</span> <span class="kw">in</span> ref_value:</span>
<span id="cb79-91"><a href="#cb79-91" aria-hidden="true" tabindex="-1"></a>                instance_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ontology_class_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>ref_value[<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb79-92"><a href="#cb79-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb79-93"><a href="#cb79-93" aria-hidden="true" tabindex="-1"></a>                instance_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>ontology_class_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span><span class="bu">len</span>(<span class="bu">list</span>(ontology_class.instances()))<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb79-94"><a href="#cb79-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-95"><a href="#cb79-95" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if instance already exists</span></span>
<span id="cb79-96"><a href="#cb79-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> instance <span class="kw">in</span> ontology_class.instances():</span>
<span id="cb79-97"><a href="#cb79-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> instance.name <span class="op">==</span> instance_id:</span>
<span id="cb79-98"><a href="#cb79-98" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> instance</span>
<span id="cb79-99"><a href="#cb79-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-100"><a href="#cb79-100" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create new instance</span></span>
<span id="cb79-101"><a href="#cb79-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ontology_class(instance_id)</span>
<span id="cb79-102"><a href="#cb79-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-103"><a href="#cb79-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb79-104"><a href="#cb79-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-105"><a href="#cb79-105" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_integrated_data(onto):</span>
<span id="cb79-106"><a href="#cb79-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract the integrated data from the ontology"""</span></span>
<span id="cb79-107"><a href="#cb79-107" aria-hidden="true" tabindex="-1"></a>    integrated_data <span class="op">=</span> {}</span>
<span id="cb79-108"><a href="#cb79-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-109"><a href="#cb79-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each class in the ontology</span></span>
<span id="cb79-110"><a href="#cb79-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cls <span class="kw">in</span> onto.classes():</span>
<span id="cb79-111"><a href="#cb79-111" aria-hidden="true" tabindex="-1"></a>        class_name <span class="op">=</span> cls.name</span>
<span id="cb79-112"><a href="#cb79-112" aria-hidden="true" tabindex="-1"></a>        integrated_data[class_name] <span class="op">=</span> []</span>
<span id="cb79-113"><a href="#cb79-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-114"><a href="#cb79-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process each instance of the class</span></span>
<span id="cb79-115"><a href="#cb79-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> instance <span class="kw">in</span> cls.instances():</span>
<span id="cb79-116"><a href="#cb79-116" aria-hidden="true" tabindex="-1"></a>            instance_data <span class="op">=</span> {<span class="st">"id"</span>: instance.name}</span>
<span id="cb79-117"><a href="#cb79-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-118"><a href="#cb79-118" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get all property values</span></span>
<span id="cb79-119"><a href="#cb79-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> prop <span class="kw">in</span> onto.object_properties() <span class="op">+</span> onto.data_properties():</span>
<span id="cb79-120"><a href="#cb79-120" aria-hidden="true" tabindex="-1"></a>                values <span class="op">=</span> <span class="bu">getattr</span>(instance, prop.name)</span>
<span id="cb79-121"><a href="#cb79-121" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> values:</span>
<span id="cb79-122"><a href="#cb79-122" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Convert to appropriate representation</span></span>
<span id="cb79-123"><a href="#cb79-123" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">isinstance</span>(values, <span class="bu">list</span>):</span>
<span id="cb79-124"><a href="#cb79-124" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Multiple values</span></span>
<span id="cb79-125"><a href="#cb79-125" aria-hidden="true" tabindex="-1"></a>                        instance_data[prop.name] <span class="op">=</span> [</span>
<span id="cb79-126"><a href="#cb79-126" aria-hidden="true" tabindex="-1"></a>                            v.name <span class="cf">if</span> <span class="bu">hasattr</span>(v, <span class="st">'name'</span>) <span class="cf">else</span> v</span>
<span id="cb79-127"><a href="#cb79-127" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> v <span class="kw">in</span> values</span>
<span id="cb79-128"><a href="#cb79-128" aria-hidden="true" tabindex="-1"></a>                        ]</span>
<span id="cb79-129"><a href="#cb79-129" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb79-130"><a href="#cb79-130" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Single value</span></span>
<span id="cb79-131"><a href="#cb79-131" aria-hidden="true" tabindex="-1"></a>                        instance_data[prop.name] <span class="op">=</span> (</span>
<span id="cb79-132"><a href="#cb79-132" aria-hidden="true" tabindex="-1"></a>                            values.name <span class="cf">if</span> <span class="bu">hasattr</span>(values, <span class="st">'name'</span>) <span class="cf">else</span> values</span>
<span id="cb79-133"><a href="#cb79-133" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb79-134"><a href="#cb79-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-135"><a href="#cb79-135" aria-hidden="true" tabindex="-1"></a>            integrated_data[class_name].append(instance_data)</span>
<span id="cb79-136"><a href="#cb79-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-137"><a href="#cb79-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> integrated_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>SPARQL-based ontology integration</strong>:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdflib <span class="im">import</span> Graph, URIRef, Literal, Namespace</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdflib.namespace <span class="im">import</span> RDF, RDFS, OWL</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sparql_based_integration(source_files, mapping_files, ontology_file):</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Integrate multiple RDF sources using SPARQL and a shared ontology</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co">    source_files: List of RDF files containing source data</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="co">    mapping_files: List of SPARQL CONSTRUCT files for mapping</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="co">    ontology_file: RDF file containing the shared ontology</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load shared ontology</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    integrated_graph <span class="op">=</span> Graph()</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    integrated_graph.parse(ontology_file)</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load each source and apply its mapping</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> source_file, mapping_file <span class="kw">in</span> <span class="bu">zip</span>(source_files, mapping_files):</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load source data</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>        source_graph <span class="op">=</span> Graph()</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>        source_graph.parse(source_file)</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load mapping (SPARQL CONSTRUCT query)</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(mapping_file, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>            construct_query <span class="op">=</span> f.read()</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply mapping</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>        mapping_result <span class="op">=</span> source_graph.query(construct_query)</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add mapped triples to integrated graph</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> triple <span class="kw">in</span> mapping_result:</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>            integrated_graph.add(triple)</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply reasoning to integrate further</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is a placeholder - actual reasoning would depend on the specific reasoner</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    apply_owl_reasoning(integrated_graph)</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate against ontology constraints</span></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    validation_results <span class="op">=</span> validate_constraints(integrated_graph)</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract integrated data in a structured format</span></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>    integrated_data <span class="op">=</span> extract_structured_data(integrated_graph)</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"integrated_graph"</span>: integrated_graph,</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"validation"</span>: validation_results,</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"structured_data"</span>: integrated_data</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_owl_reasoning(graph):</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Apply OWL reasoning to the graph"""</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In practice, this would use a specific OWL reasoner</span></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># like HermiT, Pellet, or FaCT++</span></span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Placeholder implementation - in a real system, you would use</span></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a reasoning library or service</span></span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example: Apply RDFS inference</span></span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>    rdfs_rules <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a><span class="st">    PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a><span class="st">    # Subclass transitivity</span></span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a><span class="st">    CONSTRUCT {</span></span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a><span class="st">        ?x rdfs:subClassOf ?z .</span></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE {</span></span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a><span class="st">        ?x rdfs:subClassOf ?y .</span></span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a><span class="st">        ?y rdfs:subClassOf ?z .</span></span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>    inference_results <span class="op">=</span> graph.query(rdfs_rules)</span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> triple <span class="kw">in</span> inference_results:</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>        graph.add(triple)</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># More inference rules would be added here</span></span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_constraints(graph):</span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Validate the integrated graph against ontology constraints"""</span></span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>    validation_results <span class="op">=</span> {</span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"valid"</span>: <span class="va">True</span>,</span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"violations"</span>: []</span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example constraint check: Every Person must have a name</span></span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>    person_name_check <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a><span class="st">    PREFIX ex: &lt;http://example.org/ontology#&gt;</span></span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a><span class="st">    PREFIX rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;</span></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT ?person</span></span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE {</span></span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a><span class="st">        ?person rdf:type ex:Person .</span></span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a><span class="st">        FILTER NOT EXISTS { ?person ex:name ?name }</span></span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> graph.query(person_name_check)</span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> results:</span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a>        validation_results[<span class="st">"valid"</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a>        validation_results[<span class="st">"violations"</span>].append({</span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">"entity"</span>: <span class="bu">str</span>(row[<span class="dv">0</span>]),</span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">"constraint"</span>: <span class="st">"Person must have a name property"</span>,</span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span>: <span class="st">"missing_required_property"</span></span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional constraint checks would be added here</span></span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> validation_results</span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_structured_data(graph):</span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract structured data from the RDF graph"""</span></span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a>    structured_data <span class="op">=</span> {}</span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all classes in the ontology</span></span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a>    class_query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb80-118"><a href="#cb80-118" aria-hidden="true" tabindex="-1"></a><span class="st">    PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span></span>
<span id="cb80-119"><a href="#cb80-119" aria-hidden="true" tabindex="-1"></a><span class="st">    PREFIX owl: &lt;http://www.w3.org/2002/07/owl#&gt;</span></span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT DISTINCT ?class</span></span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE {</span></span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a><span class="st">        { ?class a owl:Class } UNION { ?class a rdfs:Class }</span></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a><span class="st">        FILTER(?class != owl:Class &amp;&amp; ?class != rdfs:Class)</span></span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb80-127"><a href="#cb80-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-128"><a href="#cb80-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> graph.query(class_query):</span>
<span id="cb80-129"><a href="#cb80-129" aria-hidden="true" tabindex="-1"></a>        class_uri <span class="op">=</span> row[<span class="dv">0</span>]</span>
<span id="cb80-130"><a href="#cb80-130" aria-hidden="true" tabindex="-1"></a>        class_name <span class="op">=</span> class_uri.split(<span class="st">'#'</span>)[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> <span class="st">'#'</span> <span class="kw">in</span> class_uri <span class="cf">else</span> class_uri.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb80-131"><a href="#cb80-131" aria-hidden="true" tabindex="-1"></a>        structured_data[class_name] <span class="op">=</span> []</span>
<span id="cb80-132"><a href="#cb80-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-133"><a href="#cb80-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get all instances of this class</span></span>
<span id="cb80-134"><a href="#cb80-134" aria-hidden="true" tabindex="-1"></a>        instance_query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb80-135"><a href="#cb80-135" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT DISTINCT ?instance</span></span>
<span id="cb80-136"><a href="#cb80-136" aria-hidden="true" tabindex="-1"></a><span class="ss">        WHERE </span><span class="ch">{{</span></span>
<span id="cb80-137"><a href="#cb80-137" aria-hidden="true" tabindex="-1"></a><span class="ss">            ?instance a &lt;</span><span class="sc">{</span>class_uri<span class="sc">}</span><span class="ss">&gt; .</span></span>
<span id="cb80-138"><a href="#cb80-138" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span><span class="ch">}}</span></span>
<span id="cb80-139"><a href="#cb80-139" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb80-140"><a href="#cb80-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-141"><a href="#cb80-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> instance_row <span class="kw">in</span> graph.query(instance_query):</span>
<span id="cb80-142"><a href="#cb80-142" aria-hidden="true" tabindex="-1"></a>            instance_uri <span class="op">=</span> instance_row[<span class="dv">0</span>]</span>
<span id="cb80-143"><a href="#cb80-143" aria-hidden="true" tabindex="-1"></a>            instance_data <span class="op">=</span> {<span class="st">"uri"</span>: <span class="bu">str</span>(instance_uri)}</span>
<span id="cb80-144"><a href="#cb80-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-145"><a href="#cb80-145" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get all properties of this instance</span></span>
<span id="cb80-146"><a href="#cb80-146" aria-hidden="true" tabindex="-1"></a>            property_query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb80-147"><a href="#cb80-147" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT ?property ?value</span></span>
<span id="cb80-148"><a href="#cb80-148" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE </span><span class="ch">{{</span></span>
<span id="cb80-149"><a href="#cb80-149" aria-hidden="true" tabindex="-1"></a><span class="ss">                &lt;</span><span class="sc">{</span>instance_uri<span class="sc">}</span><span class="ss">&gt; ?property ?value .</span></span>
<span id="cb80-150"><a href="#cb80-150" aria-hidden="true" tabindex="-1"></a><span class="ss">                FILTER(?property != rdf:type)</span></span>
<span id="cb80-151"><a href="#cb80-151" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span><span class="ch">}}</span></span>
<span id="cb80-152"><a href="#cb80-152" aria-hidden="true" tabindex="-1"></a><span class="ss">            """</span></span>
<span id="cb80-153"><a href="#cb80-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-154"><a href="#cb80-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> prop_row <span class="kw">in</span> graph.query(property_query):</span>
<span id="cb80-155"><a href="#cb80-155" aria-hidden="true" tabindex="-1"></a>                prop_uri <span class="op">=</span> prop_row[<span class="dv">0</span>]</span>
<span id="cb80-156"><a href="#cb80-156" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> prop_row[<span class="dv">1</span>]</span>
<span id="cb80-157"><a href="#cb80-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-158"><a href="#cb80-158" aria-hidden="true" tabindex="-1"></a>                prop_name <span class="op">=</span> prop_uri.split(<span class="st">'#'</span>)[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> <span class="st">'#'</span> <span class="kw">in</span> prop_uri <span class="cf">else</span> prop_uri.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb80-159"><a href="#cb80-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-160"><a href="#cb80-160" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle literal vs. URI values differently</span></span>
<span id="cb80-161"><a href="#cb80-161" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(value, Literal):</span>
<span id="cb80-162"><a href="#cb80-162" aria-hidden="true" tabindex="-1"></a>                    instance_data[prop_name] <span class="op">=</span> value.value</span>
<span id="cb80-163"><a href="#cb80-163" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb80-164"><a href="#cb80-164" aria-hidden="true" tabindex="-1"></a>                    instance_data[prop_name] <span class="op">=</span> <span class="bu">str</span>(value)</span>
<span id="cb80-165"><a href="#cb80-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-166"><a href="#cb80-166" aria-hidden="true" tabindex="-1"></a>            structured_data[class_name].append(instance_data)</span>
<span id="cb80-167"><a href="#cb80-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-168"><a href="#cb80-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> structured_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Modular ontology integration</strong>:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> modular_ontology_integration(domain_ontologies, data_sources, upper_ontology<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Integrate multiple domain ontologies and their data</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">    domain_ontologies: List of domain-specific ontologies</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">    data_sources: List of data sources corresponding to ontologies</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">    upper_ontology: Optional upper ontology for alignment</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create integrated ontology</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    integrated_ontology <span class="op">=</span> Graph()</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add upper ontology if provided</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> upper_ontology:</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>        integrated_ontology.parse(upper_ontology)</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each domain ontology</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    ontology_mappings <span class="op">=</span> []</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (ontology_file, mapping_file) <span class="kw">in</span> <span class="bu">enumerate</span>(domain_ontologies):</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load domain ontology</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>        domain_graph <span class="op">=</span> Graph()</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>        domain_graph.parse(ontology_file)</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load alignment/mapping to upper ontology</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(mapping_file, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>            mapping_data <span class="op">=</span> json.load(f)</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply mappings</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>        mapped_triples <span class="op">=</span> apply_ontology_mapping(domain_graph, mapping_data)</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add mapped ontology to integrated ontology</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> triple <span class="kw">in</span> mapped_triples:</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>            integrated_ontology.add(triple)</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store mappings for data integration</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>        ontology_mappings.append(mapping_data)</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Integrate data sources based on ontology mappings</span></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>    integrated_data <span class="op">=</span> []</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> data_source, mapping <span class="kw">in</span> <span class="bu">zip</span>(data_sources, ontology_mappings):</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform data according to mapping</span></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>        transformed_data <span class="op">=</span> transform_data_with_mapping(data_source, mapping)</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>        integrated_data.extend(transformed_data)</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ontology"</span>: integrated_ontology,</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"data"</span>: integrated_data</span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_ontology_mapping(domain_graph, mapping_data):</span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Apply mappings from a domain ontology to an upper ontology"""</span></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>    result_graph <span class="op">=</span> Graph()</span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Copy all original triples</span></span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> triple <span class="kw">in</span> domain_graph:</span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>        result_graph.add(triple)</span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply class mappings</span></span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> class_mapping <span class="kw">in</span> mapping_data.get(<span class="st">"class_mappings"</span>, []):</span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>        domain_class <span class="op">=</span> URIRef(class_mapping[<span class="st">"domain_class"</span>])</span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>        upper_class <span class="op">=</span> URIRef(class_mapping[<span class="st">"upper_class"</span>])</span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>        relation <span class="op">=</span> URIRef(class_mapping.get(<span class="st">"relation"</span>, <span class="bu">str</span>(RDFS.subClassOf)))</span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add mapping triple</span></span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a>        result_graph.add((domain_class, relation, upper_class))</span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply property mappings</span></span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> prop_mapping <span class="kw">in</span> mapping_data.get(<span class="st">"property_mappings"</span>, []):</span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>        domain_prop <span class="op">=</span> URIRef(prop_mapping[<span class="st">"domain_property"</span>])</span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>        upper_prop <span class="op">=</span> URIRef(prop_mapping[<span class="st">"upper_property"</span>])</span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>        relation <span class="op">=</span> URIRef(prop_mapping.get(<span class="st">"relation"</span>, <span class="bu">str</span>(RDFS.subPropertyOf)))</span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add mapping triple</span></span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>        result_graph.add((domain_prop, relation, upper_prop))</span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply instance mappings</span></span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> instance_mapping <span class="kw">in</span> mapping_data.get(<span class="st">"instance_mappings"</span>, []):</span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a>        domain_instance <span class="op">=</span> URIRef(instance_mapping[<span class="st">"domain_instance"</span>])</span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a>        upper_instance <span class="op">=</span> URIRef(instance_mapping[<span class="st">"upper_instance"</span>])</span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a>        relation <span class="op">=</span> URIRef(instance_mapping.get(<span class="st">"relation"</span>, <span class="bu">str</span>(OWL.sameAs)))</span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add mapping triple</span></span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>        result_graph.add((domain_instance, relation, upper_instance))</span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result_graph</span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_data_with_mapping(data_source, mapping_data):</span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Transform data according to ontology mappings"""</span></span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a>    transformed_data <span class="op">=</span> []</span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data</span></span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(data_source, <span class="bu">str</span>):</span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assume it's a file path</span></span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(data_source, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a>            source_data <span class="op">=</span> json.load(f)</span>
<span id="cb81-95"><a href="#cb81-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb81-96"><a href="#cb81-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Already loaded data</span></span>
<span id="cb81-97"><a href="#cb81-97" aria-hidden="true" tabindex="-1"></a>        source_data <span class="op">=</span> data_source</span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get reverse mappings for transformation</span></span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a>    class_map <span class="op">=</span> {m[<span class="st">"domain_class"</span>]: m[<span class="st">"upper_class"</span>] <span class="cf">for</span> m <span class="kw">in</span> mapping_data.get(<span class="st">"class_mappings"</span>, [])}</span>
<span id="cb81-101"><a href="#cb81-101" aria-hidden="true" tabindex="-1"></a>    property_map <span class="op">=</span> {m[<span class="st">"domain_property"</span>]: m[<span class="st">"upper_property"</span>] <span class="cf">for</span> m <span class="kw">in</span> mapping_data.get(<span class="st">"property_mappings"</span>, [])}</span>
<span id="cb81-102"><a href="#cb81-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-103"><a href="#cb81-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform each entity</span></span>
<span id="cb81-104"><a href="#cb81-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity <span class="kw">in</span> source_data:</span>
<span id="cb81-105"><a href="#cb81-105" aria-hidden="true" tabindex="-1"></a>        transformed_entity <span class="op">=</span> {}</span>
<span id="cb81-106"><a href="#cb81-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-107"><a href="#cb81-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform type if present</span></span>
<span id="cb81-108"><a href="#cb81-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"type"</span> <span class="kw">in</span> entity <span class="kw">and</span> entity[<span class="st">"type"</span>] <span class="kw">in</span> class_map:</span>
<span id="cb81-109"><a href="#cb81-109" aria-hidden="true" tabindex="-1"></a>            transformed_entity[<span class="st">"type"</span>] <span class="op">=</span> class_map[entity[<span class="st">"type"</span>]]</span>
<span id="cb81-110"><a href="#cb81-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb81-111"><a href="#cb81-111" aria-hidden="true" tabindex="-1"></a>            transformed_entity[<span class="st">"type"</span>] <span class="op">=</span> entity.get(<span class="st">"type"</span>)</span>
<span id="cb81-112"><a href="#cb81-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-113"><a href="#cb81-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform ID and basic properties</span></span>
<span id="cb81-114"><a href="#cb81-114" aria-hidden="true" tabindex="-1"></a>        transformed_entity[<span class="st">"id"</span>] <span class="op">=</span> entity.get(<span class="st">"id"</span>)</span>
<span id="cb81-115"><a href="#cb81-115" aria-hidden="true" tabindex="-1"></a>        transformed_entity[<span class="st">"source"</span>] <span class="op">=</span> entity.get(<span class="st">"source"</span>, <span class="st">"unknown"</span>)</span>
<span id="cb81-116"><a href="#cb81-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-117"><a href="#cb81-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform other properties</span></span>
<span id="cb81-118"><a href="#cb81-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> prop, value <span class="kw">in</span> entity.items():</span>
<span id="cb81-119"><a href="#cb81-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop <span class="kw">in</span> [<span class="st">"type"</span>, <span class="st">"id"</span>, <span class="st">"source"</span>]:</span>
<span id="cb81-120"><a href="#cb81-120" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb81-121"><a href="#cb81-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-122"><a href="#cb81-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop <span class="kw">in</span> property_map:</span>
<span id="cb81-123"><a href="#cb81-123" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Map property name</span></span>
<span id="cb81-124"><a href="#cb81-124" aria-hidden="true" tabindex="-1"></a>                mapped_prop <span class="op">=</span> property_map[prop]</span>
<span id="cb81-125"><a href="#cb81-125" aria-hidden="true" tabindex="-1"></a>                transformed_entity[mapped_prop] <span class="op">=</span> value</span>
<span id="cb81-126"><a href="#cb81-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb81-127"><a href="#cb81-127" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Keep original property</span></span>
<span id="cb81-128"><a href="#cb81-128" aria-hidden="true" tabindex="-1"></a>                transformed_entity[prop] <span class="op">=</span> value</span>
<span id="cb81-129"><a href="#cb81-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-130"><a href="#cb81-130" aria-hidden="true" tabindex="-1"></a>        transformed_data.append(transformed_entity)</span>
<span id="cb81-131"><a href="#cb81-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-132"><a href="#cb81-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> transformed_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in ontology-based integration include:</p>
<ol type="1">
<li><strong>Ontology complexity</strong>: Balancing expressivity with usability</li>
<li><strong>Reasoning scalability</strong>: Handling large-scale inference over integrated data</li>
<li><strong>Mapping complexity</strong>: Creating and maintaining complex ontology alignments</li>
<li><strong>Inconsistency management</strong>: Resolving conflicts between integrated ontologies</li>
<li><strong>User adoption</strong>: Making ontology-based approaches accessible to data practitioners</li>
</ol>
</section>
</section>
<section id="quality-assessment-and-enrichment" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="quality-assessment-and-enrichment"><span class="header-section-number">6.6</span> Quality assessment and enrichment</h2>
<p>Ensuring the quality of a constructed knowledge graph and enhancing it with additional knowledge is crucial for its usefulness and reliability.</p>
<section id="knowledge-graph-quality-dimensions" class="level3" data-number="6.6.1">
<h3 data-number="6.6.1" class="anchored" data-anchor-id="knowledge-graph-quality-dimensions"><span class="header-section-number">6.6.1</span> Knowledge graph quality dimensions</h3>
<p>Quality assessment for knowledge graphs spans multiple dimensions:</p>
<div id="def-quality-dimensions" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.20 (Knowledge graph quality dimensions)</strong></span> <strong>Knowledge graph quality dimensions</strong> are aspects by which the quality of a knowledge graph can be evaluated:</p>
<ol type="1">
<li><strong>Accuracy</strong>: Correctness of the information in the knowledge graph</li>
<li><strong>Completeness</strong>: Coverage of the relevant domain knowledge</li>
<li><strong>Consistency</strong>: Absence of contradictions and adherence to schema constraints</li>
<li><strong>Timeliness</strong>: Currency and freshness of the information</li>
<li><strong>Accessibility</strong>: Ease of accessing and querying the knowledge</li>
<li><strong>Relevance</strong>: Importance of the included information for target applications</li>
<li><strong>Trustworthiness</strong>: Reliability and credibility of the information sources</li>
<li><strong>Verifiability</strong>: Ability to trace information to its original sources</li>
</ol>
<p>These dimensions can be assessed through various metrics and evaluation techniques.</p>
</div>
<div id="exm-quality-dimensions" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.32 (Knowledge graph quality examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Accuracy assessment</strong>:</p>
<pre><code>Entity: Albert Einstein
Attribute: birthDate
Value: "1879-03-14"

Accuracy check:
- External validation against authoritative sources
- Multiple source agreement: 8/10 sources confirm (80% agreement)
- No logical inconsistencies (e.g., not before parent's birth)
- Format validation passes (valid date format)

Result: High accuracy (0.95)</code></pre></li>
<li><p><strong>Completeness assessment</strong>:</p>
<pre><code>Domain: Scientists
Schema completeness:
- Required properties: name, birthDate, field, nationality, notableWorks
- Optional properties: deathDate, awards, education, influences

Entity: Marie Curie
- Present properties: name, birthDate, deathDate, field, nationality, notableWorks, awards
- Missing properties: education, influences

Result:
- Required property completeness: 100%
- Overall property completeness: 78%
- Population completeness: Coverage of 85% of Nobel Prize winners in Physics and Chemistry</code></pre></li>
<li><p><strong>Consistency assessment</strong>:</p>
<pre><code>Logical consistency check:
- Schema constraint: A person's death date must be after their birth date
- Ontological constraint: A person cannot be both a student and a teacher of the same person
- Type constraint: All values for "population" must be positive integers

Violations found:
- Entity "John Smith" has birthDate "1980-01-01" but deathDate "1970-12-31"
- Entity "London" has population "-5000" (negative value)

Result: 98.7% of entities satisfy all consistency constraints</code></pre></li>
</ol>
</div>
<p>Approaches to quality assessment include:</p>
<ol type="1">
<li><p><strong>Manual assessment</strong>:</p>
<ul>
<li>Expert review of knowledge graph content</li>
<li>User feedback and error reporting</li>
<li>Advantages: High precision, domain expertise</li>
<li>Disadvantages: Limited scalability, subjective judgments</li>
</ul></li>
<li><p><strong>Automated assessment</strong>:</p>
<ul>
<li>Rule-based validation using schema constraints</li>
<li>Statistical analysis of patterns and outliers</li>
<li>Cross-reference checking with external sources</li>
<li>Advantages: Scalability, objectivity</li>
<li>Disadvantages: Limited semantic understanding</li>
</ul></li>
<li><p><strong>Hybrid approaches</strong>:</p>
<ul>
<li>Automated detection of potential issues</li>
<li>Manual review of flagged problems</li>
<li>Continuous monitoring with periodic expert validation</li>
<li>Advantages: Efficient use of human expertise</li>
<li>Disadvantages: Workflow complexity</li>
</ul></li>
</ol>
<div id="exm-quality-assessment-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.33 (Quality assessment implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Accuracy assessment implementation</strong>:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assess_accuracy(knowledge_graph, reference_sources<span class="op">=</span><span class="va">None</span>, sample_size<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Assess the accuracy of a knowledge graph</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co">    knowledge_graph: The knowledge graph to assess</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co">    reference_sources: Optional list of trusted external sources</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co">    sample_size: Number of facts to sample for manual validation</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    accuracy_metrics <span class="op">=</span> {</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"overall"</span>: <span class="fl">0.0</span>,</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"by_relation_type"</span>: {},</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"by_entity_type"</span>: {},</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample_results"</span>: []</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If reference sources are provided, check against them</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_sources:</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each entity in the knowledge graph</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>        correct_facts <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>        total_checked_facts <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>            entity_type <span class="op">=</span> entity_data.get(<span class="st">"type"</span>)</span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For each attribute of the entity</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> attribute, value <span class="kw">in</span> entity_data.items():</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> attribute <span class="kw">in</span> [<span class="st">"id"</span>, <span class="st">"type"</span>, <span class="st">"source"</span>]:</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check this fact against reference sources</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>                fact_correct <span class="op">=</span> check_fact_against_references(</span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>                    entity_id, attribute, value, reference_sources</span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> fact_correct <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>                    total_checked_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> fact_correct:</span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>                        correct_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Track by relation type</span></span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> attribute <span class="kw">not</span> <span class="kw">in</span> accuracy_metrics[<span class="st">"by_relation_type"</span>]:</span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>                        accuracy_metrics[<span class="st">"by_relation_type"</span>][attribute] <span class="op">=</span> {</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"correct"</span>: <span class="dv">0</span>, <span class="st">"total"</span>: <span class="dv">0</span></span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>                    accuracy_metrics[<span class="st">"by_relation_type"</span>][attribute][<span class="st">"total"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> fact_correct:</span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>                        accuracy_metrics[<span class="st">"by_relation_type"</span>][attribute][<span class="st">"correct"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-50"><a href="#cb85-50" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Track by entity type</span></span>
<span id="cb85-51"><a href="#cb85-51" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> entity_type:</span>
<span id="cb85-52"><a href="#cb85-52" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> entity_type <span class="kw">not</span> <span class="kw">in</span> accuracy_metrics[<span class="st">"by_entity_type"</span>]:</span>
<span id="cb85-53"><a href="#cb85-53" aria-hidden="true" tabindex="-1"></a>                            accuracy_metrics[<span class="st">"by_entity_type"</span>][entity_type] <span class="op">=</span> {</span>
<span id="cb85-54"><a href="#cb85-54" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"correct"</span>: <span class="dv">0</span>, <span class="st">"total"</span>: <span class="dv">0</span></span>
<span id="cb85-55"><a href="#cb85-55" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb85-56"><a href="#cb85-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-57"><a href="#cb85-57" aria-hidden="true" tabindex="-1"></a>                        accuracy_metrics[<span class="st">"by_entity_type"</span>][entity_type][<span class="st">"total"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-58"><a href="#cb85-58" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> fact_correct:</span>
<span id="cb85-59"><a href="#cb85-59" aria-hidden="true" tabindex="-1"></a>                            accuracy_metrics[<span class="st">"by_entity_type"</span>][entity_type][<span class="st">"correct"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-60"><a href="#cb85-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-61"><a href="#cb85-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate overall accuracy</span></span>
<span id="cb85-62"><a href="#cb85-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_checked_facts <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb85-63"><a href="#cb85-63" aria-hidden="true" tabindex="-1"></a>            accuracy_metrics[<span class="st">"overall"</span>] <span class="op">=</span> correct_facts <span class="op">/</span> total_checked_facts</span>
<span id="cb85-64"><a href="#cb85-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-65"><a href="#cb85-65" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate accuracy by relation type</span></span>
<span id="cb85-66"><a href="#cb85-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> rel_type <span class="kw">in</span> accuracy_metrics[<span class="st">"by_relation_type"</span>]:</span>
<span id="cb85-67"><a href="#cb85-67" aria-hidden="true" tabindex="-1"></a>                rel_data <span class="op">=</span> accuracy_metrics[<span class="st">"by_relation_type"</span>][rel_type]</span>
<span id="cb85-68"><a href="#cb85-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> rel_data[<span class="st">"total"</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb85-69"><a href="#cb85-69" aria-hidden="true" tabindex="-1"></a>                    rel_data[<span class="st">"accuracy"</span>] <span class="op">=</span> rel_data[<span class="st">"correct"</span>] <span class="op">/</span> rel_data[<span class="st">"total"</span>]</span>
<span id="cb85-70"><a href="#cb85-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-71"><a href="#cb85-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate accuracy by entity type</span></span>
<span id="cb85-72"><a href="#cb85-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> entity_type <span class="kw">in</span> accuracy_metrics[<span class="st">"by_entity_type"</span>]:</span>
<span id="cb85-73"><a href="#cb85-73" aria-hidden="true" tabindex="-1"></a>                type_data <span class="op">=</span> accuracy_metrics[<span class="st">"by_entity_type"</span>][entity_type]</span>
<span id="cb85-74"><a href="#cb85-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> type_data[<span class="st">"total"</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb85-75"><a href="#cb85-75" aria-hidden="true" tabindex="-1"></a>                    type_data[<span class="st">"accuracy"</span>] <span class="op">=</span> type_data[<span class="st">"correct"</span>] <span class="op">/</span> type_data[<span class="st">"total"</span>]</span>
<span id="cb85-76"><a href="#cb85-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-77"><a href="#cb85-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample facts for manual validation if needed</span></span>
<span id="cb85-78"><a href="#cb85-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sample_size <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb85-79"><a href="#cb85-79" aria-hidden="true" tabindex="-1"></a>        sampled_facts <span class="op">=</span> sample_facts_for_validation(knowledge_graph, sample_size)</span>
<span id="cb85-80"><a href="#cb85-80" aria-hidden="true" tabindex="-1"></a>        accuracy_metrics[<span class="st">"sample_results"</span>] <span class="op">=</span> sampled_facts</span>
<span id="cb85-81"><a href="#cb85-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-82"><a href="#cb85-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> accuracy_metrics</span>
<span id="cb85-83"><a href="#cb85-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-84"><a href="#cb85-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_fact_against_references(entity_id, attribute, value, reference_sources):</span>
<span id="cb85-85"><a href="#cb85-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb85-86"><a href="#cb85-86" aria-hidden="true" tabindex="-1"></a><span class="co">    Check a single fact against reference sources</span></span>
<span id="cb85-87"><a href="#cb85-87" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns True if correct, False if incorrect, None if not found</span></span>
<span id="cb85-88"><a href="#cb85-88" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb85-89"><a href="#cb85-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> source <span class="kw">in</span> reference_sources:</span>
<span id="cb85-90"><a href="#cb85-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This would be implemented differently depending on the type of reference</span></span>
<span id="cb85-91"><a href="#cb85-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For example, API calls to external knowledge bases, database queries, etc.</span></span>
<span id="cb85-92"><a href="#cb85-92" aria-hidden="true" tabindex="-1"></a>        reference_value <span class="op">=</span> source.lookup_fact(entity_id, attribute)</span>
<span id="cb85-93"><a href="#cb85-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-94"><a href="#cb85-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> reference_value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb85-95"><a href="#cb85-95" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compare values (allowing for slight variation)</span></span>
<span id="cb85-96"><a href="#cb85-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> values_match(value, reference_value)</span>
<span id="cb85-97"><a href="#cb85-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-98"><a href="#cb85-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Not found in any reference</span></span>
<span id="cb85-99"><a href="#cb85-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb85-100"><a href="#cb85-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-101"><a href="#cb85-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> values_match(value1, value2, tolerance<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb85-102"><a href="#cb85-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compare two values with tolerance for different formats/styles"""</span></span>
<span id="cb85-103"><a href="#cb85-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value1 <span class="op">==</span> value2:</span>
<span id="cb85-104"><a href="#cb85-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb85-105"><a href="#cb85-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-106"><a href="#cb85-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For numeric values, check if they're close</span></span>
<span id="cb85-107"><a href="#cb85-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(value1, (<span class="bu">int</span>, <span class="bu">float</span>)) <span class="kw">and</span> <span class="bu">isinstance</span>(value2, (<span class="bu">int</span>, <span class="bu">float</span>)):</span>
<span id="cb85-108"><a href="#cb85-108" aria-hidden="true" tabindex="-1"></a>        diff <span class="op">=</span> <span class="bu">abs</span>(value1 <span class="op">-</span> value2)</span>
<span id="cb85-109"><a href="#cb85-109" aria-hidden="true" tabindex="-1"></a>        avg <span class="op">=</span> (<span class="bu">abs</span>(value1) <span class="op">+</span> <span class="bu">abs</span>(value2)) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb85-110"><a href="#cb85-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-111"><a href="#cb85-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> avg <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb85-112"><a href="#cb85-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> diff <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb85-113"><a href="#cb85-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-114"><a href="#cb85-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> diff <span class="op">/</span> avg <span class="op">&lt;=</span> tolerance</span>
<span id="cb85-115"><a href="#cb85-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-116"><a href="#cb85-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For string values, check similarity</span></span>
<span id="cb85-117"><a href="#cb85-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(value1, <span class="bu">str</span>) <span class="kw">and</span> <span class="bu">isinstance</span>(value2, <span class="bu">str</span>):</span>
<span id="cb85-118"><a href="#cb85-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Simple normalization</span></span>
<span id="cb85-119"><a href="#cb85-119" aria-hidden="true" tabindex="-1"></a>        v1 <span class="op">=</span> value1.lower().strip()</span>
<span id="cb85-120"><a href="#cb85-120" aria-hidden="true" tabindex="-1"></a>        v2 <span class="op">=</span> value2.lower().strip()</span>
<span id="cb85-121"><a href="#cb85-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-122"><a href="#cb85-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v1 <span class="op">==</span> v2:</span>
<span id="cb85-123"><a href="#cb85-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb85-124"><a href="#cb85-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-125"><a href="#cb85-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if one is contained in the other</span></span>
<span id="cb85-126"><a href="#cb85-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v1 <span class="kw">in</span> v2 <span class="kw">or</span> v2 <span class="kw">in</span> v1:</span>
<span id="cb85-127"><a href="#cb85-127" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb85-128"><a href="#cb85-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-129"><a href="#cb85-129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Could add more sophisticated string similarity here</span></span>
<span id="cb85-130"><a href="#cb85-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Such as Levenshtein distance, Jaccard similarity, etc.</span></span>
<span id="cb85-131"><a href="#cb85-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-132"><a href="#cb85-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For lists, check if they contain similar elements</span></span>
<span id="cb85-133"><a href="#cb85-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(value1, <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">isinstance</span>(value2, <span class="bu">list</span>):</span>
<span id="cb85-134"><a href="#cb85-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if at least 70% of elements match</span></span>
<span id="cb85-135"><a href="#cb85-135" aria-hidden="true" tabindex="-1"></a>        matches <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb85-136"><a href="#cb85-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v1 <span class="kw">in</span> value1:</span>
<span id="cb85-137"><a href="#cb85-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(values_match(v1, v2) <span class="cf">for</span> v2 <span class="kw">in</span> value2):</span>
<span id="cb85-138"><a href="#cb85-138" aria-hidden="true" tabindex="-1"></a>                matches <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-139"><a href="#cb85-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-140"><a href="#cb85-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(value1) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb85-141"><a href="#cb85-141" aria-hidden="true" tabindex="-1"></a>            match_ratio <span class="op">=</span> matches <span class="op">/</span> <span class="bu">len</span>(value1)</span>
<span id="cb85-142"><a href="#cb85-142" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> match_ratio <span class="op">&gt;=</span> <span class="fl">0.7</span></span>
<span id="cb85-143"><a href="#cb85-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-144"><a href="#cb85-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb85-145"><a href="#cb85-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-146"><a href="#cb85-146" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_facts_for_validation(knowledge_graph, sample_size):</span>
<span id="cb85-147"><a href="#cb85-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sample facts from the knowledge graph for manual validation"""</span></span>
<span id="cb85-148"><a href="#cb85-148" aria-hidden="true" tabindex="-1"></a>    all_facts <span class="op">=</span> []</span>
<span id="cb85-149"><a href="#cb85-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-150"><a href="#cb85-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect all facts</span></span>
<span id="cb85-151"><a href="#cb85-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb85-152"><a href="#cb85-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attribute, value <span class="kw">in</span> entity_data.items():</span>
<span id="cb85-153"><a href="#cb85-153" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attribute <span class="kw">in</span> [<span class="st">"id"</span>, <span class="st">"type"</span>, <span class="st">"source"</span>]:</span>
<span id="cb85-154"><a href="#cb85-154" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb85-155"><a href="#cb85-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-156"><a href="#cb85-156" aria-hidden="true" tabindex="-1"></a>            all_facts.append({</span>
<span id="cb85-157"><a href="#cb85-157" aria-hidden="true" tabindex="-1"></a>                <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb85-158"><a href="#cb85-158" aria-hidden="true" tabindex="-1"></a>                <span class="st">"entity_name"</span>: entity_data.get(<span class="st">"name"</span>, entity_id),</span>
<span id="cb85-159"><a href="#cb85-159" aria-hidden="true" tabindex="-1"></a>                <span class="st">"attribute"</span>: attribute,</span>
<span id="cb85-160"><a href="#cb85-160" aria-hidden="true" tabindex="-1"></a>                <span class="st">"value"</span>: value,</span>
<span id="cb85-161"><a href="#cb85-161" aria-hidden="true" tabindex="-1"></a>                <span class="st">"validation_status"</span>: <span class="st">"pending"</span>  <span class="co"># To be filled in manually</span></span>
<span id="cb85-162"><a href="#cb85-162" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb85-163"><a href="#cb85-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-164"><a href="#cb85-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly sample facts</span></span>
<span id="cb85-165"><a href="#cb85-165" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> random</span>
<span id="cb85-166"><a href="#cb85-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sample_size <span class="op">&lt;</span> <span class="bu">len</span>(all_facts):</span>
<span id="cb85-167"><a href="#cb85-167" aria-hidden="true" tabindex="-1"></a>        sampled_facts <span class="op">=</span> random.sample(all_facts, sample_size)</span>
<span id="cb85-168"><a href="#cb85-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb85-169"><a href="#cb85-169" aria-hidden="true" tabindex="-1"></a>        sampled_facts <span class="op">=</span> all_facts</span>
<span id="cb85-170"><a href="#cb85-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-171"><a href="#cb85-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sampled_facts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Completeness assessment implementation</strong>:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assess_completeness(knowledge_graph, schema<span class="op">=</span><span class="va">None</span>, reference_population<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Assess the completeness of a knowledge graph</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co">    knowledge_graph: The knowledge graph to assess</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co">    schema: Optional schema defining required and optional properties</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co">    reference_population: Optional reference population for coverage assessment</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    completeness_metrics <span class="op">=</span> {</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"schema_completeness"</span>: {},</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"population_completeness"</span>: {},</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"overall_completeness"</span>: <span class="fl">0.0</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Schema completeness</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> schema:</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>        by_entity_type <span class="op">=</span> {}</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process each entity</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>            entity_type <span class="op">=</span> entity_data.get(<span class="st">"type"</span>)</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> entity_type <span class="kw">and</span> entity_type <span class="kw">in</span> schema:</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Initialize metrics for this type if first encounter</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> entity_type <span class="kw">not</span> <span class="kw">in</span> by_entity_type:</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>                    type_schema <span class="op">=</span> schema[entity_type]</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>                    required_props <span class="op">=</span> type_schema.get(<span class="st">"required_properties"</span>, [])</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>                    optional_props <span class="op">=</span> type_schema.get(<span class="st">"optional_properties"</span>, [])</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>                    all_props <span class="op">=</span> required_props <span class="op">+</span> optional_props</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>                    by_entity_type[entity_type] <span class="op">=</span> {</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"entity_count"</span>: <span class="dv">0</span>,</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"required_completeness"</span>: {</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"total_required"</span>: <span class="bu">len</span>(required_props) <span class="op">*</span> <span class="dv">0</span>,  <span class="co"># Will be updated</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"total_present"</span>: <span class="dv">0</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"overall_completeness"</span>: {</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"total_possible"</span>: <span class="bu">len</span>(all_props) <span class="op">*</span> <span class="dv">0</span>,  <span class="co"># Will be updated</span></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"total_present"</span>: <span class="dv">0</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"by_property"</span>: {prop: {<span class="st">"present"</span>: <span class="dv">0</span>, <span class="st">"total"</span>: <span class="dv">0</span>} <span class="cf">for</span> prop <span class="kw">in</span> all_props}</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update metrics for this entity</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>                by_entity_type[entity_type][<span class="st">"entity_count"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get schema details</span></span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>                type_schema <span class="op">=</span> schema[entity_type]</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>                required_props <span class="op">=</span> type_schema.get(<span class="st">"required_properties"</span>, [])</span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>                optional_props <span class="op">=</span> type_schema.get(<span class="st">"optional_properties"</span>, [])</span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>                all_props <span class="op">=</span> required_props <span class="op">+</span> optional_props</span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update total counts</span></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>                by_entity_type[entity_type][<span class="st">"required_completeness"</span>][<span class="st">"total_required"</span>] <span class="op">+=</span> <span class="bu">len</span>(required_props)</span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>                by_entity_type[entity_type][<span class="st">"overall_completeness"</span>][<span class="st">"total_possible"</span>] <span class="op">+=</span> <span class="bu">len</span>(all_props)</span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check each required property</span></span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> prop <span class="kw">in</span> required_props:</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>                    by_entity_type[entity_type][<span class="st">"by_property"</span>][prop][<span class="st">"total"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> prop <span class="kw">in</span> entity_data:</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>                        by_entity_type[entity_type][<span class="st">"required_completeness"</span>][<span class="st">"total_present"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>                        by_entity_type[entity_type][<span class="st">"overall_completeness"</span>][<span class="st">"total_present"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a>                        by_entity_type[entity_type][<span class="st">"by_property"</span>][prop][<span class="st">"present"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check each optional property</span></span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> prop <span class="kw">in</span> optional_props:</span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>                    by_entity_type[entity_type][<span class="st">"by_property"</span>][prop][<span class="st">"total"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> prop <span class="kw">in</span> entity_data:</span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>                        by_entity_type[entity_type][<span class="st">"overall_completeness"</span>][<span class="st">"total_present"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>                        by_entity_type[entity_type][<span class="st">"by_property"</span>][prop][<span class="st">"present"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate completeness ratios</span></span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity_type, metrics <span class="kw">in</span> by_entity_type.items():</span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Required properties completeness</span></span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>            required <span class="op">=</span> metrics[<span class="st">"required_completeness"</span>]</span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> required[<span class="st">"total_required"</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>                required[<span class="st">"completeness_ratio"</span>] <span class="op">=</span> required[<span class="st">"total_present"</span>] <span class="op">/</span> required[<span class="st">"total_required"</span>]</span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>                required[<span class="st">"completeness_ratio"</span>] <span class="op">=</span> <span class="fl">1.0</span>  <span class="co"># No required properties</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Overall properties completeness</span></span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>            overall <span class="op">=</span> metrics[<span class="st">"overall_completeness"</span>]</span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> overall[<span class="st">"total_possible"</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>                overall[<span class="st">"completeness_ratio"</span>] <span class="op">=</span> overall[<span class="st">"total_present"</span>] <span class="op">/</span> overall[<span class="st">"total_possible"</span>]</span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>                overall[<span class="st">"completeness_ratio"</span>] <span class="op">=</span> <span class="fl">1.0</span>  <span class="co"># No properties defined</span></span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Per-property completeness</span></span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> prop, prop_metrics <span class="kw">in</span> metrics[<span class="st">"by_property"</span>].items():</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prop_metrics[<span class="st">"total"</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>                    prop_metrics[<span class="st">"completeness_ratio"</span>] <span class="op">=</span> prop_metrics[<span class="st">"present"</span>] <span class="op">/</span> prop_metrics[<span class="st">"total"</span>]</span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>                    prop_metrics[<span class="st">"completeness_ratio"</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>        completeness_metrics[<span class="st">"schema_completeness"</span>] <span class="op">=</span> by_entity_type</span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Population completeness</span></span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_population:</span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>        population_coverage <span class="op">=</span> {}</span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity_type, reference_entities <span class="kw">in</span> reference_population.items():</span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count how many reference entities are in the knowledge graph</span></span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>            covered_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> ref_entity <span class="kw">in</span> reference_entities:</span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a>                ref_id <span class="op">=</span> ref_entity.get(<span class="st">"id"</span>)</span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a>                ref_name <span class="op">=</span> ref_entity.get(<span class="st">"name"</span>)</span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check if this reference entity exists in the knowledge graph</span></span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a>                entity_found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check by ID first</span></span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> ref_id <span class="kw">and</span> ref_id <span class="kw">in</span> knowledge_graph:</span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a>                    entity_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check by name if ID not found</span></span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> entity_data.get(<span class="st">"type"</span>) <span class="op">==</span> entity_type <span class="kw">and</span> entity_data.get(<span class="st">"name"</span>) <span class="op">==</span> ref_name:</span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a>                            entity_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> entity_found:</span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a>                    covered_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate coverage ratio</span></span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a>            coverage_ratio <span class="op">=</span> covered_count <span class="op">/</span> <span class="bu">len</span>(reference_entities) <span class="cf">if</span> reference_entities <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a>            population_coverage[entity_type] <span class="op">=</span> {</span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a>                <span class="st">"reference_count"</span>: <span class="bu">len</span>(reference_entities),</span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a>                <span class="st">"covered_count"</span>: covered_count,</span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a>                <span class="st">"coverage_ratio"</span>: coverage_ratio</span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a>        completeness_metrics[<span class="st">"population_completeness"</span>] <span class="op">=</span> population_coverage</span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate overall completeness (simplified)</span></span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This could be a weighted combination of schema and population completeness</span></span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a>    overall_scores <span class="op">=</span> []</span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-140"><a href="#cb86-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add schema completeness scores</span></span>
<span id="cb86-141"><a href="#cb86-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_type, metrics <span class="kw">in</span> completeness_metrics.get(<span class="st">"schema_completeness"</span>, {}).items():</span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a>        overall_scores.append(metrics[<span class="st">"overall_completeness"</span>][<span class="st">"completeness_ratio"</span>])</span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add population completeness scores</span></span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_type, metrics <span class="kw">in</span> completeness_metrics.get(<span class="st">"population_completeness"</span>, {}).items():</span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a>        overall_scores.append(metrics[<span class="st">"coverage_ratio"</span>])</span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-148"><a href="#cb86-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate overall score as average</span></span>
<span id="cb86-149"><a href="#cb86-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> overall_scores:</span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a>        completeness_metrics[<span class="st">"overall_completeness"</span>] <span class="op">=</span> <span class="bu">sum</span>(overall_scores) <span class="op">/</span> <span class="bu">len</span>(overall_scores)</span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> completeness_metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Consistency assessment implementation</strong>:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assess_consistency(knowledge_graph, constraints<span class="op">=</span><span class="va">None</span>, ontology<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Assess the consistency of a knowledge graph</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co">    knowledge_graph: The knowledge graph to assess</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co">    constraints: Optional list of consistency constraints</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ontology: Optional ontology for semantic constraints</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    consistency_metrics <span class="op">=</span> {</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"overall_consistency"</span>: <span class="fl">1.0</span>,</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"violations"</span>: [],</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"constraint_satisfaction"</span>: {}</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    total_facts <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    consistent_facts <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If constraints are provided, check against them</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> constraints:</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize constraint satisfaction metrics</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> constraint <span class="kw">in</span> constraints:</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>            constraint_id <span class="op">=</span> constraint.get(<span class="st">"id"</span>, <span class="ss">f"constraint_</span><span class="sc">{</span><span class="bu">len</span>(consistency_metrics[<span class="st">'constraint_satisfaction'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id] <span class="op">=</span> {</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"description"</span>: constraint.get(<span class="st">"description"</span>, <span class="st">""</span>),</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"total_applicable"</span>: <span class="dv">0</span>,</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"total_satisfied"</span>: <span class="dv">0</span>,</span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"violations"</span>: []</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check each entity against constraints</span></span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>            entity_type <span class="op">=</span> entity_data.get(<span class="st">"type"</span>)</span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For each constraint</span></span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> constraint <span class="kw">in</span> constraints:</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a>                constraint_id <span class="op">=</span> constraint.get(<span class="st">"id"</span>, <span class="ss">f"constraint_</span><span class="sc">{</span><span class="bu">len</span>(consistency_metrics[<span class="st">'constraint_satisfaction'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>                constraint_type <span class="op">=</span> constraint.get(<span class="st">"type"</span>)</span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Skip if constraint doesn't apply to this entity type</span></span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a>                applicable_types <span class="op">=</span> constraint.get(<span class="st">"applicable_types"</span>, [])</span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> applicable_types <span class="kw">and</span> entity_type <span class="kw">not</span> <span class="kw">in</span> applicable_types:</span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb87-43"><a href="#cb87-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-44"><a href="#cb87-44" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Mark this constraint as applicable for this entity</span></span>
<span id="cb87-45"><a href="#cb87-45" aria-hidden="true" tabindex="-1"></a>                consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"total_applicable"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-46"><a href="#cb87-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-47"><a href="#cb87-47" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check constraint based on type</span></span>
<span id="cb87-48"><a href="#cb87-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> constraint_type <span class="op">==</span> <span class="st">"property_type"</span>:</span>
<span id="cb87-49"><a href="#cb87-49" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if property has the correct data type</span></span>
<span id="cb87-50"><a href="#cb87-50" aria-hidden="true" tabindex="-1"></a>                    property_name <span class="op">=</span> constraint.get(<span class="st">"property"</span>)</span>
<span id="cb87-51"><a href="#cb87-51" aria-hidden="true" tabindex="-1"></a>                    expected_type <span class="op">=</span> constraint.get(<span class="st">"expected_type"</span>)</span>
<span id="cb87-52"><a href="#cb87-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-53"><a href="#cb87-53" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> property_name <span class="kw">in</span> entity_data:</span>
<span id="cb87-54"><a href="#cb87-54" aria-hidden="true" tabindex="-1"></a>                        value <span class="op">=</span> entity_data[property_name]</span>
<span id="cb87-55"><a href="#cb87-55" aria-hidden="true" tabindex="-1"></a>                        total_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-56"><a href="#cb87-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-57"><a href="#cb87-57" aria-hidden="true" tabindex="-1"></a>                        type_correct <span class="op">=</span> check_property_type(value, expected_type)</span>
<span id="cb87-58"><a href="#cb87-58" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> type_correct:</span>
<span id="cb87-59"><a href="#cb87-59" aria-hidden="true" tabindex="-1"></a>                            consistent_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-60"><a href="#cb87-60" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"total_satisfied"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-61"><a href="#cb87-61" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb87-62"><a href="#cb87-62" aria-hidden="true" tabindex="-1"></a>                            violation <span class="op">=</span> {</span>
<span id="cb87-63"><a href="#cb87-63" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb87-64"><a href="#cb87-64" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"constraint_id"</span>: constraint_id,</span>
<span id="cb87-65"><a href="#cb87-65" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"property"</span>: property_name,</span>
<span id="cb87-66"><a href="#cb87-66" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"value"</span>: value,</span>
<span id="cb87-67"><a href="#cb87-67" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"expected_type"</span>: expected_type,</span>
<span id="cb87-68"><a href="#cb87-68" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"actual_type"</span>: <span class="bu">type</span>(value).<span class="va">__name__</span></span>
<span id="cb87-69"><a href="#cb87-69" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb87-70"><a href="#cb87-70" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-71"><a href="#cb87-71" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-72"><a href="#cb87-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-73"><a href="#cb87-73" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> constraint_type <span class="op">==</span> <span class="st">"cardinality"</span>:</span>
<span id="cb87-74"><a href="#cb87-74" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if property cardinality is within bounds</span></span>
<span id="cb87-75"><a href="#cb87-75" aria-hidden="true" tabindex="-1"></a>                    property_name <span class="op">=</span> constraint.get(<span class="st">"property"</span>)</span>
<span id="cb87-76"><a href="#cb87-76" aria-hidden="true" tabindex="-1"></a>                    min_count <span class="op">=</span> constraint.get(<span class="st">"min_count"</span>, <span class="dv">0</span>)</span>
<span id="cb87-77"><a href="#cb87-77" aria-hidden="true" tabindex="-1"></a>                    max_count <span class="op">=</span> constraint.get(<span class="st">"max_count"</span>)</span>
<span id="cb87-78"><a href="#cb87-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-79"><a href="#cb87-79" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> property_name <span class="kw">in</span> entity_data:</span>
<span id="cb87-80"><a href="#cb87-80" aria-hidden="true" tabindex="-1"></a>                        value <span class="op">=</span> entity_data[property_name]</span>
<span id="cb87-81"><a href="#cb87-81" aria-hidden="true" tabindex="-1"></a>                        total_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-82"><a href="#cb87-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-83"><a href="#cb87-83" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Convert to list if not already</span></span>
<span id="cb87-84"><a href="#cb87-84" aria-hidden="true" tabindex="-1"></a>                        value_list <span class="op">=</span> value <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">list</span>) <span class="cf">else</span> [value]</span>
<span id="cb87-85"><a href="#cb87-85" aria-hidden="true" tabindex="-1"></a>                        count <span class="op">=</span> <span class="bu">len</span>(value_list)</span>
<span id="cb87-86"><a href="#cb87-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-87"><a href="#cb87-87" aria-hidden="true" tabindex="-1"></a>                        cardinality_valid <span class="op">=</span> count <span class="op">&gt;=</span> min_count</span>
<span id="cb87-88"><a href="#cb87-88" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> max_count <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb87-89"><a href="#cb87-89" aria-hidden="true" tabindex="-1"></a>                            cardinality_valid <span class="op">=</span> cardinality_valid <span class="kw">and</span> count <span class="op">&lt;=</span> max_count</span>
<span id="cb87-90"><a href="#cb87-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-91"><a href="#cb87-91" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> cardinality_valid:</span>
<span id="cb87-92"><a href="#cb87-92" aria-hidden="true" tabindex="-1"></a>                            consistent_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-93"><a href="#cb87-93" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"total_satisfied"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-94"><a href="#cb87-94" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb87-95"><a href="#cb87-95" aria-hidden="true" tabindex="-1"></a>                            violation <span class="op">=</span> {</span>
<span id="cb87-96"><a href="#cb87-96" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb87-97"><a href="#cb87-97" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"constraint_id"</span>: constraint_id,</span>
<span id="cb87-98"><a href="#cb87-98" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"property"</span>: property_name,</span>
<span id="cb87-99"><a href="#cb87-99" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"actual_count"</span>: count,</span>
<span id="cb87-100"><a href="#cb87-100" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"min_count"</span>: min_count,</span>
<span id="cb87-101"><a href="#cb87-101" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"max_count"</span>: max_count</span>
<span id="cb87-102"><a href="#cb87-102" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb87-103"><a href="#cb87-103" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-104"><a href="#cb87-104" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-105"><a href="#cb87-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-106"><a href="#cb87-106" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> constraint_type <span class="op">==</span> <span class="st">"value_range"</span>:</span>
<span id="cb87-107"><a href="#cb87-107" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if numeric property is within specified range</span></span>
<span id="cb87-108"><a href="#cb87-108" aria-hidden="true" tabindex="-1"></a>                    property_name <span class="op">=</span> constraint.get(<span class="st">"property"</span>)</span>
<span id="cb87-109"><a href="#cb87-109" aria-hidden="true" tabindex="-1"></a>                    min_value <span class="op">=</span> constraint.get(<span class="st">"min_value"</span>)</span>
<span id="cb87-110"><a href="#cb87-110" aria-hidden="true" tabindex="-1"></a>                    max_value <span class="op">=</span> constraint.get(<span class="st">"max_value"</span>)</span>
<span id="cb87-111"><a href="#cb87-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-112"><a href="#cb87-112" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> property_name <span class="kw">in</span> entity_data:</span>
<span id="cb87-113"><a href="#cb87-113" aria-hidden="true" tabindex="-1"></a>                        value <span class="op">=</span> entity_data[property_name]</span>
<span id="cb87-114"><a href="#cb87-114" aria-hidden="true" tabindex="-1"></a>                        total_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-115"><a href="#cb87-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-116"><a href="#cb87-116" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(value, (<span class="bu">int</span>, <span class="bu">float</span>)):</span>
<span id="cb87-117"><a href="#cb87-117" aria-hidden="true" tabindex="-1"></a>                            range_valid <span class="op">=</span> <span class="va">True</span></span>
<span id="cb87-118"><a href="#cb87-118" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> min_value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb87-119"><a href="#cb87-119" aria-hidden="true" tabindex="-1"></a>                                range_valid <span class="op">=</span> range_valid <span class="kw">and</span> value <span class="op">&gt;=</span> min_value</span>
<span id="cb87-120"><a href="#cb87-120" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> max_value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb87-121"><a href="#cb87-121" aria-hidden="true" tabindex="-1"></a>                                range_valid <span class="op">=</span> range_valid <span class="kw">and</span> value <span class="op">&lt;=</span> max_value</span>
<span id="cb87-122"><a href="#cb87-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-123"><a href="#cb87-123" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> range_valid:</span>
<span id="cb87-124"><a href="#cb87-124" aria-hidden="true" tabindex="-1"></a>                                consistent_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-125"><a href="#cb87-125" aria-hidden="true" tabindex="-1"></a>                                consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"total_satisfied"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-126"><a href="#cb87-126" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">else</span>:</span>
<span id="cb87-127"><a href="#cb87-127" aria-hidden="true" tabindex="-1"></a>                                violation <span class="op">=</span> {</span>
<span id="cb87-128"><a href="#cb87-128" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb87-129"><a href="#cb87-129" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"constraint_id"</span>: constraint_id,</span>
<span id="cb87-130"><a href="#cb87-130" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"property"</span>: property_name,</span>
<span id="cb87-131"><a href="#cb87-131" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"value"</span>: value,</span>
<span id="cb87-132"><a href="#cb87-132" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"min_value"</span>: min_value,</span>
<span id="cb87-133"><a href="#cb87-133" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"max_value"</span>: max_value</span>
<span id="cb87-134"><a href="#cb87-134" aria-hidden="true" tabindex="-1"></a>                                }</span>
<span id="cb87-135"><a href="#cb87-135" aria-hidden="true" tabindex="-1"></a>                                consistency_metrics[<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-136"><a href="#cb87-136" aria-hidden="true" tabindex="-1"></a>                                consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-137"><a href="#cb87-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-138"><a href="#cb87-138" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> constraint_type <span class="op">==</span> <span class="st">"dependency"</span>:</span>
<span id="cb87-139"><a href="#cb87-139" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if when one property exists, another required property also exists</span></span>
<span id="cb87-140"><a href="#cb87-140" aria-hidden="true" tabindex="-1"></a>                    source_property <span class="op">=</span> constraint.get(<span class="st">"source_property"</span>)</span>
<span id="cb87-141"><a href="#cb87-141" aria-hidden="true" tabindex="-1"></a>                    dependent_property <span class="op">=</span> constraint.get(<span class="st">"dependent_property"</span>)</span>
<span id="cb87-142"><a href="#cb87-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-143"><a href="#cb87-143" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> source_property <span class="kw">in</span> entity_data:</span>
<span id="cb87-144"><a href="#cb87-144" aria-hidden="true" tabindex="-1"></a>                        total_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-145"><a href="#cb87-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-146"><a href="#cb87-146" aria-hidden="true" tabindex="-1"></a>                        dependency_satisfied <span class="op">=</span> dependent_property <span class="kw">in</span> entity_data</span>
<span id="cb87-147"><a href="#cb87-147" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> dependency_satisfied:</span>
<span id="cb87-148"><a href="#cb87-148" aria-hidden="true" tabindex="-1"></a>                            consistent_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-149"><a href="#cb87-149" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"total_satisfied"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-150"><a href="#cb87-150" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb87-151"><a href="#cb87-151" aria-hidden="true" tabindex="-1"></a>                            violation <span class="op">=</span> {</span>
<span id="cb87-152"><a href="#cb87-152" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb87-153"><a href="#cb87-153" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"constraint_id"</span>: constraint_id,</span>
<span id="cb87-154"><a href="#cb87-154" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"source_property"</span>: source_property,</span>
<span id="cb87-155"><a href="#cb87-155" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"dependent_property"</span>: dependent_property</span>
<span id="cb87-156"><a href="#cb87-156" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb87-157"><a href="#cb87-157" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-158"><a href="#cb87-158" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-159"><a href="#cb87-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-160"><a href="#cb87-160" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> constraint_type <span class="op">==</span> <span class="st">"custom"</span>:</span>
<span id="cb87-161"><a href="#cb87-161" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Execute custom constraint check</span></span>
<span id="cb87-162"><a href="#cb87-162" aria-hidden="true" tabindex="-1"></a>                    check_function <span class="op">=</span> constraint.get(<span class="st">"check_function"</span>)</span>
<span id="cb87-163"><a href="#cb87-163" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> check_function <span class="kw">and</span> <span class="bu">callable</span>(check_function):</span>
<span id="cb87-164"><a href="#cb87-164" aria-hidden="true" tabindex="-1"></a>                        total_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-165"><a href="#cb87-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-166"><a href="#cb87-166" aria-hidden="true" tabindex="-1"></a>                        is_valid, details <span class="op">=</span> check_function(entity_data)</span>
<span id="cb87-167"><a href="#cb87-167" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> is_valid:</span>
<span id="cb87-168"><a href="#cb87-168" aria-hidden="true" tabindex="-1"></a>                            consistent_facts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-169"><a href="#cb87-169" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"total_satisfied"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-170"><a href="#cb87-170" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb87-171"><a href="#cb87-171" aria-hidden="true" tabindex="-1"></a>                            violation <span class="op">=</span> {</span>
<span id="cb87-172"><a href="#cb87-172" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb87-173"><a href="#cb87-173" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"constraint_id"</span>: constraint_id,</span>
<span id="cb87-174"><a href="#cb87-174" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"details"</span>: details</span>
<span id="cb87-175"><a href="#cb87-175" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb87-176"><a href="#cb87-176" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-177"><a href="#cb87-177" aria-hidden="true" tabindex="-1"></a>                            consistency_metrics[<span class="st">"constraint_satisfaction"</span>][constraint_id][<span class="st">"violations"</span>].append(violation)</span>
<span id="cb87-178"><a href="#cb87-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-179"><a href="#cb87-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If ontology is provided, check for semantic consistency</span></span>
<span id="cb87-180"><a href="#cb87-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ontology:</span>
<span id="cb87-181"><a href="#cb87-181" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This would use an OWL reasoner or similar</span></span>
<span id="cb87-182"><a href="#cb87-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Placeholder for ontology-based consistency checking</span></span>
<span id="cb87-183"><a href="#cb87-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb87-184"><a href="#cb87-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-185"><a href="#cb87-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate overall consistency ratio</span></span>
<span id="cb87-186"><a href="#cb87-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> total_facts <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb87-187"><a href="#cb87-187" aria-hidden="true" tabindex="-1"></a>        consistency_metrics[<span class="st">"overall_consistency"</span>] <span class="op">=</span> consistent_facts <span class="op">/</span> total_facts</span>
<span id="cb87-188"><a href="#cb87-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-189"><a href="#cb87-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate per-constraint satisfaction ratios</span></span>
<span id="cb87-190"><a href="#cb87-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> constraint_id, metrics <span class="kw">in</span> consistency_metrics[<span class="st">"constraint_satisfaction"</span>].items():</span>
<span id="cb87-191"><a href="#cb87-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> metrics[<span class="st">"total_applicable"</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb87-192"><a href="#cb87-192" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">"satisfaction_ratio"</span>] <span class="op">=</span> metrics[<span class="st">"total_satisfied"</span>] <span class="op">/</span> metrics[<span class="st">"total_applicable"</span>]</span>
<span id="cb87-193"><a href="#cb87-193" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb87-194"><a href="#cb87-194" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">"satisfaction_ratio"</span>] <span class="op">=</span> <span class="fl">1.0</span>  <span class="co"># No applicable entities</span></span>
<span id="cb87-195"><a href="#cb87-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-196"><a href="#cb87-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> consistency_metrics</span>
<span id="cb87-197"><a href="#cb87-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-198"><a href="#cb87-198" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_property_type(value, expected_type):</span>
<span id="cb87-199"><a href="#cb87-199" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Check if a property value has the expected type"""</span></span>
<span id="cb87-200"><a href="#cb87-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected_type <span class="op">==</span> <span class="st">"string"</span>:</span>
<span id="cb87-201"><a href="#cb87-201" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(value, <span class="bu">str</span>)</span>
<span id="cb87-202"><a href="#cb87-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> expected_type <span class="op">==</span> <span class="st">"integer"</span>:</span>
<span id="cb87-203"><a href="#cb87-203" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(value, <span class="bu">int</span>)</span>
<span id="cb87-204"><a href="#cb87-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> expected_type <span class="op">==</span> <span class="st">"float"</span> <span class="kw">or</span> expected_type <span class="op">==</span> <span class="st">"number"</span>:</span>
<span id="cb87-205"><a href="#cb87-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(value, (<span class="bu">int</span>, <span class="bu">float</span>))</span>
<span id="cb87-206"><a href="#cb87-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> expected_type <span class="op">==</span> <span class="st">"boolean"</span>:</span>
<span id="cb87-207"><a href="#cb87-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(value, <span class="bu">bool</span>)</span>
<span id="cb87-208"><a href="#cb87-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> expected_type <span class="op">==</span> <span class="st">"date"</span>:</span>
<span id="cb87-209"><a href="#cb87-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic date format check</span></span>
<span id="cb87-210"><a href="#cb87-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(value, <span class="bu">str</span>):</span>
<span id="cb87-211"><a href="#cb87-211" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb87-212"><a href="#cb87-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-213"><a href="#cb87-213" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re</span>
<span id="cb87-214"><a href="#cb87-214" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Match YYYY-MM-DD format</span></span>
<span id="cb87-215"><a href="#cb87-215" aria-hidden="true" tabindex="-1"></a>        date_pattern <span class="op">=</span> <span class="vs">r'^\d</span><span class="sc">{4}</span><span class="vs">-\d</span><span class="sc">{2}</span><span class="vs">-\d</span><span class="sc">{2}</span><span class="vs">$'</span></span>
<span id="cb87-216"><a href="#cb87-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">bool</span>(re.match(date_pattern, value))</span>
<span id="cb87-217"><a href="#cb87-217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> expected_type <span class="op">==</span> <span class="st">"list"</span>:</span>
<span id="cb87-218"><a href="#cb87-218" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(value, <span class="bu">list</span>)</span>
<span id="cb87-219"><a href="#cb87-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> expected_type <span class="op">==</span> <span class="st">"object"</span>:</span>
<span id="cb87-220"><a href="#cb87-220" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">isinstance</span>(value, <span class="bu">dict</span>)</span>
<span id="cb87-221"><a href="#cb87-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> expected_type <span class="op">==</span> <span class="st">"uri"</span>:</span>
<span id="cb87-222"><a href="#cb87-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic URI format check</span></span>
<span id="cb87-223"><a href="#cb87-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(value, <span class="bu">str</span>):</span>
<span id="cb87-224"><a href="#cb87-224" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb87-225"><a href="#cb87-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-226"><a href="#cb87-226" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re</span>
<span id="cb87-227"><a href="#cb87-227" aria-hidden="true" tabindex="-1"></a>        uri_pattern <span class="op">=</span> <span class="vs">r'^[a-zA-Z][a-zA-Z0-9+.-]*:'</span></span>
<span id="cb87-228"><a href="#cb87-228" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">bool</span>(re.match(uri_pattern, value))</span>
<span id="cb87-229"><a href="#cb87-229" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb87-230"><a href="#cb87-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Unknown type</span></span>
<span id="cb87-231"><a href="#cb87-231" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in quality assessment include:</p>
<ol type="1">
<li><strong>Scale and diversity</strong>: Assessing quality across large, heterogeneous knowledge graphs</li>
<li><strong>Metric selection</strong>: Identifying appropriate metrics for specific use cases</li>
<li><strong>Ground truth</strong>: Establishing reference standards for accuracy evaluation</li>
<li><strong>Interdimensional trade-offs</strong>: Balancing competing quality dimensions</li>
<li><strong>Resource constraints</strong>: Managing the cost of quality assessment activities</li>
</ol>
</section>
<section id="knowledge-graph-completion" class="level3" data-number="6.6.2">
<h3 data-number="6.6.2" class="anchored" data-anchor-id="knowledge-graph-completion"><span class="header-section-number">6.6.2</span> Knowledge graph completion</h3>
<p>Knowledge graph completion identifies and fills in missing knowledge:</p>
<div id="def-kg-completion" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.21 (Knowledge graph completion)</strong></span> <strong>Knowledge graph completion</strong> is the process of identifying and filling in missing knowledge in a knowledge graph. Approaches include:</p>
<ol type="1">
<li><strong>Rule-based completion</strong>: Using logical rules to infer missing facts</li>
<li><strong>Statistical completion</strong>: Predicting missing links based on observed patterns</li>
<li><strong>Embedding-based completion</strong>: Using vector representations to predict likely missing links</li>
<li><strong>External source completion</strong>: Retrieving missing information from external knowledge sources</li>
<li><strong>Crowdsourced completion</strong>: Engaging humans to provide missing knowledge</li>
</ol>
</div>
<div id="exm-kg-completion" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.34 (Knowledge graph completion examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Rule-based completion</strong>:</p>
<pre><code>Rule: IF person1 has parent person2 AND person2 has parent person3 THEN person1 has grandparent person3

Existing facts:
- (John, hasParent, Mary)
- (Mary, hasParent, Elizabeth)

Inferred fact:
- (John, hasGrandparent, Elizabeth)</code></pre></li>
<li><p><strong>Embedding-based completion</strong>:</p>
<pre><code>Entity embeddings:
- France: [0.2, 0.8, -0.3, ...]
- Germany: [0.3, 0.7, -0.2, ...]
- Paris: [-0.1, 0.9, -0.4, ...]
- Berlin: [0.0, 0.8, -0.3, ...]

Relation embedding:
- capitalOf: [0.5, -0.2, 0.1, ...]

Known facts:
- (Paris, capitalOf, France)

Predicted fact (based on embedding similarity):
- (Berlin, capitalOf, Germany)</code></pre></li>
<li><p><strong>External source completion</strong>:</p>
<pre><code>Knowledge graph entity:
{
  "id": "entity:1234",
  "type": "Movie",
  "title": "The Matrix",
  "director": "The Wachowskis",
  "releaseYear": 1999
}

Query to external API:
GET /movies?title=The+Matrix&amp;year=1999

External data:
{
  "title": "The Matrix",
  "year": 1999,
  "runtime": 136,
  "genres": ["Action", "Sci-Fi"],
  "actors": ["Keanu Reeves", "Laurence Fishburne", "Carrie-Anne Moss"],
  "awards": "4 Oscars"
}

Completed entity:
{
  "id": "entity:1234",
  "type": "Movie",
  "title": "The Matrix",
  "director": "The Wachowskis",
  "releaseYear": 1999,
  "runtime": 136,
  "genres": ["Action", "Sci-Fi"],
  "actors": ["Keanu Reeves", "Laurence Fishburne", "Carrie-Anne Moss"],
  "awards": "4 Oscars"
}</code></pre></li>
<li><p><strong>Statistical pattern-based completion</strong>:</p>
<pre><code>Pattern: 87% of Technology companies have headquarters in one of [Silicon Valley, Seattle, Boston, New York]

Entity with missing information:
{
  "id": "company:5678",
  "type": "Company",
  "name": "TechCorp",
  "industry": "Technology",
  "foundedYear": 2010
}

Predicted completion (with confidence score):
{
  "headquarters": "Silicon Valley",
  "confidence": 0.65
}</code></pre></li>
</ol>
</div>
<p>Knowledge graph completion approaches include:</p>
<ol type="1">
<li><p><strong>Logical inference</strong>:</p>
<ul>
<li>Deductive reasoning using ontological axioms</li>
<li>Rule-based systems for domain-specific patterns</li>
<li>Advantages: High precision, explainable results</li>
<li>Disadvantages: Limited to patterns expressible as rules</li>
</ul></li>
<li><p><strong>Knowledge graph embeddings</strong>:</p>
<ul>
<li>Representing entities and relations in vector spaces</li>
<li>Models like TransE, DistMult, ComplEx, RotatE</li>
<li>Advantages: Can capture latent patterns, scalable</li>
<li>Disadvantages: Less interpretable, requires training data</li>
</ul></li>
<li><p><strong>Graph neural networks</strong>:</p>
<ul>
<li>Neural networks operating directly on graph structures</li>
<li>Models like RGCN, CompGCN, KBGAT</li>
<li>Advantages: Captures complex structural patterns</li>
<li>Disadvantages: Computational complexity, training data requirements</li>
</ul></li>
<li><p><strong>External knowledge integration</strong>:</p>
<ul>
<li>APIs, web scraping, database integration</li>
<li>Entity linking to existing knowledge bases</li>
<li>Advantages: Access to extensive external knowledge</li>
<li>Disadvantages: Integration challenges, source reliability</li>
</ul></li>
</ol>
<div id="exm-kg-completion-implementation" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.35 (Knowledge graph completion implementation)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Rule-based completion implementation</strong>:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rule_based_completion(knowledge_graph, rules):</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Complete a knowledge graph using logical rules</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co">    knowledge_graph: The knowledge graph to complete</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="co">    rules: List of rules for inferring new facts</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert knowledge graph to a more query-friendly format</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    facts <span class="op">=</span> []</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> property_name, property_value <span class="kw">in</span> entity_data.items():</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> property_name <span class="kw">in</span> [<span class="st">"id"</span>, <span class="st">"type"</span>, <span class="st">"source"</span>]:</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle both single values and lists</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(property_value, <span class="bu">list</span>):</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> value <span class="kw">in</span> property_value:</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>                    facts.append((entity_id, property_name, value))</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>                facts.append((entity_id, property_name, property_value))</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply rules until no new facts are derived</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    new_facts_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>    inferred_facts <span class="op">=</span> []</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> new_facts_found:</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>        new_facts_found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rule <span class="kw">in</span> rules:</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>            rule_type <span class="op">=</span> rule.get(<span class="st">"type"</span>)</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> rule_type <span class="op">==</span> <span class="st">"transitive"</span>:</span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Transitive rule: if (a, r, b) and (b, r, c) then (a, r, c)</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>                relation <span class="op">=</span> rule.get(<span class="st">"relation"</span>)</span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Find all facts with this relation</span></span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>                relation_facts <span class="op">=</span> [(s, o) <span class="cf">for</span> s, r, o <span class="kw">in</span> facts <span class="cf">if</span> r <span class="op">==</span> relation]</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Build a mapping for efficient lookup</span></span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>                relation_map <span class="op">=</span> {}</span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> subject, obj <span class="kw">in</span> relation_facts:</span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> subject <span class="kw">not</span> <span class="kw">in</span> relation_map:</span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a>                        relation_map[subject] <span class="op">=</span> []</span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a>                    relation_map[subject].append(obj)</span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Apply transitive rule</span></span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> subject, objects <span class="kw">in</span> relation_map.items():</span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> obj <span class="kw">in</span> objects:</span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> obj <span class="kw">in</span> relation_map:</span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Transitive step possible</span></span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> transitive_obj <span class="kw">in</span> relation_map[obj]:</span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a>                                new_fact <span class="op">=</span> (subject, relation, transitive_obj)</span>
<span id="cb92-53"><a href="#cb92-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-54"><a href="#cb92-54" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># Check if this is a new fact</span></span>
<span id="cb92-55"><a href="#cb92-55" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">if</span> new_fact <span class="kw">not</span> <span class="kw">in</span> facts <span class="kw">and</span> new_fact <span class="kw">not</span> <span class="kw">in</span> inferred_facts:</span>
<span id="cb92-56"><a href="#cb92-56" aria-hidden="true" tabindex="-1"></a>                                    inferred_facts.append(new_fact)</span>
<span id="cb92-57"><a href="#cb92-57" aria-hidden="true" tabindex="-1"></a>                                    new_facts_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb92-58"><a href="#cb92-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-59"><a href="#cb92-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> rule_type <span class="op">==</span> <span class="st">"symmetric"</span>:</span>
<span id="cb92-60"><a href="#cb92-60" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Symmetric rule: if (a, r, b) then (b, r, a)</span></span>
<span id="cb92-61"><a href="#cb92-61" aria-hidden="true" tabindex="-1"></a>                relation <span class="op">=</span> rule.get(<span class="st">"relation"</span>)</span>
<span id="cb92-62"><a href="#cb92-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-63"><a href="#cb92-63" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Find all facts with this relation</span></span>
<span id="cb92-64"><a href="#cb92-64" aria-hidden="true" tabindex="-1"></a>                relation_facts <span class="op">=</span> [(s, o) <span class="cf">for</span> s, r, o <span class="kw">in</span> facts <span class="cf">if</span> r <span class="op">==</span> relation]</span>
<span id="cb92-65"><a href="#cb92-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-66"><a href="#cb92-66" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Apply symmetric rule</span></span>
<span id="cb92-67"><a href="#cb92-67" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> subject, obj <span class="kw">in</span> relation_facts:</span>
<span id="cb92-68"><a href="#cb92-68" aria-hidden="true" tabindex="-1"></a>                    new_fact <span class="op">=</span> (obj, relation, subject)</span>
<span id="cb92-69"><a href="#cb92-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-70"><a href="#cb92-70" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if this is a new fact</span></span>
<span id="cb92-71"><a href="#cb92-71" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> new_fact <span class="kw">not</span> <span class="kw">in</span> facts <span class="kw">and</span> new_fact <span class="kw">not</span> <span class="kw">in</span> inferred_facts:</span>
<span id="cb92-72"><a href="#cb92-72" aria-hidden="true" tabindex="-1"></a>                        inferred_facts.append(new_fact)</span>
<span id="cb92-73"><a href="#cb92-73" aria-hidden="true" tabindex="-1"></a>                        new_facts_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb92-74"><a href="#cb92-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-75"><a href="#cb92-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> rule_type <span class="op">==</span> <span class="st">"inverse"</span>:</span>
<span id="cb92-76"><a href="#cb92-76" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Inverse rule: if (a, r1, b) then (b, r2, a)</span></span>
<span id="cb92-77"><a href="#cb92-77" aria-hidden="true" tabindex="-1"></a>                relation1 <span class="op">=</span> rule.get(<span class="st">"relation"</span>)</span>
<span id="cb92-78"><a href="#cb92-78" aria-hidden="true" tabindex="-1"></a>                relation2 <span class="op">=</span> rule.get(<span class="st">"inverse_relation"</span>)</span>
<span id="cb92-79"><a href="#cb92-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-80"><a href="#cb92-80" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Find all facts with relation1</span></span>
<span id="cb92-81"><a href="#cb92-81" aria-hidden="true" tabindex="-1"></a>                relation_facts <span class="op">=</span> [(s, o) <span class="cf">for</span> s, r, o <span class="kw">in</span> facts <span class="cf">if</span> r <span class="op">==</span> relation1]</span>
<span id="cb92-82"><a href="#cb92-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-83"><a href="#cb92-83" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Apply inverse rule</span></span>
<span id="cb92-84"><a href="#cb92-84" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> subject, obj <span class="kw">in</span> relation_facts:</span>
<span id="cb92-85"><a href="#cb92-85" aria-hidden="true" tabindex="-1"></a>                    new_fact <span class="op">=</span> (obj, relation2, subject)</span>
<span id="cb92-86"><a href="#cb92-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-87"><a href="#cb92-87" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check if this is a new fact</span></span>
<span id="cb92-88"><a href="#cb92-88" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> new_fact <span class="kw">not</span> <span class="kw">in</span> facts <span class="kw">and</span> new_fact <span class="kw">not</span> <span class="kw">in</span> inferred_facts:</span>
<span id="cb92-89"><a href="#cb92-89" aria-hidden="true" tabindex="-1"></a>                        inferred_facts.append(new_fact)</span>
<span id="cb92-90"><a href="#cb92-90" aria-hidden="true" tabindex="-1"></a>                        new_facts_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb92-91"><a href="#cb92-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-92"><a href="#cb92-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> rule_type <span class="op">==</span> <span class="st">"composition"</span>:</span>
<span id="cb92-93"><a href="#cb92-93" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Composition rule: if (a, r1, b) and (b, r2, c) then (a, r3, c)</span></span>
<span id="cb92-94"><a href="#cb92-94" aria-hidden="true" tabindex="-1"></a>                relation1 <span class="op">=</span> rule.get(<span class="st">"relation1"</span>)</span>
<span id="cb92-95"><a href="#cb92-95" aria-hidden="true" tabindex="-1"></a>                relation2 <span class="op">=</span> rule.get(<span class="st">"relation2"</span>)</span>
<span id="cb92-96"><a href="#cb92-96" aria-hidden="true" tabindex="-1"></a>                relation3 <span class="op">=</span> rule.get(<span class="st">"relation3"</span>)</span>
<span id="cb92-97"><a href="#cb92-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-98"><a href="#cb92-98" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Find all facts with relation1 and relation2</span></span>
<span id="cb92-99"><a href="#cb92-99" aria-hidden="true" tabindex="-1"></a>                relation1_facts <span class="op">=</span> [(s, o) <span class="cf">for</span> s, r, o <span class="kw">in</span> facts <span class="cf">if</span> r <span class="op">==</span> relation1]</span>
<span id="cb92-100"><a href="#cb92-100" aria-hidden="true" tabindex="-1"></a>                relation2_facts <span class="op">=</span> [(s, o) <span class="cf">for</span> s, r, o <span class="kw">in</span> facts <span class="cf">if</span> r <span class="op">==</span> relation2]</span>
<span id="cb92-101"><a href="#cb92-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-102"><a href="#cb92-102" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Build a mapping for relation2 for efficient lookup</span></span>
<span id="cb92-103"><a href="#cb92-103" aria-hidden="true" tabindex="-1"></a>                relation2_map <span class="op">=</span> {}</span>
<span id="cb92-104"><a href="#cb92-104" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> subject, obj <span class="kw">in</span> relation2_facts:</span>
<span id="cb92-105"><a href="#cb92-105" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> subject <span class="kw">not</span> <span class="kw">in</span> relation2_map:</span>
<span id="cb92-106"><a href="#cb92-106" aria-hidden="true" tabindex="-1"></a>                        relation2_map[subject] <span class="op">=</span> []</span>
<span id="cb92-107"><a href="#cb92-107" aria-hidden="true" tabindex="-1"></a>                    relation2_map[subject].append(obj)</span>
<span id="cb92-108"><a href="#cb92-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-109"><a href="#cb92-109" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Apply composition rule</span></span>
<span id="cb92-110"><a href="#cb92-110" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> subject1, obj1 <span class="kw">in</span> relation1_facts:</span>
<span id="cb92-111"><a href="#cb92-111" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> obj1 <span class="kw">in</span> relation2_map:</span>
<span id="cb92-112"><a href="#cb92-112" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> obj2 <span class="kw">in</span> relation2_map[obj1]:</span>
<span id="cb92-113"><a href="#cb92-113" aria-hidden="true" tabindex="-1"></a>                            new_fact <span class="op">=</span> (subject1, relation3, obj2)</span>
<span id="cb92-114"><a href="#cb92-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-115"><a href="#cb92-115" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Check if this is a new fact</span></span>
<span id="cb92-116"><a href="#cb92-116" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> new_fact <span class="kw">not</span> <span class="kw">in</span> facts <span class="kw">and</span> new_fact <span class="kw">not</span> <span class="kw">in</span> inferred_facts:</span>
<span id="cb92-117"><a href="#cb92-117" aria-hidden="true" tabindex="-1"></a>                                inferred_facts.append(new_fact)</span>
<span id="cb92-118"><a href="#cb92-118" aria-hidden="true" tabindex="-1"></a>                                new_facts_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb92-119"><a href="#cb92-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-120"><a href="#cb92-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> rule_type <span class="op">==</span> <span class="st">"custom"</span>:</span>
<span id="cb92-121"><a href="#cb92-121" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Custom rule with condition and conclusion functions</span></span>
<span id="cb92-122"><a href="#cb92-122" aria-hidden="true" tabindex="-1"></a>                condition_func <span class="op">=</span> rule.get(<span class="st">"condition"</span>)</span>
<span id="cb92-123"><a href="#cb92-123" aria-hidden="true" tabindex="-1"></a>                conclusion_func <span class="op">=</span> rule.get(<span class="st">"conclusion"</span>)</span>
<span id="cb92-124"><a href="#cb92-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-125"><a href="#cb92-125" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">callable</span>(condition_func) <span class="kw">and</span> <span class="bu">callable</span>(conclusion_func):</span>
<span id="cb92-126"><a href="#cb92-126" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Apply custom rule</span></span>
<span id="cb92-127"><a href="#cb92-127" aria-hidden="true" tabindex="-1"></a>                    new_custom_facts <span class="op">=</span> apply_custom_rule(</span>
<span id="cb92-128"><a href="#cb92-128" aria-hidden="true" tabindex="-1"></a>                        facts, condition_func, conclusion_func</span>
<span id="cb92-129"><a href="#cb92-129" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb92-130"><a href="#cb92-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-131"><a href="#cb92-131" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> new_fact <span class="kw">in</span> new_custom_facts:</span>
<span id="cb92-132"><a href="#cb92-132" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> new_fact <span class="kw">not</span> <span class="kw">in</span> facts <span class="kw">and</span> new_fact <span class="kw">not</span> <span class="kw">in</span> inferred_facts:</span>
<span id="cb92-133"><a href="#cb92-133" aria-hidden="true" tabindex="-1"></a>                            inferred_facts.append(new_fact)</span>
<span id="cb92-134"><a href="#cb92-134" aria-hidden="true" tabindex="-1"></a>                            new_facts_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb92-135"><a href="#cb92-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-136"><a href="#cb92-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add newly inferred facts to the existing facts</span></span>
<span id="cb92-137"><a href="#cb92-137" aria-hidden="true" tabindex="-1"></a>        facts.extend(inferred_facts)</span>
<span id="cb92-138"><a href="#cb92-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-139"><a href="#cb92-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the knowledge graph with inferred facts</span></span>
<span id="cb92-140"><a href="#cb92-140" aria-hidden="true" tabindex="-1"></a>    updated_knowledge_graph <span class="op">=</span> knowledge_graph.copy()</span>
<span id="cb92-141"><a href="#cb92-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-142"><a href="#cb92-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subject, predicate, obj <span class="kw">in</span> inferred_facts:</span>
<span id="cb92-143"><a href="#cb92-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if subject entity exists</span></span>
<span id="cb92-144"><a href="#cb92-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> subject <span class="kw">not</span> <span class="kw">in</span> updated_knowledge_graph:</span>
<span id="cb92-145"><a href="#cb92-145" aria-hidden="true" tabindex="-1"></a>            updated_knowledge_graph[subject] <span class="op">=</span> {</span>
<span id="cb92-146"><a href="#cb92-146" aria-hidden="true" tabindex="-1"></a>                <span class="st">"id"</span>: subject,</span>
<span id="cb92-147"><a href="#cb92-147" aria-hidden="true" tabindex="-1"></a>                <span class="st">"inferred"</span>: <span class="va">True</span></span>
<span id="cb92-148"><a href="#cb92-148" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb92-149"><a href="#cb92-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-150"><a href="#cb92-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the new fact to the entity</span></span>
<span id="cb92-151"><a href="#cb92-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> predicate <span class="kw">in</span> updated_knowledge_graph[subject]:</span>
<span id="cb92-152"><a href="#cb92-152" aria-hidden="true" tabindex="-1"></a>            current_value <span class="op">=</span> updated_knowledge_graph[subject][predicate]</span>
<span id="cb92-153"><a href="#cb92-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-154"><a href="#cb92-154" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle both single values and lists</span></span>
<span id="cb92-155"><a href="#cb92-155" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(current_value, <span class="bu">list</span>):</span>
<span id="cb92-156"><a href="#cb92-156" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> obj <span class="kw">not</span> <span class="kw">in</span> current_value:</span>
<span id="cb92-157"><a href="#cb92-157" aria-hidden="true" tabindex="-1"></a>                    updated_knowledge_graph[subject][predicate].append(obj)</span>
<span id="cb92-158"><a href="#cb92-158" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb92-159"><a href="#cb92-159" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> current_value <span class="op">!=</span> obj:</span>
<span id="cb92-160"><a href="#cb92-160" aria-hidden="true" tabindex="-1"></a>                    updated_knowledge_graph[subject][predicate] <span class="op">=</span> [current_value, obj]</span>
<span id="cb92-161"><a href="#cb92-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb92-162"><a href="#cb92-162" aria-hidden="true" tabindex="-1"></a>            updated_knowledge_graph[subject][predicate] <span class="op">=</span> obj</span>
<span id="cb92-163"><a href="#cb92-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-164"><a href="#cb92-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> updated_knowledge_graph, inferred_facts</span>
<span id="cb92-165"><a href="#cb92-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-166"><a href="#cb92-166" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_custom_rule(facts, condition_func, conclusion_func):</span>
<span id="cb92-167"><a href="#cb92-167" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Apply a custom rule with condition and conclusion functions"""</span></span>
<span id="cb92-168"><a href="#cb92-168" aria-hidden="true" tabindex="-1"></a>    new_facts <span class="op">=</span> []</span>
<span id="cb92-169"><a href="#cb92-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-170"><a href="#cb92-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group facts by subject for efficient processing</span></span>
<span id="cb92-171"><a href="#cb92-171" aria-hidden="true" tabindex="-1"></a>    subject_facts <span class="op">=</span> {}</span>
<span id="cb92-172"><a href="#cb92-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subject, predicate, obj <span class="kw">in</span> facts:</span>
<span id="cb92-173"><a href="#cb92-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> subject <span class="kw">not</span> <span class="kw">in</span> subject_facts:</span>
<span id="cb92-174"><a href="#cb92-174" aria-hidden="true" tabindex="-1"></a>            subject_facts[subject] <span class="op">=</span> []</span>
<span id="cb92-175"><a href="#cb92-175" aria-hidden="true" tabindex="-1"></a>        subject_facts[subject].append((predicate, obj))</span>
<span id="cb92-176"><a href="#cb92-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-177"><a href="#cb92-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the rule to each entity</span></span>
<span id="cb92-178"><a href="#cb92-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subject, entity_facts <span class="kw">in</span> subject_facts.items():</span>
<span id="cb92-179"><a href="#cb92-179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if condition matches</span></span>
<span id="cb92-180"><a href="#cb92-180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> condition_func(subject, entity_facts, facts):</span>
<span id="cb92-181"><a href="#cb92-181" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Generate new facts</span></span>
<span id="cb92-182"><a href="#cb92-182" aria-hidden="true" tabindex="-1"></a>            new_entity_facts <span class="op">=</span> conclusion_func(subject, entity_facts, facts)</span>
<span id="cb92-183"><a href="#cb92-183" aria-hidden="true" tabindex="-1"></a>            new_facts.extend(new_entity_facts)</span>
<span id="cb92-184"><a href="#cb92-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-185"><a href="#cb92-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_facts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Embedding-based completion implementation</strong>:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TransE(nn.Module):</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="co">    TransE knowledge graph embedding model</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="co">    TransE models relations as translations in the embedding space:</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="co">    h + r ≈ t for true triples (h, r, t)</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_entities, num_relations, embedding_dim, margin<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(TransE, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_entities <span class="op">=</span> num_entities</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_relations <span class="op">=</span> num_relations</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.embedding_dim <span class="op">=</span> embedding_dim</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.margin <span class="op">=</span> margin</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize entity and relation embeddings</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.entity_embeddings <span class="op">=</span> nn.Embedding(num_entities, embedding_dim)</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relation_embeddings <span class="op">=</span> nn.Embedding(num_relations, embedding_dim)</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize weights</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.entity_embeddings.weight)</span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.relation_embeddings.weight)</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize embeddings</span></span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.normalize_embeddings()</span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> normalize_embeddings(<span class="va">self</span>):</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Normalize entity embeddings to unit L2 norm"""</span></span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.entity_embeddings.weight.data <span class="op">=</span> F.normalize(</span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.entity_embeddings.weight.data, p<span class="op">=</span><span class="dv">2</span>, dim<span class="op">=</span><span class="dv">1</span></span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, positive_triples, negative_triples):</span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Compute the loss for a batch of positive and negative triples</span></span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a><span class="co">        positive_triples: Tensor of shape (batch_size, 3) with positive triples (h, r, t)</span></span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a><span class="co">        negative_triples: Tensor of shape (batch_size, 3) with negative triples (h', r, t')</span></span>
<span id="cb93-44"><a href="#cb93-44" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb93-45"><a href="#cb93-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract positive triple components</span></span>
<span id="cb93-46"><a href="#cb93-46" aria-hidden="true" tabindex="-1"></a>        pos_heads <span class="op">=</span> positive_triples[:, <span class="dv">0</span>]</span>
<span id="cb93-47"><a href="#cb93-47" aria-hidden="true" tabindex="-1"></a>        pos_relations <span class="op">=</span> positive_triples[:, <span class="dv">1</span>]</span>
<span id="cb93-48"><a href="#cb93-48" aria-hidden="true" tabindex="-1"></a>        pos_tails <span class="op">=</span> positive_triples[:, <span class="dv">2</span>]</span>
<span id="cb93-49"><a href="#cb93-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-50"><a href="#cb93-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract negative triple components</span></span>
<span id="cb93-51"><a href="#cb93-51" aria-hidden="true" tabindex="-1"></a>        neg_heads <span class="op">=</span> negative_triples[:, <span class="dv">0</span>]</span>
<span id="cb93-52"><a href="#cb93-52" aria-hidden="true" tabindex="-1"></a>        neg_relations <span class="op">=</span> negative_triples[:, <span class="dv">1</span>]</span>
<span id="cb93-53"><a href="#cb93-53" aria-hidden="true" tabindex="-1"></a>        neg_tails <span class="op">=</span> negative_triples[:, <span class="dv">2</span>]</span>
<span id="cb93-54"><a href="#cb93-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-55"><a href="#cb93-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get embeddings</span></span>
<span id="cb93-56"><a href="#cb93-56" aria-hidden="true" tabindex="-1"></a>        pos_head_embeddings <span class="op">=</span> <span class="va">self</span>.entity_embeddings(pos_heads)</span>
<span id="cb93-57"><a href="#cb93-57" aria-hidden="true" tabindex="-1"></a>        pos_relation_embeddings <span class="op">=</span> <span class="va">self</span>.relation_embeddings(pos_relations)</span>
<span id="cb93-58"><a href="#cb93-58" aria-hidden="true" tabindex="-1"></a>        pos_tail_embeddings <span class="op">=</span> <span class="va">self</span>.entity_embeddings(pos_tails)</span>
<span id="cb93-59"><a href="#cb93-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-60"><a href="#cb93-60" aria-hidden="true" tabindex="-1"></a>        neg_head_embeddings <span class="op">=</span> <span class="va">self</span>.entity_embeddings(neg_heads)</span>
<span id="cb93-61"><a href="#cb93-61" aria-hidden="true" tabindex="-1"></a>        neg_relation_embeddings <span class="op">=</span> <span class="va">self</span>.relation_embeddings(neg_relations)</span>
<span id="cb93-62"><a href="#cb93-62" aria-hidden="true" tabindex="-1"></a>        neg_tail_embeddings <span class="op">=</span> <span class="va">self</span>.entity_embeddings(neg_tails)</span>
<span id="cb93-63"><a href="#cb93-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-64"><a href="#cb93-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate scores</span></span>
<span id="cb93-65"><a href="#cb93-65" aria-hidden="true" tabindex="-1"></a>        pos_scores <span class="op">=</span> torch.norm(</span>
<span id="cb93-66"><a href="#cb93-66" aria-hidden="true" tabindex="-1"></a>            pos_head_embeddings <span class="op">+</span> pos_relation_embeddings <span class="op">-</span> pos_tail_embeddings,</span>
<span id="cb93-67"><a href="#cb93-67" aria-hidden="true" tabindex="-1"></a>            p<span class="op">=</span><span class="dv">1</span>, dim<span class="op">=</span><span class="dv">1</span></span>
<span id="cb93-68"><a href="#cb93-68" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb93-69"><a href="#cb93-69" aria-hidden="true" tabindex="-1"></a>        neg_scores <span class="op">=</span> torch.norm(</span>
<span id="cb93-70"><a href="#cb93-70" aria-hidden="true" tabindex="-1"></a>            neg_head_embeddings <span class="op">+</span> neg_relation_embeddings <span class="op">-</span> neg_tail_embeddings,</span>
<span id="cb93-71"><a href="#cb93-71" aria-hidden="true" tabindex="-1"></a>            p<span class="op">=</span><span class="dv">1</span>, dim<span class="op">=</span><span class="dv">1</span></span>
<span id="cb93-72"><a href="#cb93-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb93-73"><a href="#cb93-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-74"><a href="#cb93-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate loss with margin</span></span>
<span id="cb93-75"><a href="#cb93-75" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> torch.mean(F.relu(<span class="va">self</span>.margin <span class="op">+</span> pos_scores <span class="op">-</span> neg_scores))</span>
<span id="cb93-76"><a href="#cb93-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-77"><a href="#cb93-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span>
<span id="cb93-78"><a href="#cb93-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-79"><a href="#cb93-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_tail(<span class="va">self</span>, head, relation):</span>
<span id="cb93-80"><a href="#cb93-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Predict the most likely tail entities for a given head and relation"""</span></span>
<span id="cb93-81"><a href="#cb93-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get embeddings</span></span>
<span id="cb93-82"><a href="#cb93-82" aria-hidden="true" tabindex="-1"></a>        head_embedding <span class="op">=</span> <span class="va">self</span>.entity_embeddings(torch.LongTensor([head]))</span>
<span id="cb93-83"><a href="#cb93-83" aria-hidden="true" tabindex="-1"></a>        relation_embedding <span class="op">=</span> <span class="va">self</span>.relation_embeddings(torch.LongTensor([relation]))</span>
<span id="cb93-84"><a href="#cb93-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-85"><a href="#cb93-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate expected tail embedding</span></span>
<span id="cb93-86"><a href="#cb93-86" aria-hidden="true" tabindex="-1"></a>        expected_tail <span class="op">=</span> head_embedding <span class="op">+</span> relation_embedding</span>
<span id="cb93-87"><a href="#cb93-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-88"><a href="#cb93-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate distance to all entity embeddings</span></span>
<span id="cb93-89"><a href="#cb93-89" aria-hidden="true" tabindex="-1"></a>        all_entities <span class="op">=</span> torch.arange(<span class="va">self</span>.num_entities)</span>
<span id="cb93-90"><a href="#cb93-90" aria-hidden="true" tabindex="-1"></a>        all_embeddings <span class="op">=</span> <span class="va">self</span>.entity_embeddings(all_entities)</span>
<span id="cb93-91"><a href="#cb93-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-92"><a href="#cb93-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate scores (lower is better)</span></span>
<span id="cb93-93"><a href="#cb93-93" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> torch.norm(</span>
<span id="cb93-94"><a href="#cb93-94" aria-hidden="true" tabindex="-1"></a>            expected_tail.repeat(<span class="va">self</span>.num_entities, <span class="dv">1</span>) <span class="op">-</span> all_embeddings,</span>
<span id="cb93-95"><a href="#cb93-95" aria-hidden="true" tabindex="-1"></a>            p<span class="op">=</span><span class="dv">1</span>, dim<span class="op">=</span><span class="dv">1</span></span>
<span id="cb93-96"><a href="#cb93-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb93-97"><a href="#cb93-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-98"><a href="#cb93-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return indices sorted by score (ascending)</span></span>
<span id="cb93-99"><a href="#cb93-99" aria-hidden="true" tabindex="-1"></a>        _, indices <span class="op">=</span> torch.sort(scores)</span>
<span id="cb93-100"><a href="#cb93-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> indices.numpy()</span>
<span id="cb93-101"><a href="#cb93-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-102"><a href="#cb93-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_head(<span class="va">self</span>, relation, tail):</span>
<span id="cb93-103"><a href="#cb93-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Predict the most likely head entities for a given relation and tail"""</span></span>
<span id="cb93-104"><a href="#cb93-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get embeddings</span></span>
<span id="cb93-105"><a href="#cb93-105" aria-hidden="true" tabindex="-1"></a>        relation_embedding <span class="op">=</span> <span class="va">self</span>.relation_embeddings(torch.LongTensor([relation]))</span>
<span id="cb93-106"><a href="#cb93-106" aria-hidden="true" tabindex="-1"></a>        tail_embedding <span class="op">=</span> <span class="va">self</span>.entity_embeddings(torch.LongTensor([tail]))</span>
<span id="cb93-107"><a href="#cb93-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-108"><a href="#cb93-108" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate expected head embedding</span></span>
<span id="cb93-109"><a href="#cb93-109" aria-hidden="true" tabindex="-1"></a>        expected_head <span class="op">=</span> tail_embedding <span class="op">-</span> relation_embedding</span>
<span id="cb93-110"><a href="#cb93-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-111"><a href="#cb93-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate distance to all entity embeddings</span></span>
<span id="cb93-112"><a href="#cb93-112" aria-hidden="true" tabindex="-1"></a>        all_entities <span class="op">=</span> torch.arange(<span class="va">self</span>.num_entities)</span>
<span id="cb93-113"><a href="#cb93-113" aria-hidden="true" tabindex="-1"></a>        all_embeddings <span class="op">=</span> <span class="va">self</span>.entity_embeddings(all_entities)</span>
<span id="cb93-114"><a href="#cb93-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-115"><a href="#cb93-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate scores (lower is better)</span></span>
<span id="cb93-116"><a href="#cb93-116" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> torch.norm(</span>
<span id="cb93-117"><a href="#cb93-117" aria-hidden="true" tabindex="-1"></a>            expected_head.repeat(<span class="va">self</span>.num_entities, <span class="dv">1</span>) <span class="op">-</span> all_embeddings,</span>
<span id="cb93-118"><a href="#cb93-118" aria-hidden="true" tabindex="-1"></a>            p<span class="op">=</span><span class="dv">1</span>, dim<span class="op">=</span><span class="dv">1</span></span>
<span id="cb93-119"><a href="#cb93-119" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb93-120"><a href="#cb93-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-121"><a href="#cb93-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return indices sorted by score (ascending)</span></span>
<span id="cb93-122"><a href="#cb93-122" aria-hidden="true" tabindex="-1"></a>        _, indices <span class="op">=</span> torch.sort(scores)</span>
<span id="cb93-123"><a href="#cb93-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> indices.numpy()</span>
<span id="cb93-124"><a href="#cb93-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-125"><a href="#cb93-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_kg_data(knowledge_graph):</span>
<span id="cb93-126"><a href="#cb93-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Prepare knowledge graph data for embedding model"""</span></span>
<span id="cb93-127"><a href="#cb93-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create entity and relation mappings</span></span>
<span id="cb93-128"><a href="#cb93-128" aria-hidden="true" tabindex="-1"></a>    entities <span class="op">=</span> {}</span>
<span id="cb93-129"><a href="#cb93-129" aria-hidden="true" tabindex="-1"></a>    relations <span class="op">=</span> {}</span>
<span id="cb93-130"><a href="#cb93-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-131"><a href="#cb93-131" aria-hidden="true" tabindex="-1"></a>    triples <span class="op">=</span> []</span>
<span id="cb93-132"><a href="#cb93-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-133"><a href="#cb93-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract triples from knowledge graph</span></span>
<span id="cb93-134"><a href="#cb93-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb93-135"><a href="#cb93-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add source entity to mapping if new</span></span>
<span id="cb93-136"><a href="#cb93-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> entity_id <span class="kw">not</span> <span class="kw">in</span> entities:</span>
<span id="cb93-137"><a href="#cb93-137" aria-hidden="true" tabindex="-1"></a>            entities[entity_id] <span class="op">=</span> <span class="bu">len</span>(entities)</span>
<span id="cb93-138"><a href="#cb93-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-139"><a href="#cb93-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process each property</span></span>
<span id="cb93-140"><a href="#cb93-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> prop, value <span class="kw">in</span> entity_data.items():</span>
<span id="cb93-141"><a href="#cb93-141" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop <span class="kw">in</span> [<span class="st">"id"</span>, <span class="st">"type"</span>, <span class="st">"source"</span>, <span class="st">"inferred"</span>]:</span>
<span id="cb93-142"><a href="#cb93-142" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb93-143"><a href="#cb93-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-144"><a href="#cb93-144" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add relation to mapping if new</span></span>
<span id="cb93-145"><a href="#cb93-145" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop <span class="kw">not</span> <span class="kw">in</span> relations:</span>
<span id="cb93-146"><a href="#cb93-146" aria-hidden="true" tabindex="-1"></a>                relations[prop] <span class="op">=</span> <span class="bu">len</span>(relations)</span>
<span id="cb93-147"><a href="#cb93-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-148"><a href="#cb93-148" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle both single values and lists</span></span>
<span id="cb93-149"><a href="#cb93-149" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">list</span>):</span>
<span id="cb93-150"><a href="#cb93-150" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> v <span class="kw">in</span> value:</span>
<span id="cb93-151"><a href="#cb93-151" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Add target entity to mapping if new</span></span>
<span id="cb93-152"><a href="#cb93-152" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> entities:</span>
<span id="cb93-153"><a href="#cb93-153" aria-hidden="true" tabindex="-1"></a>                        entities[v] <span class="op">=</span> <span class="bu">len</span>(entities)</span>
<span id="cb93-154"><a href="#cb93-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-155"><a href="#cb93-155" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Add triple</span></span>
<span id="cb93-156"><a href="#cb93-156" aria-hidden="true" tabindex="-1"></a>                    triples.append((</span>
<span id="cb93-157"><a href="#cb93-157" aria-hidden="true" tabindex="-1"></a>                        entities[entity_id],</span>
<span id="cb93-158"><a href="#cb93-158" aria-hidden="true" tabindex="-1"></a>                        relations[prop],</span>
<span id="cb93-159"><a href="#cb93-159" aria-hidden="true" tabindex="-1"></a>                        entities[v]</span>
<span id="cb93-160"><a href="#cb93-160" aria-hidden="true" tabindex="-1"></a>                    ))</span>
<span id="cb93-161"><a href="#cb93-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb93-162"><a href="#cb93-162" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add target entity to mapping if new</span></span>
<span id="cb93-163"><a href="#cb93-163" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> value <span class="kw">not</span> <span class="kw">in</span> entities:</span>
<span id="cb93-164"><a href="#cb93-164" aria-hidden="true" tabindex="-1"></a>                    entities[value] <span class="op">=</span> <span class="bu">len</span>(entities)</span>
<span id="cb93-165"><a href="#cb93-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-166"><a href="#cb93-166" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add triple</span></span>
<span id="cb93-167"><a href="#cb93-167" aria-hidden="true" tabindex="-1"></a>                triples.append((</span>
<span id="cb93-168"><a href="#cb93-168" aria-hidden="true" tabindex="-1"></a>                    entities[entity_id],</span>
<span id="cb93-169"><a href="#cb93-169" aria-hidden="true" tabindex="-1"></a>                    relations[prop],</span>
<span id="cb93-170"><a href="#cb93-170" aria-hidden="true" tabindex="-1"></a>                    entities[value]</span>
<span id="cb93-171"><a href="#cb93-171" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb93-172"><a href="#cb93-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-173"><a href="#cb93-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create reverse mappings for looking up names</span></span>
<span id="cb93-174"><a href="#cb93-174" aria-hidden="true" tabindex="-1"></a>    id_to_entity <span class="op">=</span> {idx: entity <span class="cf">for</span> entity, idx <span class="kw">in</span> entities.items()}</span>
<span id="cb93-175"><a href="#cb93-175" aria-hidden="true" tabindex="-1"></a>    id_to_relation <span class="op">=</span> {idx: relation <span class="cf">for</span> relation, idx <span class="kw">in</span> relations.items()}</span>
<span id="cb93-176"><a href="#cb93-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-177"><a href="#cb93-177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> triples, entities, relations, id_to_entity, id_to_relation</span>
<span id="cb93-178"><a href="#cb93-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-179"><a href="#cb93-179" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_kg_embeddings(knowledge_graph, embedding_dim<span class="op">=</span><span class="dv">100</span>, epochs<span class="op">=</span><span class="dv">100</span>, batch_size<span class="op">=</span><span class="dv">128</span>, margin<span class="op">=</span><span class="fl">1.0</span>, learning_rate<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb93-180"><a href="#cb93-180" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train knowledge graph embeddings and use them for completion"""</span></span>
<span id="cb93-181"><a href="#cb93-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare data</span></span>
<span id="cb93-182"><a href="#cb93-182" aria-hidden="true" tabindex="-1"></a>    triples, entity_map, relation_map, id_to_entity, id_to_relation <span class="op">=</span> prepare_kg_data(</span>
<span id="cb93-183"><a href="#cb93-183" aria-hidden="true" tabindex="-1"></a>        knowledge_graph</span>
<span id="cb93-184"><a href="#cb93-184" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-185"><a href="#cb93-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-186"><a href="#cb93-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert triples to numpy array</span></span>
<span id="cb93-187"><a href="#cb93-187" aria-hidden="true" tabindex="-1"></a>    triples_array <span class="op">=</span> np.array(triples)</span>
<span id="cb93-188"><a href="#cb93-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-189"><a href="#cb93-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create model</span></span>
<span id="cb93-190"><a href="#cb93-190" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> TransE(</span>
<span id="cb93-191"><a href="#cb93-191" aria-hidden="true" tabindex="-1"></a>        num_entities<span class="op">=</span><span class="bu">len</span>(entity_map),</span>
<span id="cb93-192"><a href="#cb93-192" aria-hidden="true" tabindex="-1"></a>        num_relations<span class="op">=</span><span class="bu">len</span>(relation_map),</span>
<span id="cb93-193"><a href="#cb93-193" aria-hidden="true" tabindex="-1"></a>        embedding_dim<span class="op">=</span>embedding_dim,</span>
<span id="cb93-194"><a href="#cb93-194" aria-hidden="true" tabindex="-1"></a>        margin<span class="op">=</span>margin</span>
<span id="cb93-195"><a href="#cb93-195" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-196"><a href="#cb93-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-197"><a href="#cb93-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define optimizer</span></span>
<span id="cb93-198"><a href="#cb93-198" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optim.Adam(model.parameters(), lr<span class="op">=</span>learning_rate)</span>
<span id="cb93-199"><a href="#cb93-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-200"><a href="#cb93-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training loop</span></span>
<span id="cb93-201"><a href="#cb93-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb93-202"><a href="#cb93-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Shuffle triples</span></span>
<span id="cb93-203"><a href="#cb93-203" aria-hidden="true" tabindex="-1"></a>        np.random.shuffle(triples_array)</span>
<span id="cb93-204"><a href="#cb93-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-205"><a href="#cb93-205" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb93-206"><a href="#cb93-206" aria-hidden="true" tabindex="-1"></a>        num_batches <span class="op">=</span> <span class="bu">len</span>(triples_array) <span class="op">//</span> batch_size <span class="op">+</span> (<span class="dv">1</span> <span class="cf">if</span> <span class="bu">len</span>(triples_array) <span class="op">%</span> batch_size <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb93-207"><a href="#cb93-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-208"><a href="#cb93-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(triples_array), batch_size):</span>
<span id="cb93-209"><a href="#cb93-209" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get batch</span></span>
<span id="cb93-210"><a href="#cb93-210" aria-hidden="true" tabindex="-1"></a>            batch <span class="op">=</span> triples_array[i:i<span class="op">+</span>batch_size]</span>
<span id="cb93-211"><a href="#cb93-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-212"><a href="#cb93-212" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Generate negative samples (random corruption of head or tail)</span></span>
<span id="cb93-213"><a href="#cb93-213" aria-hidden="true" tabindex="-1"></a>            negative_batch <span class="op">=</span> []</span>
<span id="cb93-214"><a href="#cb93-214" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> h, r, t <span class="kw">in</span> batch:</span>
<span id="cb93-215"><a href="#cb93-215" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> np.random.random() <span class="op">&lt;</span> <span class="fl">0.5</span>:</span>
<span id="cb93-216"><a href="#cb93-216" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Corrupt head</span></span>
<span id="cb93-217"><a href="#cb93-217" aria-hidden="true" tabindex="-1"></a>                    h_neg <span class="op">=</span> h</span>
<span id="cb93-218"><a href="#cb93-218" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span> h_neg <span class="op">==</span> h:</span>
<span id="cb93-219"><a href="#cb93-219" aria-hidden="true" tabindex="-1"></a>                        h_neg <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">len</span>(entity_map))</span>
<span id="cb93-220"><a href="#cb93-220" aria-hidden="true" tabindex="-1"></a>                    negative_batch.append((h_neg, r, t))</span>
<span id="cb93-221"><a href="#cb93-221" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb93-222"><a href="#cb93-222" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Corrupt tail</span></span>
<span id="cb93-223"><a href="#cb93-223" aria-hidden="true" tabindex="-1"></a>                    t_neg <span class="op">=</span> t</span>
<span id="cb93-224"><a href="#cb93-224" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span> t_neg <span class="op">==</span> t:</span>
<span id="cb93-225"><a href="#cb93-225" aria-hidden="true" tabindex="-1"></a>                        t_neg <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">len</span>(entity_map))</span>
<span id="cb93-226"><a href="#cb93-226" aria-hidden="true" tabindex="-1"></a>                    negative_batch.append((h, r, t_neg))</span>
<span id="cb93-227"><a href="#cb93-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-228"><a href="#cb93-228" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert to tensors</span></span>
<span id="cb93-229"><a href="#cb93-229" aria-hidden="true" tabindex="-1"></a>            positive_triples <span class="op">=</span> torch.LongTensor(batch)</span>
<span id="cb93-230"><a href="#cb93-230" aria-hidden="true" tabindex="-1"></a>            negative_triples <span class="op">=</span> torch.LongTensor(negative_batch)</span>
<span id="cb93-231"><a href="#cb93-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-232"><a href="#cb93-232" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Forward and backward passes</span></span>
<span id="cb93-233"><a href="#cb93-233" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb93-234"><a href="#cb93-234" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> model(positive_triples, negative_triples)</span>
<span id="cb93-235"><a href="#cb93-235" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb93-236"><a href="#cb93-236" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb93-237"><a href="#cb93-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-238"><a href="#cb93-238" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Normalize embeddings after update</span></span>
<span id="cb93-239"><a href="#cb93-239" aria-hidden="true" tabindex="-1"></a>            model.normalize_embeddings()</span>
<span id="cb93-240"><a href="#cb93-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-241"><a href="#cb93-241" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">+=</span> loss.item()</span>
<span id="cb93-242"><a href="#cb93-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-243"><a href="#cb93-243" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print progress</span></span>
<span id="cb93-244"><a href="#cb93-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb93-245"><a href="#cb93-245" aria-hidden="true" tabindex="-1"></a>            average_loss <span class="op">=</span> total_loss <span class="op">/</span> num_batches</span>
<span id="cb93-246"><a href="#cb93-246" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>epochs<span class="sc">}</span><span class="ss">, Loss: </span><span class="sc">{</span>average_loss<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb93-247"><a href="#cb93-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-248"><a href="#cb93-248" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, entity_map, relation_map, id_to_entity, id_to_relation</span>
<span id="cb93-249"><a href="#cb93-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-250"><a href="#cb93-250" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> complete_kg_with_embeddings(knowledge_graph, top_k<span class="op">=</span><span class="dv">5</span>, threshold<span class="op">=</span><span class="fl">0.8</span>):</span>
<span id="cb93-251"><a href="#cb93-251" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Complete a knowledge graph using embedding-based predictions"""</span></span>
<span id="cb93-252"><a href="#cb93-252" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train embeddings</span></span>
<span id="cb93-253"><a href="#cb93-253" aria-hidden="true" tabindex="-1"></a>    model, entity_map, relation_map, id_to_entity, id_to_relation <span class="op">=</span> train_kg_embeddings(</span>
<span id="cb93-254"><a href="#cb93-254" aria-hidden="true" tabindex="-1"></a>        knowledge_graph</span>
<span id="cb93-255"><a href="#cb93-255" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-256"><a href="#cb93-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-257"><a href="#cb93-257" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare for completion</span></span>
<span id="cb93-258"><a href="#cb93-258" aria-hidden="true" tabindex="-1"></a>    completed_kg <span class="op">=</span> knowledge_graph.copy()</span>
<span id="cb93-259"><a href="#cb93-259" aria-hidden="true" tabindex="-1"></a>    new_facts <span class="op">=</span> []</span>
<span id="cb93-260"><a href="#cb93-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-261"><a href="#cb93-261" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each entity-relation pair, predict potential missing tails</span></span>
<span id="cb93-262"><a href="#cb93-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items():</span>
<span id="cb93-263"><a href="#cb93-263" aria-hidden="true" tabindex="-1"></a>        entity_idx <span class="op">=</span> entity_map[entity_id]</span>
<span id="cb93-264"><a href="#cb93-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-265"><a href="#cb93-265" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check each relation</span></span>
<span id="cb93-266"><a href="#cb93-266" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> relation, rel_idx <span class="kw">in</span> relation_map.items():</span>
<span id="cb93-267"><a href="#cb93-267" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip if this relation already exists for this entity</span></span>
<span id="cb93-268"><a href="#cb93-268" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> relation <span class="kw">in</span> entity_data:</span>
<span id="cb93-269"><a href="#cb93-269" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb93-270"><a href="#cb93-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-271"><a href="#cb93-271" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict tails</span></span>
<span id="cb93-272"><a href="#cb93-272" aria-hidden="true" tabindex="-1"></a>            predicted_tails <span class="op">=</span> model.predict_tail(entity_idx, rel_idx)</span>
<span id="cb93-273"><a href="#cb93-273" aria-hidden="true" tabindex="-1"></a>            top_predictions <span class="op">=</span> predicted_tails[:top_k]</span>
<span id="cb93-274"><a href="#cb93-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-275"><a href="#cb93-275" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert predictions to entities and add to completed graph</span></span>
<span id="cb93-276"><a href="#cb93-276" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> tail_idx <span class="kw">in</span> top_predictions:</span>
<span id="cb93-277"><a href="#cb93-277" aria-hidden="true" tabindex="-1"></a>                tail_id <span class="op">=</span> id_to_entity[tail_idx.item()]</span>
<span id="cb93-278"><a href="#cb93-278" aria-hidden="true" tabindex="-1"></a>                confidence <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> (tail_idx.item() <span class="op">/</span> <span class="bu">len</span>(entity_map))  <span class="co"># Simple confidence heuristic</span></span>
<span id="cb93-279"><a href="#cb93-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-280"><a href="#cb93-280" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> confidence <span class="op">&gt;=</span> threshold:</span>
<span id="cb93-281"><a href="#cb93-281" aria-hidden="true" tabindex="-1"></a>                    new_fact <span class="op">=</span> {</span>
<span id="cb93-282"><a href="#cb93-282" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"subject"</span>: entity_id,</span>
<span id="cb93-283"><a href="#cb93-283" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"predicate"</span>: relation,</span>
<span id="cb93-284"><a href="#cb93-284" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"object"</span>: tail_id,</span>
<span id="cb93-285"><a href="#cb93-285" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"confidence"</span>: confidence,</span>
<span id="cb93-286"><a href="#cb93-286" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"method"</span>: <span class="st">"embedding"</span></span>
<span id="cb93-287"><a href="#cb93-287" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb93-288"><a href="#cb93-288" aria-hidden="true" tabindex="-1"></a>                    new_facts.append(new_fact)</span>
<span id="cb93-289"><a href="#cb93-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-290"><a href="#cb93-290" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Add to completed KG</span></span>
<span id="cb93-291"><a href="#cb93-291" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> relation <span class="kw">not</span> <span class="kw">in</span> completed_kg[entity_id]:</span>
<span id="cb93-292"><a href="#cb93-292" aria-hidden="true" tabindex="-1"></a>                        completed_kg[entity_id][relation] <span class="op">=</span> tail_id</span>
<span id="cb93-293"><a href="#cb93-293" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> <span class="bu">isinstance</span>(completed_kg[entity_id][relation], <span class="bu">list</span>):</span>
<span id="cb93-294"><a href="#cb93-294" aria-hidden="true" tabindex="-1"></a>                        completed_kg[entity_id][relation].append(tail_id)</span>
<span id="cb93-295"><a href="#cb93-295" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb93-296"><a href="#cb93-296" aria-hidden="true" tabindex="-1"></a>                        completed_kg[entity_id][relation] <span class="op">=</span> [completed_kg[entity_id][relation], tail_id]</span>
<span id="cb93-297"><a href="#cb93-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-298"><a href="#cb93-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> completed_kg, new_facts, model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>External source completion implementation</strong>:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> complete_from_external_sources(knowledge_graph, source_configs, max_workers<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Complete a knowledge graph using external data sources</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co">    knowledge_graph: The knowledge graph to complete</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co">    source_configs: Configurations for external data sources</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co">    max_workers: Maximum number of concurrent workers for API calls</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    completed_kg <span class="op">=</span> knowledge_graph.copy()</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    completion_stats <span class="op">=</span> {</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"entities_processed"</span>: <span class="dv">0</span>,</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"entities_enriched"</span>: <span class="dv">0</span>,</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"new_facts_added"</span>: <span class="dv">0</span>,</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"by_source"</span>: {},</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"by_property"</span>: {}</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize stats</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> source <span class="kw">in</span> source_configs:</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>        source_id <span class="op">=</span> source.get(<span class="st">"id"</span>)</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>        completion_stats[<span class="st">"by_source"</span>][source_id] <span class="op">=</span> {</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"entities_processed"</span>: <span class="dv">0</span>,</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"entities_enriched"</span>: <span class="dv">0</span>,</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"new_facts_added"</span>: <span class="dv">0</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process entities in parallel</span></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>max_workers) <span class="im">as</span> executor:</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create tasks for each entity</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>        future_to_entity <span class="op">=</span> {</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>            executor.submit(process_entity, entity_id, entity_data, source_configs):</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>            (entity_id, entity_data)</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> entity_id, entity_data <span class="kw">in</span> knowledge_graph.items()</span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process results as they complete</span></span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> future <span class="kw">in</span> future_to_entity:</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>            entity_id, entity_data <span class="op">=</span> future_to_entity[future]</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>                enrichment_result <span class="op">=</span> future.result()</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update the knowledge graph with enriched data</span></span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> enrichment_result <span class="kw">and</span> enrichment_result.get(<span class="st">"enriched_data"</span>):</span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a>                    completion_stats[<span class="st">"entities_processed"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a>                    enriched_entity <span class="op">=</span> enrichment_result[<span class="st">"enriched_data"</span>]</span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a>                    entity_enriched <span class="op">=</span> <span class="va">False</span></span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Update entity properties</span></span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> prop, value <span class="kw">in</span> enriched_entity.items():</span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Skip if property already exists</span></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> prop <span class="kw">in</span> entity_data <span class="kw">and</span> entity_data[prop] <span class="op">==</span> value:</span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">continue</span></span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Add new property or extend existing one</span></span>
<span id="cb94-61"><a href="#cb94-61" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> prop <span class="kw">not</span> <span class="kw">in</span> entity_data:</span>
<span id="cb94-62"><a href="#cb94-62" aria-hidden="true" tabindex="-1"></a>                            completed_kg[entity_id][prop] <span class="op">=</span> value</span>
<span id="cb94-63"><a href="#cb94-63" aria-hidden="true" tabindex="-1"></a>                            entity_enriched <span class="op">=</span> <span class="va">True</span></span>
<span id="cb94-64"><a href="#cb94-64" aria-hidden="true" tabindex="-1"></a>                            completion_stats[<span class="st">"new_facts_added"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-65"><a href="#cb94-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-66"><a href="#cb94-66" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Track by property</span></span>
<span id="cb94-67"><a href="#cb94-67" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> prop <span class="kw">not</span> <span class="kw">in</span> completion_stats[<span class="st">"by_property"</span>]:</span>
<span id="cb94-68"><a href="#cb94-68" aria-hidden="true" tabindex="-1"></a>                                completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb94-69"><a href="#cb94-69" aria-hidden="true" tabindex="-1"></a>                            completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-70"><a href="#cb94-70" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">elif</span> <span class="bu">isinstance</span>(entity_data[prop], <span class="bu">list</span>):</span>
<span id="cb94-71"><a href="#cb94-71" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># If current value is a list, append new value if it's not already included</span></span>
<span id="cb94-72"><a href="#cb94-72" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> value <span class="kw">not</span> <span class="kw">in</span> entity_data[prop]:</span>
<span id="cb94-73"><a href="#cb94-73" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">list</span>):</span>
<span id="cb94-74"><a href="#cb94-74" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># Extend with new values</span></span>
<span id="cb94-75"><a href="#cb94-75" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">for</span> v <span class="kw">in</span> value:</span>
<span id="cb94-76"><a href="#cb94-76" aria-hidden="true" tabindex="-1"></a>                                        <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> completed_kg[entity_id][prop]:</span>
<span id="cb94-77"><a href="#cb94-77" aria-hidden="true" tabindex="-1"></a>                                            completed_kg[entity_id][prop].append(v)</span>
<span id="cb94-78"><a href="#cb94-78" aria-hidden="true" tabindex="-1"></a>                                            entity_enriched <span class="op">=</span> <span class="va">True</span></span>
<span id="cb94-79"><a href="#cb94-79" aria-hidden="true" tabindex="-1"></a>                                            completion_stats[<span class="st">"new_facts_added"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-80"><a href="#cb94-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-81"><a href="#cb94-81" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">if</span> prop <span class="kw">not</span> <span class="kw">in</span> completion_stats[<span class="st">"by_property"</span>]:</span>
<span id="cb94-82"><a href="#cb94-82" aria-hidden="true" tabindex="-1"></a>                                                completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb94-83"><a href="#cb94-83" aria-hidden="true" tabindex="-1"></a>                                            completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-84"><a href="#cb94-84" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">else</span>:</span>
<span id="cb94-85"><a href="#cb94-85" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># Append single value</span></span>
<span id="cb94-86"><a href="#cb94-86" aria-hidden="true" tabindex="-1"></a>                                    completed_kg[entity_id][prop].append(value)</span>
<span id="cb94-87"><a href="#cb94-87" aria-hidden="true" tabindex="-1"></a>                                    entity_enriched <span class="op">=</span> <span class="va">True</span></span>
<span id="cb94-88"><a href="#cb94-88" aria-hidden="true" tabindex="-1"></a>                                    completion_stats[<span class="st">"new_facts_added"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-89"><a href="#cb94-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-90"><a href="#cb94-90" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">if</span> prop <span class="kw">not</span> <span class="kw">in</span> completion_stats[<span class="st">"by_property"</span>]:</span>
<span id="cb94-91"><a href="#cb94-91" aria-hidden="true" tabindex="-1"></a>                                        completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb94-92"><a href="#cb94-92" aria-hidden="true" tabindex="-1"></a>                                    completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-93"><a href="#cb94-93" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb94-94"><a href="#cb94-94" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Current value is singular - convert to list</span></span>
<span id="cb94-95"><a href="#cb94-95" aria-hidden="true" tabindex="-1"></a>                            completed_kg[entity_id][prop] <span class="op">=</span> [entity_data[prop], value]</span>
<span id="cb94-96"><a href="#cb94-96" aria-hidden="true" tabindex="-1"></a>                            entity_enriched <span class="op">=</span> <span class="va">True</span></span>
<span id="cb94-97"><a href="#cb94-97" aria-hidden="true" tabindex="-1"></a>                            completion_stats[<span class="st">"new_facts_added"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-98"><a href="#cb94-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-99"><a href="#cb94-99" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> prop <span class="kw">not</span> <span class="kw">in</span> completion_stats[<span class="st">"by_property"</span>]:</span>
<span id="cb94-100"><a href="#cb94-100" aria-hidden="true" tabindex="-1"></a>                                completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb94-101"><a href="#cb94-101" aria-hidden="true" tabindex="-1"></a>                            completion_stats[<span class="st">"by_property"</span>][prop] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-102"><a href="#cb94-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-103"><a href="#cb94-103" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Update source statistics</span></span>
<span id="cb94-104"><a href="#cb94-104" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> source_id, source_stats <span class="kw">in</span> enrichment_result[<span class="st">"stats"</span>].items():</span>
<span id="cb94-105"><a href="#cb94-105" aria-hidden="true" tabindex="-1"></a>                        completion_stats[<span class="st">"by_source"</span>][source_id][<span class="st">"entities_processed"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-106"><a href="#cb94-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-107"><a href="#cb94-107" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> source_stats[<span class="st">"facts_added"</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb94-108"><a href="#cb94-108" aria-hidden="true" tabindex="-1"></a>                            completion_stats[<span class="st">"by_source"</span>][source_id][<span class="st">"entities_enriched"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-109"><a href="#cb94-109" aria-hidden="true" tabindex="-1"></a>                            completion_stats[<span class="st">"by_source"</span>][source_id][<span class="st">"new_facts_added"</span>] <span class="op">+=</span> source_stats[<span class="st">"facts_added"</span>]</span>
<span id="cb94-110"><a href="#cb94-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-111"><a href="#cb94-111" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> entity_enriched:</span>
<span id="cb94-112"><a href="#cb94-112" aria-hidden="true" tabindex="-1"></a>                        completion_stats[<span class="st">"entities_enriched"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb94-113"><a href="#cb94-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-114"><a href="#cb94-114" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Add provenance information</span></span>
<span id="cb94-115"><a href="#cb94-115" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="st">"sources"</span> <span class="kw">not</span> <span class="kw">in</span> completed_kg[entity_id]:</span>
<span id="cb94-116"><a href="#cb94-116" aria-hidden="true" tabindex="-1"></a>                            completed_kg[entity_id][<span class="st">"sources"</span>] <span class="op">=</span> []</span>
<span id="cb94-117"><a href="#cb94-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-118"><a href="#cb94-118" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> source_id <span class="kw">in</span> enrichment_result[<span class="st">"stats"</span>]:</span>
<span id="cb94-119"><a href="#cb94-119" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> source_id <span class="kw">not</span> <span class="kw">in</span> completed_kg[entity_id][<span class="st">"sources"</span>]:</span>
<span id="cb94-120"><a href="#cb94-120" aria-hidden="true" tabindex="-1"></a>                                completed_kg[entity_id][<span class="st">"sources"</span>].append(source_id)</span>
<span id="cb94-121"><a href="#cb94-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-122"><a href="#cb94-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb94-123"><a href="#cb94-123" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error processing entity </span><span class="sc">{</span>entity_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb94-124"><a href="#cb94-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-125"><a href="#cb94-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> completed_kg, completion_stats</span>
<span id="cb94-126"><a href="#cb94-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-127"><a href="#cb94-127" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_entity(entity_id, entity_data, source_configs):</span>
<span id="cb94-128"><a href="#cb94-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Process an entity through all configured external sources"""</span></span>
<span id="cb94-129"><a href="#cb94-129" aria-hidden="true" tabindex="-1"></a>    entity_type <span class="op">=</span> entity_data.get(<span class="st">"type"</span>)</span>
<span id="cb94-130"><a href="#cb94-130" aria-hidden="true" tabindex="-1"></a>    enriched_data <span class="op">=</span> {}</span>
<span id="cb94-131"><a href="#cb94-131" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {}</span>
<span id="cb94-132"><a href="#cb94-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-133"><a href="#cb94-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> source_config <span class="kw">in</span> source_configs:</span>
<span id="cb94-134"><a href="#cb94-134" aria-hidden="true" tabindex="-1"></a>        source_id <span class="op">=</span> source_config.get(<span class="st">"id"</span>)</span>
<span id="cb94-135"><a href="#cb94-135" aria-hidden="true" tabindex="-1"></a>        applicable_types <span class="op">=</span> source_config.get(<span class="st">"applicable_types"</span>, [])</span>
<span id="cb94-136"><a href="#cb94-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-137"><a href="#cb94-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip if this source is not applicable for this entity type</span></span>
<span id="cb94-138"><a href="#cb94-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> applicable_types <span class="kw">and</span> entity_type <span class="kw">not</span> <span class="kw">in</span> applicable_types:</span>
<span id="cb94-139"><a href="#cb94-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb94-140"><a href="#cb94-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-141"><a href="#cb94-141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to enrich with this source</span></span>
<span id="cb94-142"><a href="#cb94-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb94-143"><a href="#cb94-143" aria-hidden="true" tabindex="-1"></a>            source_result <span class="op">=</span> query_external_source(</span>
<span id="cb94-144"><a href="#cb94-144" aria-hidden="true" tabindex="-1"></a>                entity_id, entity_data, source_config</span>
<span id="cb94-145"><a href="#cb94-145" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb94-146"><a href="#cb94-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-147"><a href="#cb94-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> source_result:</span>
<span id="cb94-148"><a href="#cb94-148" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Merge with existing enriched data</span></span>
<span id="cb94-149"><a href="#cb94-149" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> prop, value <span class="kw">in</span> source_result.items():</span>
<span id="cb94-150"><a href="#cb94-150" aria-hidden="true" tabindex="-1"></a>                    enriched_data[prop] <span class="op">=</span> value</span>
<span id="cb94-151"><a href="#cb94-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-152"><a href="#cb94-152" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Track statistics</span></span>
<span id="cb94-153"><a href="#cb94-153" aria-hidden="true" tabindex="-1"></a>                stats[source_id] <span class="op">=</span> {</span>
<span id="cb94-154"><a href="#cb94-154" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"facts_added"</span>: <span class="bu">len</span>(source_result)</span>
<span id="cb94-155"><a href="#cb94-155" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb94-156"><a href="#cb94-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb94-157"><a href="#cb94-157" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error querying source </span><span class="sc">{</span>source_id<span class="sc">}</span><span class="ss"> for entity </span><span class="sc">{</span>entity_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb94-158"><a href="#cb94-158" aria-hidden="true" tabindex="-1"></a>            stats[source_id] <span class="op">=</span> {</span>
<span id="cb94-159"><a href="#cb94-159" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"facts_added"</span>: <span class="dv">0</span></span>
<span id="cb94-160"><a href="#cb94-160" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb94-161"><a href="#cb94-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-162"><a href="#cb94-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb94-163"><a href="#cb94-163" aria-hidden="true" tabindex="-1"></a>        <span class="st">"entity_id"</span>: entity_id,</span>
<span id="cb94-164"><a href="#cb94-164" aria-hidden="true" tabindex="-1"></a>        <span class="st">"enriched_data"</span>: enriched_data,</span>
<span id="cb94-165"><a href="#cb94-165" aria-hidden="true" tabindex="-1"></a>        <span class="st">"stats"</span>: stats</span>
<span id="cb94-166"><a href="#cb94-166" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-167"><a href="#cb94-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-168"><a href="#cb94-168" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_external_source(entity_id, entity_data, source_config):</span>
<span id="cb94-169"><a href="#cb94-169" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Query an external source for additional entity information"""</span></span>
<span id="cb94-170"><a href="#cb94-170" aria-hidden="true" tabindex="-1"></a>    source_type <span class="op">=</span> source_config.get(<span class="st">"type"</span>)</span>
<span id="cb94-171"><a href="#cb94-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-172"><a href="#cb94-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> source_type <span class="op">==</span> <span class="st">"rest_api"</span>:</span>
<span id="cb94-173"><a href="#cb94-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> query_rest_api(entity_id, entity_data, source_config)</span>
<span id="cb94-174"><a href="#cb94-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> source_type <span class="op">==</span> <span class="st">"sparql_endpoint"</span>:</span>
<span id="cb94-175"><a href="#cb94-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> query_sparql_endpoint(entity_id, entity_data, source_config)</span>
<span id="cb94-176"><a href="#cb94-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> source_type <span class="op">==</span> <span class="st">"custom"</span>:</span>
<span id="cb94-177"><a href="#cb94-177" aria-hidden="true" tabindex="-1"></a>        custom_function <span class="op">=</span> source_config.get(<span class="st">"query_function"</span>)</span>
<span id="cb94-178"><a href="#cb94-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">callable</span>(custom_function):</span>
<span id="cb94-179"><a href="#cb94-179" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> custom_function(entity_id, entity_data, source_config)</span>
<span id="cb94-180"><a href="#cb94-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-181"><a href="#cb94-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb94-182"><a href="#cb94-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-183"><a href="#cb94-183" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_rest_api(entity_id, entity_data, source_config):</span>
<span id="cb94-184"><a href="#cb94-184" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Query a REST API for entity enrichment"""</span></span>
<span id="cb94-185"><a href="#cb94-185" aria-hidden="true" tabindex="-1"></a>    base_url <span class="op">=</span> source_config.get(<span class="st">"base_url"</span>)</span>
<span id="cb94-186"><a href="#cb94-186" aria-hidden="true" tabindex="-1"></a>    endpoint <span class="op">=</span> source_config.get(<span class="st">"endpoint"</span>)</span>
<span id="cb94-187"><a href="#cb94-187" aria-hidden="true" tabindex="-1"></a>    method <span class="op">=</span> source_config.get(<span class="st">"method"</span>, <span class="st">"GET"</span>)</span>
<span id="cb94-188"><a href="#cb94-188" aria-hidden="true" tabindex="-1"></a>    headers <span class="op">=</span> source_config.get(<span class="st">"headers"</span>, {})</span>
<span id="cb94-189"><a href="#cb94-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-190"><a href="#cb94-190" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare query parameters</span></span>
<span id="cb94-191"><a href="#cb94-191" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {}</span>
<span id="cb94-192"><a href="#cb94-192" aria-hidden="true" tabindex="-1"></a>    param_mapping <span class="op">=</span> source_config.get(<span class="st">"param_mapping"</span>, {})</span>
<span id="cb94-193"><a href="#cb94-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-194"><a href="#cb94-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> param_name, entity_prop <span class="kw">in</span> param_mapping.items():</span>
<span id="cb94-195"><a href="#cb94-195" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> entity_prop <span class="kw">in</span> entity_data:</span>
<span id="cb94-196"><a href="#cb94-196" aria-hidden="true" tabindex="-1"></a>            params[param_name] <span class="op">=</span> entity_data[entity_prop]</span>
<span id="cb94-197"><a href="#cb94-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-198"><a href="#cb94-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add API key if provided</span></span>
<span id="cb94-199"><a href="#cb94-199" aria-hidden="true" tabindex="-1"></a>    api_key <span class="op">=</span> source_config.get(<span class="st">"api_key"</span>)</span>
<span id="cb94-200"><a href="#cb94-200" aria-hidden="true" tabindex="-1"></a>    api_key_param <span class="op">=</span> source_config.get(<span class="st">"api_key_param"</span>)</span>
<span id="cb94-201"><a href="#cb94-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-202"><a href="#cb94-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> api_key <span class="kw">and</span> api_key_param:</span>
<span id="cb94-203"><a href="#cb94-203" aria-hidden="true" tabindex="-1"></a>        params[api_key_param] <span class="op">=</span> api_key</span>
<span id="cb94-204"><a href="#cb94-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-205"><a href="#cb94-205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make the request</span></span>
<span id="cb94-206"><a href="#cb94-206" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>endpoint<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb94-207"><a href="#cb94-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-208"><a href="#cb94-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">"GET"</span>:</span>
<span id="cb94-209"><a href="#cb94-209" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(url, params<span class="op">=</span>params, headers<span class="op">=</span>headers)</span>
<span id="cb94-210"><a href="#cb94-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> method <span class="op">==</span> <span class="st">"POST"</span>:</span>
<span id="cb94-211"><a href="#cb94-211" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.post(url, json<span class="op">=</span>params, headers<span class="op">=</span>headers)</span>
<span id="cb94-212"><a href="#cb94-212" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb94-213"><a href="#cb94-213" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unsupported method: </span><span class="sc">{</span>method<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb94-214"><a href="#cb94-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-215"><a href="#cb94-215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process response</span></span>
<span id="cb94-216"><a href="#cb94-216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb94-217"><a href="#cb94-217" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> response.json()</span>
<span id="cb94-218"><a href="#cb94-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-219"><a href="#cb94-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process the response data</span></span>
<span id="cb94-220"><a href="#cb94-220" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> {}</span>
<span id="cb94-221"><a href="#cb94-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-222"><a href="#cb94-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply response mapping</span></span>
<span id="cb94-223"><a href="#cb94-223" aria-hidden="true" tabindex="-1"></a>        response_mapping <span class="op">=</span> source_config.get(<span class="st">"response_mapping"</span>, {})</span>
<span id="cb94-224"><a href="#cb94-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-225"><a href="#cb94-225" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> kg_prop, response_path <span class="kw">in</span> response_mapping.items():</span>
<span id="cb94-226"><a href="#cb94-226" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> extract_from_json_path(data, response_path)</span>
<span id="cb94-227"><a href="#cb94-227" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb94-228"><a href="#cb94-228" aria-hidden="true" tabindex="-1"></a>                result[kg_prop] <span class="op">=</span> value</span>
<span id="cb94-229"><a href="#cb94-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-230"><a href="#cb94-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb94-231"><a href="#cb94-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb94-232"><a href="#cb94-232" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"API request failed with status code </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb94-233"><a href="#cb94-233" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb94-234"><a href="#cb94-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-235"><a href="#cb94-235" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_from_json_path(data, path):</span>
<span id="cb94-236"><a href="#cb94-236" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract a value from a nested JSON structure using a dot-notation path"""</span></span>
<span id="cb94-237"><a href="#cb94-237" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> path:</span>
<span id="cb94-238"><a href="#cb94-238" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> data</span>
<span id="cb94-239"><a href="#cb94-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-240"><a href="#cb94-240" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> path.split(<span class="st">"."</span>)</span>
<span id="cb94-241"><a href="#cb94-241" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> data</span>
<span id="cb94-242"><a href="#cb94-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-243"><a href="#cb94-243" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> part <span class="kw">in</span> parts:</span>
<span id="cb94-244"><a href="#cb94-244" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle array indexing</span></span>
<span id="cb94-245"><a href="#cb94-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"["</span> <span class="kw">in</span> part <span class="kw">and</span> part.endswith(<span class="st">"]"</span>):</span>
<span id="cb94-246"><a href="#cb94-246" aria-hidden="true" tabindex="-1"></a>            array_part, idx_part <span class="op">=</span> part.split(<span class="st">"["</span>, <span class="dv">1</span>)</span>
<span id="cb94-247"><a href="#cb94-247" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> <span class="bu">int</span>(idx_part[:<span class="op">-</span><span class="dv">1</span>])  <span class="co"># Remove closing bracket and convert to int</span></span>
<span id="cb94-248"><a href="#cb94-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-249"><a href="#cb94-249" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> array_part:</span>
<span id="cb94-250"><a href="#cb94-250" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> array_part <span class="kw">not</span> <span class="kw">in</span> current:</span>
<span id="cb94-251"><a href="#cb94-251" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb94-252"><a href="#cb94-252" aria-hidden="true" tabindex="-1"></a>                current <span class="op">=</span> current[array_part]</span>
<span id="cb94-253"><a href="#cb94-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-254"><a href="#cb94-254" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(current, <span class="bu">list</span>) <span class="kw">and</span> <span class="dv">0</span> <span class="op">&lt;=</span> idx <span class="op">&lt;</span> <span class="bu">len</span>(current):</span>
<span id="cb94-255"><a href="#cb94-255" aria-hidden="true" tabindex="-1"></a>                current <span class="op">=</span> current[idx]</span>
<span id="cb94-256"><a href="#cb94-256" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb94-257"><a href="#cb94-257" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb94-258"><a href="#cb94-258" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb94-259"><a href="#cb94-259" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Regular property access</span></span>
<span id="cb94-260"><a href="#cb94-260" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(current, <span class="bu">dict</span>) <span class="kw">and</span> part <span class="kw">in</span> current:</span>
<span id="cb94-261"><a href="#cb94-261" aria-hidden="true" tabindex="-1"></a>                current <span class="op">=</span> current[part]</span>
<span id="cb94-262"><a href="#cb94-262" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb94-263"><a href="#cb94-263" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb94-264"><a href="#cb94-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-265"><a href="#cb94-265" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> current</span>
<span id="cb94-266"><a href="#cb94-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-267"><a href="#cb94-267" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_sparql_endpoint(entity_id, entity_data, source_config):</span>
<span id="cb94-268"><a href="#cb94-268" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Query a SPARQL endpoint for entity enrichment"""</span></span>
<span id="cb94-269"><a href="#cb94-269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This implementation would use the SPARQLWrapper library or similar</span></span>
<span id="cb94-270"><a href="#cb94-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to query a SPARQL endpoint for additional entity information</span></span>
<span id="cb94-271"><a href="#cb94-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-272"><a href="#cb94-272" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplified placeholder implementation</span></span>
<span id="cb94-273"><a href="#cb94-273" aria-hidden="true" tabindex="-1"></a>    sparql_endpoint <span class="op">=</span> source_config.get(<span class="st">"endpoint_url"</span>)</span>
<span id="cb94-274"><a href="#cb94-274" aria-hidden="true" tabindex="-1"></a>    query_template <span class="op">=</span> source_config.get(<span class="st">"query_template"</span>)</span>
<span id="cb94-275"><a href="#cb94-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-276"><a href="#cb94-276" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create query from template</span></span>
<span id="cb94-277"><a href="#cb94-277" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> query_template</span>
<span id="cb94-278"><a href="#cb94-278" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> placeholder, prop <span class="kw">in</span> source_config.get(<span class="st">"query_mapping"</span>, {}).items():</span>
<span id="cb94-279"><a href="#cb94-279" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prop <span class="kw">in</span> entity_data:</span>
<span id="cb94-280"><a href="#cb94-280" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> entity_data[prop]</span>
<span id="cb94-281"><a href="#cb94-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-282"><a href="#cb94-282" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format value based on type</span></span>
<span id="cb94-283"><a href="#cb94-283" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">str</span>):</span>
<span id="cb94-284"><a href="#cb94-284" aria-hidden="true" tabindex="-1"></a>                formatted_value <span class="op">=</span> <span class="ss">f'"</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"'</span></span>
<span id="cb94-285"><a href="#cb94-285" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb94-286"><a href="#cb94-286" aria-hidden="true" tabindex="-1"></a>                formatted_value <span class="op">=</span> <span class="bu">str</span>(value)</span>
<span id="cb94-287"><a href="#cb94-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-288"><a href="#cb94-288" aria-hidden="true" tabindex="-1"></a>            query <span class="op">=</span> query.replace(placeholder, formatted_value)</span>
<span id="cb94-289"><a href="#cb94-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-290"><a href="#cb94-290" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute query and process results</span></span>
<span id="cb94-291"><a href="#cb94-291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In a real implementation, you would use SPARQLWrapper or similar</span></span>
<span id="cb94-292"><a href="#cb94-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-293"><a href="#cb94-293" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Placeholder - return empty result</span></span>
<span id="cb94-294"><a href="#cb94-294" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</div>
<p>Challenges in knowledge graph completion include:</p>
<ol type="1">
<li><strong>Balancing precision and recall</strong>: Determining the confidence threshold for accepting predictions</li>
<li><strong>Handling conflicting completions</strong>: Resolving contradictions from different completion methods</li>
<li><strong>Evaluating completion quality</strong>: Assessing the accuracy of automatically derived knowledge</li>
<li><strong>Domain-specific knowledge</strong>: Adapting completion approaches to specific domains</li>
<li><strong>Computational complexity</strong>: Managing the computational cost of completion algorithms</li>
</ol>
</section>
<section id="context-and-provenance-enrichment" class="level3" data-number="6.6.3">
<h3 data-number="6.6.3" class="anchored" data-anchor-id="context-and-provenance-enrichment"><span class="header-section-number">6.6.3</span> Context and provenance enrichment</h3>
<p>Enriching knowledge graphs with context and provenance information enhances their trustworthiness and utility:</p>
<div id="def-provenance" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.22 (Context and provenance enrichment)</strong></span> <strong>Context enrichment</strong> adds situational information to knowledge graph facts, such as:</p>
<ol type="1">
<li>Temporal context (when a fact is valid)</li>
<li>Spatial context (where a fact applies)</li>
<li>Conditional context (under what conditions a fact holds)</li>
</ol>
<p><strong>Provenance enrichment</strong> adds metadata about the origin and derivation of knowledge, including:</p>
<ol type="1">
<li>Source attribution (where information came from)</li>
<li>Extraction method (how information was obtained)</li>
<li>Confidence scores (how certain the information is)</li>
<li>Derivation chains (how inferred knowledge was derived)</li>
</ol>
</div>
<div id="exm-provenance" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.36 (Context and provenance enrichment examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Temporal context</strong>:</p>
<pre><code>Triple: (Berlin, capitalOf, Germany)

Enriched with temporal context:
{
  "fact": "Berlin is the capital of Germany",
  "subject": "Berlin",
  "predicate": "capitalOf",
  "object": "Germany",
  "validFrom": "1990-10-03",
  "validUntil": null
}</code></pre></li>
<li><p><strong>Source provenance</strong>:</p>
<pre><code>Triple: (Aspirin, treats, Headache)

Enriched with source provenance:
{
  "fact": "Aspirin treats headaches",
  "subject": "Aspirin",
  "predicate": "treats",
  "object": "Headache",
  "sources": [
    {
      "id": "PMID:12345678",
      "type": "medical_literature",
      "title": "Efficacy of aspirin for tension headaches",
      "year": 2015,
      "reliability": 0.9
    },
    {
      "id": "DrugBank:DB00945",
      "type": "pharmaceutical_database",
      "version": "5.1.8",
      "reliability": 0.95
    }
  ]
}</code></pre></li>
<li><p><strong>Extraction provenance</strong>:</p>
<pre><code>Triple: (COVID-19, causedBy, SARS-CoV-2)

Enriched with extraction provenance:
{
  "fact": "COVID-19 is caused by SARS-CoV-2",
  "subject": "COVID-19",
  "predicate": "causedBy",
  "object": "SARS-CoV-2",
  "extraction": {
    "method": "NLP",
    "tool": "BioBERT v1.1",
    "source_text": "The novel coronavirus SARS-CoV-2 is the causative agent of COVID-19.",
    "confidence": 0.96,
    "extracted_date": "2023-05-10T14:32:17Z"
  }
}</code></pre></li>
<li><p><strong>Derivation provenance</strong>:</p>
<pre><code>Triple: (Alice, grandparentOf, Charlie)

Enriched with derivation provenance:
{
  "fact": "Alice is a grandparent of Charlie",
  "subject": "Alice",
  "predicate": "grandparentOf",
  "object": "Charlie",
  "derivation": {
    "type": "inference",
    "rule": "IF X parentOf Y AND Y parentOf Z THEN X grandparentOf Z",
    "premises": [
      {
        "subject": "Alice",
        "predicate": "parentOf",
        "object": "Bob",
        "source": "Birth Certificate DB"
      },
      {
        "subject": "Bob",
        "predicate": "parentOf",
        "object": "Charlie",
        "source": "School Registration DB"
      }
    ],
    "confidence": 0.99
  }
}</code></pre></li>
</ol>
</div>
<p>Approaches to context and provenance enrichment include:</p>
<ol type="1">
<li><p><strong>Metadata models</strong>: Standards and schemas for representing provenance</p>
<ul>
<li>PROV-O (Provenance Ontology)</li>
<li>Dublin Core</li>
<li>W3C Web Annotation Data Model</li>
<li>Named graphs and RDF quads (for context management)</li>
</ul></li>
<li><p><strong>Confidence scoring mechanisms</strong>: Methods for quantifying certainty</p>
<ul>
<li>Probabilistic models</li>
<li>Fuzzy truth values</li>
<li>Evidence-based scoring</li>
<li>Source reliability weighting</li>
</ul></li>
<li><p><strong>Temporal modeling</strong>: Representing time-varying knowledge</p>
<ul>
<li>Time interval representation</li>
<li>Versioning systems</li>
<li>Temporal query languages</li>
<li>Validity periods</li>
</ul></li>
</ol>
<p>Challenges in provenance enrichment include:</p>
<ol type="1">
<li><strong>Granularity trade-offs</strong>: Determining the appropriate level of provenance detail</li>
<li><strong>Computational overhead</strong>: Managing the increased storage and processing requirements</li>
<li><strong>Provenance integration</strong>: Combining provenance from diverse sources</li>
<li><strong>Query complexity</strong>: Supporting provenance-aware queries efficiently</li>
<li><strong>User interface design</strong>: Presenting provenance information effectively to users</li>
</ol>
</section>
<section id="semantic-enrichment-and-alignment" class="level3" data-number="6.6.4">
<h3 data-number="6.6.4" class="anchored" data-anchor-id="semantic-enrichment-and-alignment"><span class="header-section-number">6.6.4</span> Semantic enrichment and alignment</h3>
<p>Semantic enrichment enhances knowledge graphs with deeper meaning and connections to established semantic resources:</p>
<div id="def-semantic-enrichment" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.23 (Semantic enrichment and alignment)</strong></span> <strong>Semantic enrichment</strong> adds deeper semantic context to knowledge graph elements through:</p>
<ol type="1">
<li>Type enhancement and ontological classification</li>
<li>Semantic annotation with domain concepts</li>
<li>Linking to semantic resources and lexical databases</li>
<li>Relationship qualification and contextualization</li>
</ol>
<p><strong>Semantic alignment</strong> connects knowledge graph elements to established semantic resources like:</p>
<ol type="1">
<li>WordNet, ConceptNet, or BabelNet for lexical relations</li>
<li>Domain-specific ontologies for specialized terminology</li>
<li>Upper ontologies for fundamental categories</li>
<li>Linked Open Data resources for global entity alignment</li>
</ol>
</div>
<div id="exm-semantic-enrichment" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.37 (Semantic enrichment examples)</strong></span> &nbsp;</p>
<ol type="1">
<li><p><strong>Type enhancement</strong>:</p>
<pre><code>Original entity:
{
  "id": "entity:12345",
  "type": "Person",
  "name": "Marie Curie",
  "field": "Physics"
}

Semantically enriched:
{
  "id": "entity:12345",
  "type": ["Person", "Scientist", "Physicist", "NobelLaureate", "Researcher"],
  "name": "Marie Curie",
  "field": "Physics",
  "typeHierarchy": {
    "Person": {
      "Scientist": {
        "Physicist": {}
      },
      "Researcher": {}
    },
    "NobelLaureate": {}
  }
}</code></pre></li>
<li><p><strong>Lexical enrichment</strong>:</p>
<pre><code>Original relation:
(Cancer, affects, Lung)

Semantically enriched with WordNet:
{
  "relation": "affects",
  "wordnet": {
    "synset": "affect.v.01",
    "definition": "have an effect upon",
    "synonyms": ["influence", "impact", "alter"],
    "hypernyms": ["change.v.01"]
  }
}</code></pre></li>
<li><p><strong>Semantic web alignment</strong>:</p>
<pre><code>Original entity:
{
  "id": "location:paris",
  "type": "City",
  "name": "Paris",
  "country": "France"
}

With semantic web alignment:
{
  "id": "location:paris",
  "type": "City",
  "name": "Paris",
  "country": "France",
  "sameAs": [
    "http://dbpedia.org/resource/Paris",
    "http://www.wikidata.org/entity/Q90",
    "http://sws.geonames.org/2988507/"
  ],
  "schema:type": "http://schema.org/City"
}</code></pre></li>
<li><p><strong>Conceptual enrichment</strong>:</p>
<pre><code>Original concept:
{
  "id": "concept:machine_learning",
  "type": "Topic",
  "name": "Machine Learning"
}

With conceptual enrichment:
{
  "id": "concept:machine_learning",
  "type": "Topic",
  "name": "Machine Learning",
  "broader": ["Artificial Intelligence", "Computer Science"],
  "narrower": ["Neural Networks", "Decision Trees", "Reinforcement Learning"],
  "related": ["Data Mining", "Pattern Recognition", "Statistical Analysis"],
  "definition": "Field of study that gives computers the ability to learn without being explicitly programmed"
}</code></pre></li>
</ol>
</div>
<p>Implementation approaches for semantic enrichment include:</p>
<ol type="1">
<li><p><strong>Entity linking</strong>: Connecting mentions to knowledge bases</p>
<ul>
<li>Example: Linking “NYC” to DBpedia entity for New York City</li>
<li>Techniques: Candidate generation, context-based disambiguation, graph-based alignment</li>
</ul></li>
<li><p><strong>Type inference</strong>: Determining more specific entity types</p>
<ul>
<li>Example: Inferring that an entity is not just a Person but specifically a Scientist</li>
<li>Techniques: Pattern-based inference, statistical classification, ontological reasoning</li>
</ul></li>
<li><p><strong>Relationship qualification</strong>: Enriching relationship semantics</p>
<ul>
<li>Example: Adding temporal scope, certainty, or directness to relationships</li>
<li>Techniques: Pattern analysis, contextual inference, semantic frames</li>
</ul></li>
<li><p><strong>Cross-lingual alignment</strong>: Connecting across language barriers</p>
<ul>
<li>Example: Aligning “Maladie” (French) with “Disease” (English)</li>
<li>Techniques: Multilingual embeddings, translation-based alignment, shared identifiers</li>
</ul></li>
</ol>
<p>Challenges in semantic enrichment include:</p>
<ol type="1">
<li><strong>Semantic ambiguity</strong>: Resolving multiple possible meanings</li>
<li><strong>Knowledge base coverage</strong>: Handling entities not present in reference resources</li>
<li><strong>Cross-domain alignment</strong>: Connecting concepts across different domains</li>
<li><strong>Semantic drift</strong>: Managing meaning changes over time or context</li>
<li><strong>Integration complexity</strong>: Combining multiple semantic resources coherently</li>
</ol>
</section>
</section>
<section id="summary" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="summary"><span class="header-section-number">6.7</span> Summary</h2>
<p>This chapter has explored the process of knowledge graph construction, covering the entire lifecycle from data extraction to quality assessment and enrichment. We’ve examined various approaches for extracting knowledge from structured, semi-structured, and unstructured data sources, and techniques for integrating this knowledge into a coherent and high-quality graph.</p>
<p>Key topics covered include:</p>
<ol type="1">
<li><p><strong>Knowledge graph construction lifecycle</strong>: The systematic process of planning, extracting, integrating, and maintaining knowledge graphs, with different architectural approaches for implementation.</p></li>
<li><p><strong>Data sources for knowledge graphs</strong>: The variety of sources that can contribute to knowledge graphs, including structured databases, semi-structured web content, and unstructured text, each requiring specialized extraction techniques.</p></li>
<li><p><strong>Information extraction techniques</strong>: Methods for identifying entities, relationships, attributes, and events from various data sources, including specialized approaches for domain-specific knowledge.</p></li>
<li><p><strong>Entity resolution and linking</strong>: Techniques for identifying when different mentions refer to the same entity and connecting extracted entities to existing knowledge sources, critical for building coherent knowledge graphs.</p></li>
<li><p><strong>Knowledge graph integration and fusion</strong>: Approaches for combining information from multiple sources while addressing schema heterogeneity, resolving conflicts, and ensuring consistency.</p></li>
<li><p><strong>Quality assessment and enrichment</strong>: Methods for evaluating knowledge graph quality along multiple dimensions and enhancing graphs with additional knowledge, context, and semantic connections.</p></li>
</ol>
<p>The construction of high-quality knowledge graphs remains a complex challenge, requiring a combination of automated techniques and human expertise. However, the methodologies and tools discussed in this chapter provide a framework for systematically addressing this challenge, enabling the creation of knowledge graphs that can serve as valuable resources for a wide range of applications.</p>
<p>As knowledge graph technology continues to evolve, construction approaches are becoming more sophisticated, leveraging advances in machine learning, natural language processing, and semantic technologies to automate and improve the extraction and integration of knowledge from diverse sources. At the same time, the importance of quality assessment, provenance tracking, and semantic enrichment is increasingly recognized as critical for ensuring that knowledge graphs can be trusted and effectively utilized in real-world applications.</p>
</section>
<section id="exercises" class="level2" data-number="6.8">
<h2 data-number="6.8" class="anchored" data-anchor-id="exercises"><span class="header-section-number">6.8</span> Exercises</h2>
<div id="exr-construction-lifecycle" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.1 (Knowledge graph construction lifecycle)</strong></span> Design a complete construction lifecycle for a knowledge graph in a domain of your choice (e.g., healthcare, finance, scientific research). Your design should include:</p>
<ol type="1">
<li>Identify key data sources (at least one of each type: structured, semi-structured, unstructured)</li>
<li>Specify the extraction approach for each source</li>
<li>Describe the integration strategy, including schema alignment</li>
<li>Outline a quality assessment plan with specific metrics</li>
<li>Propose an enrichment strategy to enhance the initial graph</li>
</ol>
<p>Discuss potential challenges in each phase and how you would address them.</p>
</div>
<div id="exr-information-extraction" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.2 (Information extraction techniques)</strong></span> Compare and contrast three different approaches to relationship extraction:</p>
<ol type="1">
<li>Pattern-based extraction</li>
<li>Supervised machine learning</li>
<li>Distant supervision</li>
</ol>
<p>For each approach:</p>
<ul>
<li>Explain how it works conceptually</li>
<li>Identify its strengths and limitations</li>
<li>Describe a scenario where it would be the most appropriate choice</li>
<li>Provide an example of how it would extract a specific relationship from text</li>
</ul>
<p>Conclude with guidelines for selecting an appropriate extraction approach based on data characteristics and project requirements.</p>
</div>
<div id="exr-entity-resolution" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.3 (Entity resolution scenario)</strong></span> You are building a knowledge graph about scientific publications by integrating data from:</p>
<ol type="1">
<li>A bibliographic database with paper metadata</li>
<li>A university database with researcher information</li>
<li>A conference proceedings database</li>
<li>A scientific social network</li>
</ol>
<p>The same researchers and papers may appear in multiple sources with variations in names, affiliations, and other attributes.</p>
<p>Design an entity resolution pipeline that addresses:</p>
<ol type="1">
<li>Researcher identity resolution across sources</li>
<li>Paper deduplication and alignment</li>
<li>Affiliation normalization and matching</li>
<li>Handling of temporal changes (e.g., name changes, changing affiliations)</li>
</ol>
<p>Include both technical approaches and practical considerations in your design.</p>
</div>
<div id="exr-quality-assessment" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.4 (Knowledge graph quality assessment)</strong></span> Develop a comprehensive quality assessment framework for a knowledge graph, addressing:</p>
<ol type="1">
<li><p>Define at least three metrics for each of the following dimensions:</p>
<ul>
<li>Accuracy</li>
<li>Completeness</li>
<li>Consistency</li>
<li>Timeliness</li>
</ul></li>
<li><p>For each metric:</p>
<ul>
<li>Provide a formal definition</li>
<li>Describe how it would be measured in practice</li>
<li>Identify acceptable threshold values</li>
<li>Explain how to interpret the results</li>
</ul></li>
<li><p>Design a visualization approach that would effectively communicate quality assessment results to stakeholders.</p></li>
<li><p>Propose a remediation strategy for addressing quality issues identified through your assessment.</p></li>
</ol>
</div>
<div id="exr-knowledge-completion" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.5 (Knowledge graph completion techniques)</strong></span> For a knowledge graph about movies, directors, actors, and genres:</p>
<ol type="1">
<li>Design a rule-based completion approach that would infer at least three types of missing relationships</li>
<li>Outline how a knowledge graph embedding model would help predict missing links</li>
<li>Describe an external source integration strategy to add missing information</li>
<li>Develop a hybrid approach that combines the strengths of multiple completion methods</li>
</ol>
<p>Evaluate the trade-offs of each approach in terms of precision, recall, scalability, and explainability.</p>
</div>
</section>
<section id="further-reading" class="level2" data-number="6.9">
<h2 data-number="6.9" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">6.9</span> Further reading</h2>
<ol type="1">
<li><p>Paulheim, H. (2017). Knowledge Graph Refinement: A Survey of Approaches and Evaluation Methods. Semantic Web, 8(3), 489-508.</p></li>
<li><p>Weikum, G., Dong, X. L., Razniewski, S., &amp; Suchanek, F. M. (2020). Machine Knowledge: Creation and Curation of Comprehensive Knowledge Bases. Foundations and Trends in Databases, 10(2-4), 108-490.</p></li>
<li><p>Shen, W., Wang, J., &amp; Han, J. (2015). Entity Linking with a Knowledge Base: Issues, Techniques, and Solutions. IEEE Transactions on Knowledge and Data Engineering, 27(2), 443-460.</p></li>
<li><p>Christen, P. (2012). Data Matching: Concepts and Techniques for Record Linkage, Entity Resolution, and Duplicate Detection. Springer.</p></li>
<li><p>Ji, S., Pan, S., Cambria, E., Marttinen, P., &amp; Yu, P. S. (2021). A Survey on Knowledge Graphs: Representation, Acquisition, and Applications. IEEE Transactions on Neural Networks and Learning Systems.</p></li>
<li><p>Farid, D. M., Nowe, A., &amp; Hasan, M. A. (2020). A Survey of Knowledge Graph Completion Approaches: Methods, Applications, and Challenges. Proceedings of the Future Technologies Conference, 766-793.</p></li>
<li><p>Zaveri, A., Rula, A., Maurino, A., Pietrobon, R., Lehmann, J., &amp; Auer, S. (2016). Quality Assessment for Linked Data: A Survey. Semantic Web, 7(1), 63-93.</p></li>
<li><p>Nickel, M., Murphy, K., Tresp, V., &amp; Gabrilovich, E. (2016). A Review of Relational Machine Learning for Knowledge Graphs. Proceedings of the IEEE, 104(1), 11-33.</p></li>
<li><p>Soru, T., Marx, E., Moussallem, D., Publio, G., Valdestilhas, A., Esteves, D., &amp; Neto, C. B. (2017). SPARQL as a Foreign Language. arXiv preprint arXiv:1708.07624.</p></li>
<li><p>Ilievski, F., Szekely, P., &amp; Zhang, B. (2021). Onto-Cognitive Scaffolding: Developing Methods for Placing Knowledge Graphs on a Cognitive Leash. arXiv preprint arXiv:2105.05757.</p></li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../contents/foundation/knowledge-representation.html" class="pagination-link" aria-label="Knowledge Representation and Ontologies">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Knowledge Representation and Ontologies</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../contents/construction/kg-algorithms.html" class="pagination-link" aria-label="Graph Algorithms and Traversal">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Graph Algorithms and Traversal</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><a href="https://tuedsci.github.io/">© Tue Nguyen</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>